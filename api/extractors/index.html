
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../llm_inference_engine/">
      
      
        <link rel="next" href="../chunkers/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Extractors - LLM-IE Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#extractors-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LLM-IE Documentation" class="md-header__button md-logo" aria-label="LLM-IE Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LLM-IE Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Extractors
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/daviden1013/llm-ie" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    daviden1013/llm-ie
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LLM-IE Documentation" class="md-nav__button md-logo" aria-label="LLM-IE Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LLM-IE Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/daviden1013/llm-ie" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    daviden1013/llm-ie
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quick_start/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../web_application/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Application
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../llm_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../llm_inference_engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Inference Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prompt_templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Templates
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../prompt_editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Editor
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../chunkers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chunkers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../extractors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Extractors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Visualization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm_config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../llm_inference_engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLM Inference Engine
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Extractors
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Extractors
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#frame-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Frame Extractors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      DirectFrameExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DirectFrameExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract" class="md-nav__link">
    <span class="md-ellipsis">
      extract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_async" class="md-nav__link">
    <span class="md-ellipsis">
      extract_async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_frames" class="md-nav__link">
    <span class="md-ellipsis">
      extract_frames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_frames_from_documents" class="md-nav__link">
    <span class="md-ellipsis">
      extract_frames_from_documents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      ReviewFrameExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReviewFrameExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.extract" class="md-nav__link">
    <span class="md-ellipsis">
      extract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.extract_async" class="md-nav__link">
    <span class="md-ellipsis">
      extract_async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convenience-frame-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Convenience Frame Extractors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BasicFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BasicFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.SentenceFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      SentenceFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BasicReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BasicReviewFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.SentenceReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      SentenceReviewFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relation-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Relation Extractors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BinaryRelationExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BinaryRelationExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.MultiClassRelationExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      MultiClassRelationExtractor
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../chunkers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Chunkers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../prompt_editor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Prompt Editor
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#frame-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Frame Extractors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      DirectFrameExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DirectFrameExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract" class="md-nav__link">
    <span class="md-ellipsis">
      extract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_async" class="md-nav__link">
    <span class="md-ellipsis">
      extract_async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_frames" class="md-nav__link">
    <span class="md-ellipsis">
      extract_frames
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.DirectFrameExtractor.extract_frames_from_documents" class="md-nav__link">
    <span class="md-ellipsis">
      extract_frames_from_documents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      ReviewFrameExtractor
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReviewFrameExtractor">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.extract" class="md-nav__link">
    <span class="md-ellipsis">
      extract
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.stream" class="md-nav__link">
    <span class="md-ellipsis">
      stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_ie.extractors.ReviewFrameExtractor.extract_async" class="md-nav__link">
    <span class="md-ellipsis">
      extract_async
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convenience-frame-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Convenience Frame Extractors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BasicFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BasicFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.SentenceFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      SentenceFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BasicReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BasicReviewFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.SentenceReviewFrameExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      SentenceReviewFrameExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#relation-extractors" class="md-nav__link">
    <span class="md-ellipsis">
      Relation Extractors
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.BinaryRelationExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      BinaryRelationExtractor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_ie.extractors.MultiClassRelationExtractor" class="md-nav__link">
    <span class="md-ellipsis">
      MultiClassRelationExtractor
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="extractors-api">Extractors API</h1>
<h2 id="frame-extractors">Frame Extractors</h2>


<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.DirectFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.DirectFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">DirectFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">unit_chunker</span><span class="p">:</span> <span class="n">UnitChunker</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">context_chunker</span><span class="p">:</span> <span class="n">ContextChunker</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="llm_ie.extractors.FrameExtractor">FrameExtractor</span></code></p>


        <p>This class is for general unit-context frame extraction.
Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
unit_chunker : UnitChunker
    the unit chunker object that determines how to chunk the document text into units.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
system_prompt : str, Optional
    system prompt.
context_chunker : ContextChunker
    the context chunker object that determines how to get context for each unit.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-730" name="__codelineno-0-730"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">unit_chunker</span><span class="p">:</span><span class="n">UnitChunker</span><span class="p">,</span> 
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>             <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">context_chunker</span><span class="p">:</span><span class="n">ContextChunker</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a><span class="sd">    This class is for general unit-context frame extraction.</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a><span class="sd">    Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a><span class="sd">    unit_chunker : UnitChunker</span>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a><span class="sd">        the unit chunker object that determines how to chunk the document text into units.</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">    context_chunker : ContextChunker</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a><span class="sd">        the context chunker object that determines how to get context for each unit.</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">unit_chunker</span><span class="p">,</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">context_chunker</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.DirectFrameExtractor.extract" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This method inputs a text and outputs a list of outputs per unit.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is. 
    If text_content is str, this parameter will be ignored.
verbose : bool, Optional
    if True, LLM generated text will be printed in terminal in real-time. 
return_messages_log : bool, Optional
    if True, a list of messages will be returned.</p>
<p>Return : List[FrameExtractionUnit]
    the output from LLM for each unit. Contains the start, end, text, and generated text.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-756" name="__codelineno-0-756"></a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> 
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>            <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]:</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a><span class="sd">    This method inputs a text and outputs a list of outputs per unit.</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a><span class="sd">        the input text content to put in prompt template. </span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a><span class="sd">        specify the key in text_content where document text is. </span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a><span class="sd">    verbose : bool, Optional</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a><span class="sd">        if True, LLM generated text will be printed in terminal in real-time. </span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a><span class="sd">        if True, a list of messages will be returned.</span>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="sd">    Return : List[FrameExtractionUnit]</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="sd">        the output from LLM for each unit. Contains the start, end, text, and generated text.</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a>    <span class="c1"># unit chunking</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>    <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>    <span class="c1"># context chunker init</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>    <span class="c1"># messages log</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>    <span class="n">messages_logger</span> <span class="o">=</span> <span class="n">MessagesLogger</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="c1"># generate unit by unit</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>            <span class="c1"># construct chat messages</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>            <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a>            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a>            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a>                <span class="c1"># no context, just place unit in user prompt</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a>                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a>                    <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a>                    <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>                <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>                    <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                    <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>                <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Unit </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>                <span class="k">if</span> <span class="n">context</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s2">Context:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Extraction:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>            <span class="n">gen_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>                            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>                            <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                            <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>                        <span class="p">)</span>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>            <span class="c1"># add generated text to unit</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>            <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">gen_text</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">])</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>            <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>            <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;fail&quot;</span><span class="p">)</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM inference failed for unit </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>        <span class="k">return</span> <span class="n">units</span><span class="p">,</span> <span class="n">messages_logger</span><span class="o">.</span><span class="n">get_messages_log</span><span class="p">()</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>    <span class="k">return</span> <span class="n">units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.DirectFrameExtractor.stream" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">stream</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>Streams LLM responses per unit with structured event types,
and returns collected data for post-processing.</p>


<details class="yields:" open>
  <summary>Yields:</summary>
  <p>Dict[str, Any]: (type, data)
    - {"type": "info", "data": str_message}: General informational messages.
    - {"type": "unit", "data": dict_unit_info}: Signals start of a new unit. dict_unit_info contains {'id', 'text', 'start', 'end'}
    - {"type": "context", "data": str_context}: Context string for the current unit.
    - {"type": "reasoning", "data": str_chunk}: A reasoning model thinking chunk from the LLM.
    - {"type": "response", "data": str_chunk}: A response/answer chunk from the LLM.</p>
</details>

<details class="returns:" open>
  <summary>Returns:</summary>
  <p>List[FrameExtractionUnit]:
    A list of FrameExtractionUnit objects, each containing the
    original unit details and the fully accumulated 'gen_text' from the LLM.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-852">852</a></span>
<span class="normal"><a href="#__codelineno-0-853">853</a></span>
<span class="normal"><a href="#__codelineno-0-854">854</a></span>
<span class="normal"><a href="#__codelineno-0-855">855</a></span>
<span class="normal"><a href="#__codelineno-0-856">856</a></span>
<span class="normal"><a href="#__codelineno-0-857">857</a></span>
<span class="normal"><a href="#__codelineno-0-858">858</a></span>
<span class="normal"><a href="#__codelineno-0-859">859</a></span>
<span class="normal"><a href="#__codelineno-0-860">860</a></span>
<span class="normal"><a href="#__codelineno-0-861">861</a></span>
<span class="normal"><a href="#__codelineno-0-862">862</a></span>
<span class="normal"><a href="#__codelineno-0-863">863</a></span>
<span class="normal"><a href="#__codelineno-0-864">864</a></span>
<span class="normal"><a href="#__codelineno-0-865">865</a></span>
<span class="normal"><a href="#__codelineno-0-866">866</a></span>
<span class="normal"><a href="#__codelineno-0-867">867</a></span>
<span class="normal"><a href="#__codelineno-0-868">868</a></span>
<span class="normal"><a href="#__codelineno-0-869">869</a></span>
<span class="normal"><a href="#__codelineno-0-870">870</a></span>
<span class="normal"><a href="#__codelineno-0-871">871</a></span>
<span class="normal"><a href="#__codelineno-0-872">872</a></span>
<span class="normal"><a href="#__codelineno-0-873">873</a></span>
<span class="normal"><a href="#__codelineno-0-874">874</a></span>
<span class="normal"><a href="#__codelineno-0-875">875</a></span>
<span class="normal"><a href="#__codelineno-0-876">876</a></span>
<span class="normal"><a href="#__codelineno-0-877">877</a></span>
<span class="normal"><a href="#__codelineno-0-878">878</a></span>
<span class="normal"><a href="#__codelineno-0-879">879</a></span>
<span class="normal"><a href="#__codelineno-0-880">880</a></span>
<span class="normal"><a href="#__codelineno-0-881">881</a></span>
<span class="normal"><a href="#__codelineno-0-882">882</a></span>
<span class="normal"><a href="#__codelineno-0-883">883</a></span>
<span class="normal"><a href="#__codelineno-0-884">884</a></span>
<span class="normal"><a href="#__codelineno-0-885">885</a></span>
<span class="normal"><a href="#__codelineno-0-886">886</a></span>
<span class="normal"><a href="#__codelineno-0-887">887</a></span>
<span class="normal"><a href="#__codelineno-0-888">888</a></span>
<span class="normal"><a href="#__codelineno-0-889">889</a></span>
<span class="normal"><a href="#__codelineno-0-890">890</a></span>
<span class="normal"><a href="#__codelineno-0-891">891</a></span>
<span class="normal"><a href="#__codelineno-0-892">892</a></span>
<span class="normal"><a href="#__codelineno-0-893">893</a></span>
<span class="normal"><a href="#__codelineno-0-894">894</a></span>
<span class="normal"><a href="#__codelineno-0-895">895</a></span>
<span class="normal"><a href="#__codelineno-0-896">896</a></span>
<span class="normal"><a href="#__codelineno-0-897">897</a></span>
<span class="normal"><a href="#__codelineno-0-898">898</a></span>
<span class="normal"><a href="#__codelineno-0-899">899</a></span>
<span class="normal"><a href="#__codelineno-0-900">900</a></span>
<span class="normal"><a href="#__codelineno-0-901">901</a></span>
<span class="normal"><a href="#__codelineno-0-902">902</a></span>
<span class="normal"><a href="#__codelineno-0-903">903</a></span>
<span class="normal"><a href="#__codelineno-0-904">904</a></span>
<span class="normal"><a href="#__codelineno-0-905">905</a></span>
<span class="normal"><a href="#__codelineno-0-906">906</a></span>
<span class="normal"><a href="#__codelineno-0-907">907</a></span>
<span class="normal"><a href="#__codelineno-0-908">908</a></span>
<span class="normal"><a href="#__codelineno-0-909">909</a></span>
<span class="normal"><a href="#__codelineno-0-910">910</a></span>
<span class="normal"><a href="#__codelineno-0-911">911</a></span>
<span class="normal"><a href="#__codelineno-0-912">912</a></span>
<span class="normal"><a href="#__codelineno-0-913">913</a></span>
<span class="normal"><a href="#__codelineno-0-914">914</a></span>
<span class="normal"><a href="#__codelineno-0-915">915</a></span>
<span class="normal"><a href="#__codelineno-0-916">916</a></span>
<span class="normal"><a href="#__codelineno-0-917">917</a></span>
<span class="normal"><a href="#__codelineno-0-918">918</a></span>
<span class="normal"><a href="#__codelineno-0-919">919</a></span>
<span class="normal"><a href="#__codelineno-0-920">920</a></span>
<span class="normal"><a href="#__codelineno-0-921">921</a></span>
<span class="normal"><a href="#__codelineno-0-922">922</a></span>
<span class="normal"><a href="#__codelineno-0-923">923</a></span>
<span class="normal"><a href="#__codelineno-0-924">924</a></span>
<span class="normal"><a href="#__codelineno-0-925">925</a></span>
<span class="normal"><a href="#__codelineno-0-926">926</a></span>
<span class="normal"><a href="#__codelineno-0-927">927</a></span>
<span class="normal"><a href="#__codelineno-0-928">928</a></span>
<span class="normal"><a href="#__codelineno-0-929">929</a></span>
<span class="normal"><a href="#__codelineno-0-930">930</a></span>
<span class="normal"><a href="#__codelineno-0-931">931</a></span>
<span class="normal"><a href="#__codelineno-0-932">932</a></span>
<span class="normal"><a href="#__codelineno-0-933">933</a></span>
<span class="normal"><a href="#__codelineno-0-934">934</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-852" name="__codelineno-0-852"></a><span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> 
<a id="__codelineno-0-853" name="__codelineno-0-853"></a>           <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]]:</span>
<a id="__codelineno-0-854" name="__codelineno-0-854"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-855" name="__codelineno-0-855"></a><span class="sd">    Streams LLM responses per unit with structured event types,</span>
<a id="__codelineno-0-856" name="__codelineno-0-856"></a><span class="sd">    and returns collected data for post-processing.</span>
<a id="__codelineno-0-857" name="__codelineno-0-857"></a>
<a id="__codelineno-0-858" name="__codelineno-0-858"></a><span class="sd">    Yields:</span>
<a id="__codelineno-0-859" name="__codelineno-0-859"></a><span class="sd">    -------</span>
<a id="__codelineno-0-860" name="__codelineno-0-860"></a><span class="sd">    Dict[str, Any]: (type, data)</span>
<a id="__codelineno-0-861" name="__codelineno-0-861"></a><span class="sd">        - {&quot;type&quot;: &quot;info&quot;, &quot;data&quot;: str_message}: General informational messages.</span>
<a id="__codelineno-0-862" name="__codelineno-0-862"></a><span class="sd">        - {&quot;type&quot;: &quot;unit&quot;, &quot;data&quot;: dict_unit_info}: Signals start of a new unit. dict_unit_info contains {&#39;id&#39;, &#39;text&#39;, &#39;start&#39;, &#39;end&#39;}</span>
<a id="__codelineno-0-863" name="__codelineno-0-863"></a><span class="sd">        - {&quot;type&quot;: &quot;context&quot;, &quot;data&quot;: str_context}: Context string for the current unit.</span>
<a id="__codelineno-0-864" name="__codelineno-0-864"></a><span class="sd">        - {&quot;type&quot;: &quot;reasoning&quot;, &quot;data&quot;: str_chunk}: A reasoning model thinking chunk from the LLM.</span>
<a id="__codelineno-0-865" name="__codelineno-0-865"></a><span class="sd">        - {&quot;type&quot;: &quot;response&quot;, &quot;data&quot;: str_chunk}: A response/answer chunk from the LLM.</span>
<a id="__codelineno-0-866" name="__codelineno-0-866"></a>
<a id="__codelineno-0-867" name="__codelineno-0-867"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-868" name="__codelineno-0-868"></a><span class="sd">    --------</span>
<a id="__codelineno-0-869" name="__codelineno-0-869"></a><span class="sd">    List[FrameExtractionUnit]:</span>
<a id="__codelineno-0-870" name="__codelineno-0-870"></a><span class="sd">        A list of FrameExtractionUnit objects, each containing the</span>
<a id="__codelineno-0-871" name="__codelineno-0-871"></a><span class="sd">        original unit details and the fully accumulated &#39;gen_text&#39; from the LLM.</span>
<a id="__codelineno-0-872" name="__codelineno-0-872"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-873" name="__codelineno-0-873"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-874" name="__codelineno-0-874"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-875" name="__codelineno-0-875"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-876" name="__codelineno-0-876"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-877" name="__codelineno-0-877"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-878" name="__codelineno-0-878"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_content</span><span class="p">:</span>
<a id="__codelineno-0-879" name="__codelineno-0-879"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;document_key &#39;</span><span class="si">{</span><span class="n">document_key</span><span class="si">}</span><span class="s2">&#39; not found in text_content.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-880" name="__codelineno-0-880"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-881" name="__codelineno-0-881"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-882" name="__codelineno-0-882"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;text_content must be a string or a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-883" name="__codelineno-0-883"></a>
<a id="__codelineno-0-884" name="__codelineno-0-884"></a>    <span class="n">units</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-885" name="__codelineno-0-885"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-886" name="__codelineno-0-886"></a>
<a id="__codelineno-0-887" name="__codelineno-0-887"></a>    <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Starting LLM processing for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="si">}</span><span class="s2"> units.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-888" name="__codelineno-0-888"></a>
<a id="__codelineno-0-889" name="__codelineno-0-889"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-890" name="__codelineno-0-890"></a>        <span class="n">unit_info_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">end</span><span class="p">}</span>
<a id="__codelineno-0-891" name="__codelineno-0-891"></a>        <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">unit_info_payload</span><span class="p">}</span>
<a id="__codelineno-0-892" name="__codelineno-0-892"></a>
<a id="__codelineno-0-893" name="__codelineno-0-893"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-894" name="__codelineno-0-894"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-895" name="__codelineno-0-895"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-896" name="__codelineno-0-896"></a>
<a id="__codelineno-0-897" name="__codelineno-0-897"></a>        <span class="n">context_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-898" name="__codelineno-0-898"></a>
<a id="__codelineno-0-899" name="__codelineno-0-899"></a>        <span class="c1"># Construct prompt input based on whether text_content was str or dict</span>
<a id="__codelineno-0-900" name="__codelineno-0-900"></a>        <span class="k">if</span> <span class="n">context_str</span><span class="p">:</span>
<a id="__codelineno-0-901" name="__codelineno-0-901"></a>            <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">context_str</span><span class="p">}</span>
<a id="__codelineno-0-902" name="__codelineno-0-902"></a>            <span class="n">prompt_input_for_context</span> <span class="o">=</span> <span class="n">context_str</span>
<a id="__codelineno-0-903" name="__codelineno-0-903"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-904" name="__codelineno-0-904"></a>                <span class="n">context_content_dict</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-905" name="__codelineno-0-905"></a>                <span class="n">context_content_dict</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context_str</span>
<a id="__codelineno-0-906" name="__codelineno-0-906"></a>                <span class="n">prompt_input_for_context</span> <span class="o">=</span> <span class="n">context_content_dict</span>
<a id="__codelineno-0-907" name="__codelineno-0-907"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">prompt_input_for_context</span><span class="p">)})</span>
<a id="__codelineno-0-908" name="__codelineno-0-908"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-909" name="__codelineno-0-909"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-910" name="__codelineno-0-910"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># No context</span>
<a id="__codelineno-0-911" name="__codelineno-0-911"></a>            <span class="n">prompt_input_for_unit</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-912" name="__codelineno-0-912"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-913" name="__codelineno-0-913"></a>                <span class="n">unit_content_dict</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-914" name="__codelineno-0-914"></a>                <span class="n">unit_content_dict</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-915" name="__codelineno-0-915"></a>                <span class="n">prompt_input_for_unit</span> <span class="o">=</span> <span class="n">unit_content_dict</span>
<a id="__codelineno-0-916" name="__codelineno-0-916"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">prompt_input_for_unit</span><span class="p">)})</span>
<a id="__codelineno-0-917" name="__codelineno-0-917"></a>
<a id="__codelineno-0-918" name="__codelineno-0-918"></a>        <span class="n">current_gen_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-919" name="__codelineno-0-919"></a>
<a id="__codelineno-0-920" name="__codelineno-0-920"></a>        <span class="n">response_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-921" name="__codelineno-0-921"></a>            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
<a id="__codelineno-0-922" name="__codelineno-0-922"></a>            <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-923" name="__codelineno-0-923"></a>        <span class="p">)</span>
<a id="__codelineno-0-924" name="__codelineno-0-924"></a>        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response_stream</span><span class="p">:</span>
<a id="__codelineno-0-925" name="__codelineno-0-925"></a>            <span class="k">yield</span> <span class="n">chunk</span>
<a id="__codelineno-0-926" name="__codelineno-0-926"></a>            <span class="k">if</span> <span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span>
<a id="__codelineno-0-927" name="__codelineno-0-927"></a>                <span class="n">current_gen_text</span> <span class="o">+=</span> <span class="n">chunk</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
<a id="__codelineno-0-928" name="__codelineno-0-928"></a>
<a id="__codelineno-0-929" name="__codelineno-0-929"></a>        <span class="c1"># Store the result for this unit</span>
<a id="__codelineno-0-930" name="__codelineno-0-930"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">current_gen_text</span><span class="p">)</span>
<a id="__codelineno-0-931" name="__codelineno-0-931"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-932" name="__codelineno-0-932"></a>
<a id="__codelineno-0-933" name="__codelineno-0-933"></a>    <span class="k">yield</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;All units processed by LLM.&quot;</span><span class="p">}</span>
<a id="__codelineno-0-934" name="__codelineno-0-934"></a>    <span class="k">return</span> <span class="n">units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.DirectFrameExtractor.extract_async" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract_async</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract_async</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">concurrent_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This is the asynchronous version of the extract() method.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is. 
    If text_content is str, this parameter will be ignored.
concurrent_batch_size : int, Optional
    the batch size for concurrent processing. 
return_messages_log : bool, Optional
    if True, a list of messages will be returned.</p>
<p>Return : List[FrameExtractionUnit]
    the output from LLM for each unit. Contains the start, end, text, and generated text.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-936"> 936</a></span>
<span class="normal"><a href="#__codelineno-0-937"> 937</a></span>
<span class="normal"><a href="#__codelineno-0-938"> 938</a></span>
<span class="normal"><a href="#__codelineno-0-939"> 939</a></span>
<span class="normal"><a href="#__codelineno-0-940"> 940</a></span>
<span class="normal"><a href="#__codelineno-0-941"> 941</a></span>
<span class="normal"><a href="#__codelineno-0-942"> 942</a></span>
<span class="normal"><a href="#__codelineno-0-943"> 943</a></span>
<span class="normal"><a href="#__codelineno-0-944"> 944</a></span>
<span class="normal"><a href="#__codelineno-0-945"> 945</a></span>
<span class="normal"><a href="#__codelineno-0-946"> 946</a></span>
<span class="normal"><a href="#__codelineno-0-947"> 947</a></span>
<span class="normal"><a href="#__codelineno-0-948"> 948</a></span>
<span class="normal"><a href="#__codelineno-0-949"> 949</a></span>
<span class="normal"><a href="#__codelineno-0-950"> 950</a></span>
<span class="normal"><a href="#__codelineno-0-951"> 951</a></span>
<span class="normal"><a href="#__codelineno-0-952"> 952</a></span>
<span class="normal"><a href="#__codelineno-0-953"> 953</a></span>
<span class="normal"><a href="#__codelineno-0-954"> 954</a></span>
<span class="normal"><a href="#__codelineno-0-955"> 955</a></span>
<span class="normal"><a href="#__codelineno-0-956"> 956</a></span>
<span class="normal"><a href="#__codelineno-0-957"> 957</a></span>
<span class="normal"><a href="#__codelineno-0-958"> 958</a></span>
<span class="normal"><a href="#__codelineno-0-959"> 959</a></span>
<span class="normal"><a href="#__codelineno-0-960"> 960</a></span>
<span class="normal"><a href="#__codelineno-0-961"> 961</a></span>
<span class="normal"><a href="#__codelineno-0-962"> 962</a></span>
<span class="normal"><a href="#__codelineno-0-963"> 963</a></span>
<span class="normal"><a href="#__codelineno-0-964"> 964</a></span>
<span class="normal"><a href="#__codelineno-0-965"> 965</a></span>
<span class="normal"><a href="#__codelineno-0-966"> 966</a></span>
<span class="normal"><a href="#__codelineno-0-967"> 967</a></span>
<span class="normal"><a href="#__codelineno-0-968"> 968</a></span>
<span class="normal"><a href="#__codelineno-0-969"> 969</a></span>
<span class="normal"><a href="#__codelineno-0-970"> 970</a></span>
<span class="normal"><a href="#__codelineno-0-971"> 971</a></span>
<span class="normal"><a href="#__codelineno-0-972"> 972</a></span>
<span class="normal"><a href="#__codelineno-0-973"> 973</a></span>
<span class="normal"><a href="#__codelineno-0-974"> 974</a></span>
<span class="normal"><a href="#__codelineno-0-975"> 975</a></span>
<span class="normal"><a href="#__codelineno-0-976"> 976</a></span>
<span class="normal"><a href="#__codelineno-0-977"> 977</a></span>
<span class="normal"><a href="#__codelineno-0-978"> 978</a></span>
<span class="normal"><a href="#__codelineno-0-979"> 979</a></span>
<span class="normal"><a href="#__codelineno-0-980"> 980</a></span>
<span class="normal"><a href="#__codelineno-0-981"> 981</a></span>
<span class="normal"><a href="#__codelineno-0-982"> 982</a></span>
<span class="normal"><a href="#__codelineno-0-983"> 983</a></span>
<span class="normal"><a href="#__codelineno-0-984"> 984</a></span>
<span class="normal"><a href="#__codelineno-0-985"> 985</a></span>
<span class="normal"><a href="#__codelineno-0-986"> 986</a></span>
<span class="normal"><a href="#__codelineno-0-987"> 987</a></span>
<span class="normal"><a href="#__codelineno-0-988"> 988</a></span>
<span class="normal"><a href="#__codelineno-0-989"> 989</a></span>
<span class="normal"><a href="#__codelineno-0-990"> 990</a></span>
<span class="normal"><a href="#__codelineno-0-991"> 991</a></span>
<span class="normal"><a href="#__codelineno-0-992"> 992</a></span>
<span class="normal"><a href="#__codelineno-0-993"> 993</a></span>
<span class="normal"><a href="#__codelineno-0-994"> 994</a></span>
<span class="normal"><a href="#__codelineno-0-995"> 995</a></span>
<span class="normal"><a href="#__codelineno-0-996"> 996</a></span>
<span class="normal"><a href="#__codelineno-0-997"> 997</a></span>
<span class="normal"><a href="#__codelineno-0-998"> 998</a></span>
<span class="normal"><a href="#__codelineno-0-999"> 999</a></span>
<span class="normal"><a href="#__codelineno-0-1000">1000</a></span>
<span class="normal"><a href="#__codelineno-0-1001">1001</a></span>
<span class="normal"><a href="#__codelineno-0-1002">1002</a></span>
<span class="normal"><a href="#__codelineno-0-1003">1003</a></span>
<span class="normal"><a href="#__codelineno-0-1004">1004</a></span>
<span class="normal"><a href="#__codelineno-0-1005">1005</a></span>
<span class="normal"><a href="#__codelineno-0-1006">1006</a></span>
<span class="normal"><a href="#__codelineno-0-1007">1007</a></span>
<span class="normal"><a href="#__codelineno-0-1008">1008</a></span>
<span class="normal"><a href="#__codelineno-0-1009">1009</a></span>
<span class="normal"><a href="#__codelineno-0-1010">1010</a></span>
<span class="normal"><a href="#__codelineno-0-1011">1011</a></span>
<span class="normal"><a href="#__codelineno-0-1012">1012</a></span>
<span class="normal"><a href="#__codelineno-0-1013">1013</a></span>
<span class="normal"><a href="#__codelineno-0-1014">1014</a></span>
<span class="normal"><a href="#__codelineno-0-1015">1015</a></span>
<span class="normal"><a href="#__codelineno-0-1016">1016</a></span>
<span class="normal"><a href="#__codelineno-0-1017">1017</a></span>
<span class="normal"><a href="#__codelineno-0-1018">1018</a></span>
<span class="normal"><a href="#__codelineno-0-1019">1019</a></span>
<span class="normal"><a href="#__codelineno-0-1020">1020</a></span>
<span class="normal"><a href="#__codelineno-0-1021">1021</a></span>
<span class="normal"><a href="#__codelineno-0-1022">1022</a></span>
<span class="normal"><a href="#__codelineno-0-1023">1023</a></span>
<span class="normal"><a href="#__codelineno-0-1024">1024</a></span>
<span class="normal"><a href="#__codelineno-0-1025">1025</a></span>
<span class="normal"><a href="#__codelineno-0-1026">1026</a></span>
<span class="normal"><a href="#__codelineno-0-1027">1027</a></span>
<span class="normal"><a href="#__codelineno-0-1028">1028</a></span>
<span class="normal"><a href="#__codelineno-0-1029">1029</a></span>
<span class="normal"><a href="#__codelineno-0-1030">1030</a></span>
<span class="normal"><a href="#__codelineno-0-1031">1031</a></span>
<span class="normal"><a href="#__codelineno-0-1032">1032</a></span>
<span class="normal"><a href="#__codelineno-0-1033">1033</a></span>
<span class="normal"><a href="#__codelineno-0-1034">1034</a></span>
<span class="normal"><a href="#__codelineno-0-1035">1035</a></span>
<span class="normal"><a href="#__codelineno-0-1036">1036</a></span>
<span class="normal"><a href="#__codelineno-0-1037">1037</a></span>
<span class="normal"><a href="#__codelineno-0-1038">1038</a></span>
<span class="normal"><a href="#__codelineno-0-1039">1039</a></span>
<span class="normal"><a href="#__codelineno-0-1040">1040</a></span>
<span class="normal"><a href="#__codelineno-0-1041">1041</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-936" name="__codelineno-0-936"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">extract_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-0-937" name="__codelineno-0-937"></a>                        <span class="n">concurrent_batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]:</span>
<a id="__codelineno-0-938" name="__codelineno-0-938"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-939" name="__codelineno-0-939"></a><span class="sd">    This is the asynchronous version of the extract() method.</span>
<a id="__codelineno-0-940" name="__codelineno-0-940"></a>
<a id="__codelineno-0-941" name="__codelineno-0-941"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-942" name="__codelineno-0-942"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-943" name="__codelineno-0-943"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-944" name="__codelineno-0-944"></a><span class="sd">        the input text content to put in prompt template. </span>
<a id="__codelineno-0-945" name="__codelineno-0-945"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-946" name="__codelineno-0-946"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-947" name="__codelineno-0-947"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-948" name="__codelineno-0-948"></a><span class="sd">        specify the key in text_content where document text is. </span>
<a id="__codelineno-0-949" name="__codelineno-0-949"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-950" name="__codelineno-0-950"></a><span class="sd">    concurrent_batch_size : int, Optional</span>
<a id="__codelineno-0-951" name="__codelineno-0-951"></a><span class="sd">        the batch size for concurrent processing. </span>
<a id="__codelineno-0-952" name="__codelineno-0-952"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-953" name="__codelineno-0-953"></a><span class="sd">        if True, a list of messages will be returned.</span>
<a id="__codelineno-0-954" name="__codelineno-0-954"></a>
<a id="__codelineno-0-955" name="__codelineno-0-955"></a><span class="sd">    Return : List[FrameExtractionUnit]</span>
<a id="__codelineno-0-956" name="__codelineno-0-956"></a><span class="sd">        the output from LLM for each unit. Contains the start, end, text, and generated text.</span>
<a id="__codelineno-0-957" name="__codelineno-0-957"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-958" name="__codelineno-0-958"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-959" name="__codelineno-0-959"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-960" name="__codelineno-0-960"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-961" name="__codelineno-0-961"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-962" name="__codelineno-0-962"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-963" name="__codelineno-0-963"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_content</span><span class="p">:</span>
<a id="__codelineno-0-964" name="__codelineno-0-964"></a>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;document_key &#39;</span><span class="si">{</span><span class="n">document_key</span><span class="si">}</span><span class="s2">&#39; not found in text_content dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-965" name="__codelineno-0-965"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-966" name="__codelineno-0-966"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-967" name="__codelineno-0-967"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;text_content must be a string or a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-968" name="__codelineno-0-968"></a>
<a id="__codelineno-0-969" name="__codelineno-0-969"></a>    <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-970" name="__codelineno-0-970"></a>
<a id="__codelineno-0-971" name="__codelineno-0-971"></a>    <span class="c1"># context chunker init </span>
<a id="__codelineno-0-972" name="__codelineno-0-972"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-973" name="__codelineno-0-973"></a>
<a id="__codelineno-0-974" name="__codelineno-0-974"></a>    <span class="c1"># messages logger init</span>
<a id="__codelineno-0-975" name="__codelineno-0-975"></a>    <span class="n">messages_logger</span> <span class="o">=</span> <span class="n">MessagesLogger</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-976" name="__codelineno-0-976"></a>
<a id="__codelineno-0-977" name="__codelineno-0-977"></a>    <span class="c1"># Prepare inputs for all units first</span>
<a id="__codelineno-0-978" name="__codelineno-0-978"></a>    <span class="n">tasks_input</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-979" name="__codelineno-0-979"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-980" name="__codelineno-0-980"></a>        <span class="c1"># construct chat messages</span>
<a id="__codelineno-0-981" name="__codelineno-0-981"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-982" name="__codelineno-0-982"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-983" name="__codelineno-0-983"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-984" name="__codelineno-0-984"></a>
<a id="__codelineno-0-985" name="__codelineno-0-985"></a>        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-986" name="__codelineno-0-986"></a>
<a id="__codelineno-0-987" name="__codelineno-0-987"></a>        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-988" name="__codelineno-0-988"></a>             <span class="c1"># no context, just place unit in user prompt</span>
<a id="__codelineno-0-989" name="__codelineno-0-989"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-990" name="__codelineno-0-990"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-991" name="__codelineno-0-991"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-992" name="__codelineno-0-992"></a>                <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-993" name="__codelineno-0-993"></a>                <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-994" name="__codelineno-0-994"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-995" name="__codelineno-0-995"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-996" name="__codelineno-0-996"></a>            <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-997" name="__codelineno-0-997"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-998" name="__codelineno-0-998"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-999" name="__codelineno-0-999"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1000" name="__codelineno-0-1000"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1001" name="__codelineno-0-1001"></a>                <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-1002" name="__codelineno-0-1002"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-1003" name="__codelineno-0-1003"></a>            <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-1004" name="__codelineno-0-1004"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-1005" name="__codelineno-0-1005"></a>            <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-1006" name="__codelineno-0-1006"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-1007" name="__codelineno-0-1007"></a>
<a id="__codelineno-0-1008" name="__codelineno-0-1008"></a>        <span class="c1"># Store unit and messages together for the task</span>
<a id="__codelineno-0-1009" name="__codelineno-0-1009"></a>        <span class="n">tasks_input</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="s2">&quot;original_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
<a id="__codelineno-0-1010" name="__codelineno-0-1010"></a>
<a id="__codelineno-0-1011" name="__codelineno-0-1011"></a>    <span class="c1"># Process units concurrently with asyncio.Semaphore</span>
<a id="__codelineno-0-1012" name="__codelineno-0-1012"></a>    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">concurrent_batch_size</span><span class="p">)</span>
<a id="__codelineno-0-1013" name="__codelineno-0-1013"></a>
<a id="__codelineno-0-1014" name="__codelineno-0-1014"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">semaphore_helper</span><span class="p">(</span><span class="n">task_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwrs</span><span class="p">):</span>
<a id="__codelineno-0-1015" name="__codelineno-0-1015"></a>        <span class="n">unit</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1016" name="__codelineno-0-1016"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1017" name="__codelineno-0-1017"></a>
<a id="__codelineno-0-1018" name="__codelineno-0-1018"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
<a id="__codelineno-0-1019" name="__codelineno-0-1019"></a>            <span class="n">gen_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat_async</span><span class="p">(</span>
<a id="__codelineno-0-1020" name="__codelineno-0-1020"></a>                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
<a id="__codelineno-0-1021" name="__codelineno-0-1021"></a>                <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1022" name="__codelineno-0-1022"></a>            <span class="p">)</span>
<a id="__codelineno-0-1023" name="__codelineno-0-1023"></a>
<a id="__codelineno-0-1024" name="__codelineno-0-1024"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">gen_text</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1025" name="__codelineno-0-1025"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1026" name="__codelineno-0-1026"></a>
<a id="__codelineno-0-1027" name="__codelineno-0-1027"></a>    <span class="c1"># Create and gather tasks</span>
<a id="__codelineno-0-1028" name="__codelineno-0-1028"></a>    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1029" name="__codelineno-0-1029"></a>    <span class="k">for</span> <span class="n">task_inp</span> <span class="ow">in</span> <span class="n">tasks_input</span><span class="p">:</span>
<a id="__codelineno-0-1030" name="__codelineno-0-1030"></a>        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">semaphore_helper</span><span class="p">(</span>
<a id="__codelineno-0-1031" name="__codelineno-0-1031"></a>            <span class="n">task_inp</span>
<a id="__codelineno-0-1032" name="__codelineno-0-1032"></a>        <span class="p">))</span>
<a id="__codelineno-0-1033" name="__codelineno-0-1033"></a>        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-1034" name="__codelineno-0-1034"></a>
<a id="__codelineno-0-1035" name="__codelineno-0-1035"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
<a id="__codelineno-0-1036" name="__codelineno-0-1036"></a>
<a id="__codelineno-0-1037" name="__codelineno-0-1037"></a>    <span class="c1"># Return units</span>
<a id="__codelineno-0-1038" name="__codelineno-0-1038"></a>    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-1039" name="__codelineno-0-1039"></a>        <span class="k">return</span> <span class="n">units</span><span class="p">,</span> <span class="n">messages_logger</span><span class="o">.</span><span class="n">get_messages_log</span><span class="p">()</span>
<a id="__codelineno-0-1040" name="__codelineno-0-1040"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1041" name="__codelineno-0-1041"></a>        <span class="k">return</span> <span class="n">units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.DirectFrameExtractor.extract_frames" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract_frames</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract_frames</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">concurrent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">concurrent_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">fuzzy_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">fuzzy_buffer_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">fuzzy_score_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">allow_overlap_entities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LLMInformationExtractionFrame</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This method inputs a document text and outputs a list of LLMInformationExtractionFrame
It use the extract() method and post-process outputs into frames.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is. 
    If text_content is str, this parameter will be ignored.
verbose : bool, Optional
    if True, LLM generated text will be printed in terminal in real-time. 
concurrent : bool, Optional
    if True, the sentences will be extracted in concurrent.
concurrent_batch_size : int, Optional
    the number of sentences to process in concurrent. Only used when <code>concurrent</code> is True.
case_sensitive : bool, Optional
    if True, entity text matching will be case-sensitive.
fuzzy_match : bool, Optional
    if True, fuzzy matching will be applied to find entity text.
fuzzy_buffer_size : float, Optional
    the buffer size for fuzzy matching. Default is 20% of entity text length.
fuzzy_score_cutoff : float, Optional
    the Jaccard score cutoff for fuzzy matching. 
    Matched entity text must have a score higher than this value or a None will be returned.
allow_overlap_entities : bool, Optional
    if True, entities can overlap in the text. 
    Note that this can cause multiple frames to be generated on the same entity span if they have same entity text.
return_messages_log : bool, Optional
    if True, a list of messages will be returned.</p>
<p>Return : List[LLMInformationExtractionFrame]
    a list of frames.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1044">1044</a></span>
<span class="normal"><a href="#__codelineno-0-1045">1045</a></span>
<span class="normal"><a href="#__codelineno-0-1046">1046</a></span>
<span class="normal"><a href="#__codelineno-0-1047">1047</a></span>
<span class="normal"><a href="#__codelineno-0-1048">1048</a></span>
<span class="normal"><a href="#__codelineno-0-1049">1049</a></span>
<span class="normal"><a href="#__codelineno-0-1050">1050</a></span>
<span class="normal"><a href="#__codelineno-0-1051">1051</a></span>
<span class="normal"><a href="#__codelineno-0-1052">1052</a></span>
<span class="normal"><a href="#__codelineno-0-1053">1053</a></span>
<span class="normal"><a href="#__codelineno-0-1054">1054</a></span>
<span class="normal"><a href="#__codelineno-0-1055">1055</a></span>
<span class="normal"><a href="#__codelineno-0-1056">1056</a></span>
<span class="normal"><a href="#__codelineno-0-1057">1057</a></span>
<span class="normal"><a href="#__codelineno-0-1058">1058</a></span>
<span class="normal"><a href="#__codelineno-0-1059">1059</a></span>
<span class="normal"><a href="#__codelineno-0-1060">1060</a></span>
<span class="normal"><a href="#__codelineno-0-1061">1061</a></span>
<span class="normal"><a href="#__codelineno-0-1062">1062</a></span>
<span class="normal"><a href="#__codelineno-0-1063">1063</a></span>
<span class="normal"><a href="#__codelineno-0-1064">1064</a></span>
<span class="normal"><a href="#__codelineno-0-1065">1065</a></span>
<span class="normal"><a href="#__codelineno-0-1066">1066</a></span>
<span class="normal"><a href="#__codelineno-0-1067">1067</a></span>
<span class="normal"><a href="#__codelineno-0-1068">1068</a></span>
<span class="normal"><a href="#__codelineno-0-1069">1069</a></span>
<span class="normal"><a href="#__codelineno-0-1070">1070</a></span>
<span class="normal"><a href="#__codelineno-0-1071">1071</a></span>
<span class="normal"><a href="#__codelineno-0-1072">1072</a></span>
<span class="normal"><a href="#__codelineno-0-1073">1073</a></span>
<span class="normal"><a href="#__codelineno-0-1074">1074</a></span>
<span class="normal"><a href="#__codelineno-0-1075">1075</a></span>
<span class="normal"><a href="#__codelineno-0-1076">1076</a></span>
<span class="normal"><a href="#__codelineno-0-1077">1077</a></span>
<span class="normal"><a href="#__codelineno-0-1078">1078</a></span>
<span class="normal"><a href="#__codelineno-0-1079">1079</a></span>
<span class="normal"><a href="#__codelineno-0-1080">1080</a></span>
<span class="normal"><a href="#__codelineno-0-1081">1081</a></span>
<span class="normal"><a href="#__codelineno-0-1082">1082</a></span>
<span class="normal"><a href="#__codelineno-0-1083">1083</a></span>
<span class="normal"><a href="#__codelineno-0-1084">1084</a></span>
<span class="normal"><a href="#__codelineno-0-1085">1085</a></span>
<span class="normal"><a href="#__codelineno-0-1086">1086</a></span>
<span class="normal"><a href="#__codelineno-0-1087">1087</a></span>
<span class="normal"><a href="#__codelineno-0-1088">1088</a></span>
<span class="normal"><a href="#__codelineno-0-1089">1089</a></span>
<span class="normal"><a href="#__codelineno-0-1090">1090</a></span>
<span class="normal"><a href="#__codelineno-0-1091">1091</a></span>
<span class="normal"><a href="#__codelineno-0-1092">1092</a></span>
<span class="normal"><a href="#__codelineno-0-1093">1093</a></span>
<span class="normal"><a href="#__codelineno-0-1094">1094</a></span>
<span class="normal"><a href="#__codelineno-0-1095">1095</a></span>
<span class="normal"><a href="#__codelineno-0-1096">1096</a></span>
<span class="normal"><a href="#__codelineno-0-1097">1097</a></span>
<span class="normal"><a href="#__codelineno-0-1098">1098</a></span>
<span class="normal"><a href="#__codelineno-0-1099">1099</a></span>
<span class="normal"><a href="#__codelineno-0-1100">1100</a></span>
<span class="normal"><a href="#__codelineno-0-1101">1101</a></span>
<span class="normal"><a href="#__codelineno-0-1102">1102</a></span>
<span class="normal"><a href="#__codelineno-0-1103">1103</a></span>
<span class="normal"><a href="#__codelineno-0-1104">1104</a></span>
<span class="normal"><a href="#__codelineno-0-1105">1105</a></span>
<span class="normal"><a href="#__codelineno-0-1106">1106</a></span>
<span class="normal"><a href="#__codelineno-0-1107">1107</a></span>
<span class="normal"><a href="#__codelineno-0-1108">1108</a></span>
<span class="normal"><a href="#__codelineno-0-1109">1109</a></span>
<span class="normal"><a href="#__codelineno-0-1110">1110</a></span>
<span class="normal"><a href="#__codelineno-0-1111">1111</a></span>
<span class="normal"><a href="#__codelineno-0-1112">1112</a></span>
<span class="normal"><a href="#__codelineno-0-1113">1113</a></span>
<span class="normal"><a href="#__codelineno-0-1114">1114</a></span>
<span class="normal"><a href="#__codelineno-0-1115">1115</a></span>
<span class="normal"><a href="#__codelineno-0-1116">1116</a></span>
<span class="normal"><a href="#__codelineno-0-1117">1117</a></span>
<span class="normal"><a href="#__codelineno-0-1118">1118</a></span>
<span class="normal"><a href="#__codelineno-0-1119">1119</a></span>
<span class="normal"><a href="#__codelineno-0-1120">1120</a></span>
<span class="normal"><a href="#__codelineno-0-1121">1121</a></span>
<span class="normal"><a href="#__codelineno-0-1122">1122</a></span>
<span class="normal"><a href="#__codelineno-0-1123">1123</a></span>
<span class="normal"><a href="#__codelineno-0-1124">1124</a></span>
<span class="normal"><a href="#__codelineno-0-1125">1125</a></span>
<span class="normal"><a href="#__codelineno-0-1126">1126</a></span>
<span class="normal"><a href="#__codelineno-0-1127">1127</a></span>
<span class="normal"><a href="#__codelineno-0-1128">1128</a></span>
<span class="normal"><a href="#__codelineno-0-1129">1129</a></span>
<span class="normal"><a href="#__codelineno-0-1130">1130</a></span>
<span class="normal"><a href="#__codelineno-0-1131">1131</a></span>
<span class="normal"><a href="#__codelineno-0-1132">1132</a></span>
<span class="normal"><a href="#__codelineno-0-1133">1133</a></span>
<span class="normal"><a href="#__codelineno-0-1134">1134</a></span>
<span class="normal"><a href="#__codelineno-0-1135">1135</a></span>
<span class="normal"><a href="#__codelineno-0-1136">1136</a></span>
<span class="normal"><a href="#__codelineno-0-1137">1137</a></span>
<span class="normal"><a href="#__codelineno-0-1138">1138</a></span>
<span class="normal"><a href="#__codelineno-0-1139">1139</a></span>
<span class="normal"><a href="#__codelineno-0-1140">1140</a></span>
<span class="normal"><a href="#__codelineno-0-1141">1141</a></span>
<span class="normal"><a href="#__codelineno-0-1142">1142</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1044" name="__codelineno-0-1044"></a><span class="k">def</span> <span class="nf">extract_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-0-1045" name="__codelineno-0-1045"></a>                   <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">concurrent</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">concurrent_batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-1046" name="__codelineno-0-1046"></a>                    <span class="n">case_sensitive</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fuzzy_match</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fuzzy_buffer_size</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fuzzy_score_cutoff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<a id="__codelineno-0-1047" name="__codelineno-0-1047"></a>                    <span class="n">allow_overlap_entities</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LLMInformationExtractionFrame</span><span class="p">]:</span>
<a id="__codelineno-0-1048" name="__codelineno-0-1048"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1049" name="__codelineno-0-1049"></a><span class="sd">    This method inputs a document text and outputs a list of LLMInformationExtractionFrame</span>
<a id="__codelineno-0-1050" name="__codelineno-0-1050"></a><span class="sd">    It use the extract() method and post-process outputs into frames.</span>
<a id="__codelineno-0-1051" name="__codelineno-0-1051"></a>
<a id="__codelineno-0-1052" name="__codelineno-0-1052"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1053" name="__codelineno-0-1053"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1054" name="__codelineno-0-1054"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-1055" name="__codelineno-0-1055"></a><span class="sd">        the input text content to put in prompt template. </span>
<a id="__codelineno-0-1056" name="__codelineno-0-1056"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-1057" name="__codelineno-0-1057"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-1058" name="__codelineno-0-1058"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-1059" name="__codelineno-0-1059"></a><span class="sd">        specify the key in text_content where document text is. </span>
<a id="__codelineno-0-1060" name="__codelineno-0-1060"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-1061" name="__codelineno-0-1061"></a><span class="sd">    verbose : bool, Optional</span>
<a id="__codelineno-0-1062" name="__codelineno-0-1062"></a><span class="sd">        if True, LLM generated text will be printed in terminal in real-time. </span>
<a id="__codelineno-0-1063" name="__codelineno-0-1063"></a><span class="sd">    concurrent : bool, Optional</span>
<a id="__codelineno-0-1064" name="__codelineno-0-1064"></a><span class="sd">        if True, the sentences will be extracted in concurrent.</span>
<a id="__codelineno-0-1065" name="__codelineno-0-1065"></a><span class="sd">    concurrent_batch_size : int, Optional</span>
<a id="__codelineno-0-1066" name="__codelineno-0-1066"></a><span class="sd">        the number of sentences to process in concurrent. Only used when `concurrent` is True.</span>
<a id="__codelineno-0-1067" name="__codelineno-0-1067"></a><span class="sd">    case_sensitive : bool, Optional</span>
<a id="__codelineno-0-1068" name="__codelineno-0-1068"></a><span class="sd">        if True, entity text matching will be case-sensitive.</span>
<a id="__codelineno-0-1069" name="__codelineno-0-1069"></a><span class="sd">    fuzzy_match : bool, Optional</span>
<a id="__codelineno-0-1070" name="__codelineno-0-1070"></a><span class="sd">        if True, fuzzy matching will be applied to find entity text.</span>
<a id="__codelineno-0-1071" name="__codelineno-0-1071"></a><span class="sd">    fuzzy_buffer_size : float, Optional</span>
<a id="__codelineno-0-1072" name="__codelineno-0-1072"></a><span class="sd">        the buffer size for fuzzy matching. Default is 20% of entity text length.</span>
<a id="__codelineno-0-1073" name="__codelineno-0-1073"></a><span class="sd">    fuzzy_score_cutoff : float, Optional</span>
<a id="__codelineno-0-1074" name="__codelineno-0-1074"></a><span class="sd">        the Jaccard score cutoff for fuzzy matching. </span>
<a id="__codelineno-0-1075" name="__codelineno-0-1075"></a><span class="sd">        Matched entity text must have a score higher than this value or a None will be returned.</span>
<a id="__codelineno-0-1076" name="__codelineno-0-1076"></a><span class="sd">    allow_overlap_entities : bool, Optional</span>
<a id="__codelineno-0-1077" name="__codelineno-0-1077"></a><span class="sd">        if True, entities can overlap in the text. </span>
<a id="__codelineno-0-1078" name="__codelineno-0-1078"></a><span class="sd">        Note that this can cause multiple frames to be generated on the same entity span if they have same entity text.</span>
<a id="__codelineno-0-1079" name="__codelineno-0-1079"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-1080" name="__codelineno-0-1080"></a><span class="sd">        if True, a list of messages will be returned.</span>
<a id="__codelineno-0-1081" name="__codelineno-0-1081"></a>
<a id="__codelineno-0-1082" name="__codelineno-0-1082"></a><span class="sd">    Return : List[LLMInformationExtractionFrame]</span>
<a id="__codelineno-0-1083" name="__codelineno-0-1083"></a><span class="sd">        a list of frames.</span>
<a id="__codelineno-0-1084" name="__codelineno-0-1084"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1085" name="__codelineno-0-1085"></a>    <span class="n">ENTITY_KEY</span> <span class="o">=</span> <span class="s2">&quot;entity_text&quot;</span>
<a id="__codelineno-0-1086" name="__codelineno-0-1086"></a>    <span class="k">if</span> <span class="n">concurrent</span><span class="p">:</span>
<a id="__codelineno-0-1087" name="__codelineno-0-1087"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1088" name="__codelineno-0-1088"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;verbose=True is not supported in concurrent mode.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
<a id="__codelineno-0-1089" name="__codelineno-0-1089"></a>
<a id="__codelineno-0-1090" name="__codelineno-0-1090"></a>        <span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span> <span class="c1"># For Jupyter notebook. Terminal does not need this.</span>
<a id="__codelineno-0-1091" name="__codelineno-0-1091"></a>        <span class="n">extraction_results</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extract_async</span><span class="p">(</span><span class="n">text_content</span><span class="o">=</span><span class="n">text_content</span><span class="p">,</span> 
<a id="__codelineno-0-1092" name="__codelineno-0-1092"></a>                                            <span class="n">document_key</span><span class="o">=</span><span class="n">document_key</span><span class="p">,</span>
<a id="__codelineno-0-1093" name="__codelineno-0-1093"></a>                                            <span class="n">concurrent_batch_size</span><span class="o">=</span><span class="n">concurrent_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-1094" name="__codelineno-0-1094"></a>                                            <span class="n">return_messages_log</span><span class="o">=</span><span class="n">return_messages_log</span><span class="p">)</span>
<a id="__codelineno-0-1095" name="__codelineno-0-1095"></a>                                        <span class="p">)</span>
<a id="__codelineno-0-1096" name="__codelineno-0-1096"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1097" name="__codelineno-0-1097"></a>        <span class="n">extraction_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">text_content</span><span class="o">=</span><span class="n">text_content</span><span class="p">,</span> 
<a id="__codelineno-0-1098" name="__codelineno-0-1098"></a>                                            <span class="n">document_key</span><span class="o">=</span><span class="n">document_key</span><span class="p">,</span>
<a id="__codelineno-0-1099" name="__codelineno-0-1099"></a>                                            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
<a id="__codelineno-0-1100" name="__codelineno-0-1100"></a>                                            <span class="n">return_messages_log</span><span class="o">=</span><span class="n">return_messages_log</span><span class="p">)</span>
<a id="__codelineno-0-1101" name="__codelineno-0-1101"></a>
<a id="__codelineno-0-1102" name="__codelineno-0-1102"></a>    <span class="n">units</span><span class="p">,</span> <span class="n">messages_log</span> <span class="o">=</span> <span class="n">extraction_results</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="p">(</span><span class="n">extraction_results</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1103" name="__codelineno-0-1103"></a>
<a id="__codelineno-0-1104" name="__codelineno-0-1104"></a>    <span class="n">frame_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1105" name="__codelineno-0-1105"></a>    <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
<a id="__codelineno-0-1106" name="__codelineno-0-1106"></a>        <span class="n">entity_json</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1107" name="__codelineno-0-1107"></a>        <span class="k">if</span> <span class="n">unit</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1108" name="__codelineno-0-1108"></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping failed unit (</span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">start</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">end</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
<a id="__codelineno-0-1109" name="__codelineno-0-1109"></a>            <span class="k">continue</span>
<a id="__codelineno-0-1110" name="__codelineno-0-1110"></a>        <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">extract_json</span><span class="p">(</span><span class="n">gen_text</span><span class="o">=</span><span class="n">unit</span><span class="o">.</span><span class="n">gen_text</span><span class="p">):</span>
<a id="__codelineno-0-1111" name="__codelineno-0-1111"></a>            <span class="k">if</span> <span class="n">ENTITY_KEY</span> <span class="ow">in</span> <span class="n">entity</span><span class="p">:</span>
<a id="__codelineno-0-1112" name="__codelineno-0-1112"></a>                <span class="n">entity_json</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>
<a id="__codelineno-0-1113" name="__codelineno-0-1113"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1114" name="__codelineno-0-1114"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Extractor output &quot;</span><span class="si">{</span><span class="n">entity</span><span class="si">}</span><span class="s1">&quot; does not have entity_key (&quot;</span><span class="si">{</span><span class="n">ENTITY_KEY</span><span class="si">}</span><span class="s1">&quot;). This frame will be dropped.&#39;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
<a id="__codelineno-0-1115" name="__codelineno-0-1115"></a>
<a id="__codelineno-0-1116" name="__codelineno-0-1116"></a>        <span class="n">spans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_entity_spans</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> 
<a id="__codelineno-0-1117" name="__codelineno-0-1117"></a>                                        <span class="n">entities</span><span class="o">=</span><span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="n">ENTITY_KEY</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entity_json</span><span class="p">],</span> 
<a id="__codelineno-0-1118" name="__codelineno-0-1118"></a>                                        <span class="n">case_sensitive</span><span class="o">=</span><span class="n">case_sensitive</span><span class="p">,</span>
<a id="__codelineno-0-1119" name="__codelineno-0-1119"></a>                                        <span class="n">fuzzy_match</span><span class="o">=</span><span class="n">fuzzy_match</span><span class="p">,</span>
<a id="__codelineno-0-1120" name="__codelineno-0-1120"></a>                                        <span class="n">fuzzy_buffer_size</span><span class="o">=</span><span class="n">fuzzy_buffer_size</span><span class="p">,</span>
<a id="__codelineno-0-1121" name="__codelineno-0-1121"></a>                                        <span class="n">fuzzy_score_cutoff</span><span class="o">=</span><span class="n">fuzzy_score_cutoff</span><span class="p">,</span>
<a id="__codelineno-0-1122" name="__codelineno-0-1122"></a>                                        <span class="n">allow_overlap_entities</span><span class="o">=</span><span class="n">allow_overlap_entities</span><span class="p">)</span>
<a id="__codelineno-0-1123" name="__codelineno-0-1123"></a>        <span class="k">for</span> <span class="n">ent</span><span class="p">,</span> <span class="n">span</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">entity_json</span><span class="p">,</span> <span class="n">spans</span><span class="p">):</span>
<a id="__codelineno-0-1124" name="__codelineno-0-1124"></a>            <span class="k">if</span> <span class="n">span</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1125" name="__codelineno-0-1125"></a>                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">span</span>
<a id="__codelineno-0-1126" name="__codelineno-0-1126"></a>                <span class="n">entity_text</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
<a id="__codelineno-0-1127" name="__codelineno-0-1127"></a>                <span class="n">start</span> <span class="o">+=</span> <span class="n">unit</span><span class="o">.</span><span class="n">start</span>
<a id="__codelineno-0-1128" name="__codelineno-0-1128"></a>                <span class="n">end</span> <span class="o">+=</span> <span class="n">unit</span><span class="o">.</span><span class="n">start</span>
<a id="__codelineno-0-1129" name="__codelineno-0-1129"></a>                <span class="n">attr</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-1130" name="__codelineno-0-1130"></a>                <span class="k">if</span> <span class="s2">&quot;attr&quot;</span> <span class="ow">in</span> <span class="n">ent</span> <span class="ow">and</span> <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1131" name="__codelineno-0-1131"></a>                    <span class="n">attr</span> <span class="o">=</span> <span class="n">ent</span><span class="p">[</span><span class="s2">&quot;attr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1132" name="__codelineno-0-1132"></a>
<a id="__codelineno-0-1133" name="__codelineno-0-1133"></a>                <span class="n">frame</span> <span class="o">=</span> <span class="n">LLMInformationExtractionFrame</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
<a id="__codelineno-0-1134" name="__codelineno-0-1134"></a>                            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
<a id="__codelineno-0-1135" name="__codelineno-0-1135"></a>                            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
<a id="__codelineno-0-1136" name="__codelineno-0-1136"></a>                            <span class="n">entity_text</span><span class="o">=</span><span class="n">entity_text</span><span class="p">,</span>
<a id="__codelineno-0-1137" name="__codelineno-0-1137"></a>                            <span class="n">attr</span><span class="o">=</span><span class="n">attr</span><span class="p">)</span>
<a id="__codelineno-0-1138" name="__codelineno-0-1138"></a>                <span class="n">frame_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
<a id="__codelineno-0-1139" name="__codelineno-0-1139"></a>
<a id="__codelineno-0-1140" name="__codelineno-0-1140"></a>    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-1141" name="__codelineno-0-1141"></a>        <span class="k">return</span> <span class="n">frame_list</span><span class="p">,</span> <span class="n">messages_log</span>
<a id="__codelineno-0-1142" name="__codelineno-0-1142"></a>    <span class="k">return</span> <span class="n">frame_list</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.DirectFrameExtractor.extract_frames_from_documents" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract_frames_from_documents</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract_frames_from_documents</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_contents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">cpu_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">llm_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">case_sensitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">fuzzy_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">fuzzy_buffer_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>    <span class="n">fuzzy_score_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>    <span class="n">allow_overlap_entities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This method inputs a list of documents and yields the results for each document as soon as it is complete.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_contents : List[Union[str,Dict[str, any]]]
    a list of input text contents to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key: str, optional
    The key in the <code>text_contents</code> dictionaries that holds the document text.
cpu_concurrency: int, optional
    The number of parallel threads to use for CPU-bound tasks like chunking.
llm_concurrency: int, optional
    The number of concurrent requests to make to the LLM.
case_sensitive : bool, Optional
    if True, entity text matching will be case-sensitive.
fuzzy_match : bool, Optional
    if True, fuzzy matching will be applied to find entity text.
fuzzy_buffer_size : float, Optional
    the buffer size for fuzzy matching. Default is 20% of entity text length.
fuzzy_score_cutoff : float, Optional
    the Jaccard score cutoff for fuzzy matching. 
    Matched entity text must have a score higher than this value or a None will be returned.
allow_overlap_entities : bool, Optional
    if True, entities can overlap in the text.
return_messages_log : bool, Optional
    if True, a list of messages will be returned.</p>
</details>

<details class="yields:" open>
  <summary>Yields:</summary>
  <p>AsyncGenerator[Dict[str, any], None]
    A dictionary for each completed document, containing its 'idx' and extracted 'frames'.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1145">1145</a></span>
<span class="normal"><a href="#__codelineno-0-1146">1146</a></span>
<span class="normal"><a href="#__codelineno-0-1147">1147</a></span>
<span class="normal"><a href="#__codelineno-0-1148">1148</a></span>
<span class="normal"><a href="#__codelineno-0-1149">1149</a></span>
<span class="normal"><a href="#__codelineno-0-1150">1150</a></span>
<span class="normal"><a href="#__codelineno-0-1151">1151</a></span>
<span class="normal"><a href="#__codelineno-0-1152">1152</a></span>
<span class="normal"><a href="#__codelineno-0-1153">1153</a></span>
<span class="normal"><a href="#__codelineno-0-1154">1154</a></span>
<span class="normal"><a href="#__codelineno-0-1155">1155</a></span>
<span class="normal"><a href="#__codelineno-0-1156">1156</a></span>
<span class="normal"><a href="#__codelineno-0-1157">1157</a></span>
<span class="normal"><a href="#__codelineno-0-1158">1158</a></span>
<span class="normal"><a href="#__codelineno-0-1159">1159</a></span>
<span class="normal"><a href="#__codelineno-0-1160">1160</a></span>
<span class="normal"><a href="#__codelineno-0-1161">1161</a></span>
<span class="normal"><a href="#__codelineno-0-1162">1162</a></span>
<span class="normal"><a href="#__codelineno-0-1163">1163</a></span>
<span class="normal"><a href="#__codelineno-0-1164">1164</a></span>
<span class="normal"><a href="#__codelineno-0-1165">1165</a></span>
<span class="normal"><a href="#__codelineno-0-1166">1166</a></span>
<span class="normal"><a href="#__codelineno-0-1167">1167</a></span>
<span class="normal"><a href="#__codelineno-0-1168">1168</a></span>
<span class="normal"><a href="#__codelineno-0-1169">1169</a></span>
<span class="normal"><a href="#__codelineno-0-1170">1170</a></span>
<span class="normal"><a href="#__codelineno-0-1171">1171</a></span>
<span class="normal"><a href="#__codelineno-0-1172">1172</a></span>
<span class="normal"><a href="#__codelineno-0-1173">1173</a></span>
<span class="normal"><a href="#__codelineno-0-1174">1174</a></span>
<span class="normal"><a href="#__codelineno-0-1175">1175</a></span>
<span class="normal"><a href="#__codelineno-0-1176">1176</a></span>
<span class="normal"><a href="#__codelineno-0-1177">1177</a></span>
<span class="normal"><a href="#__codelineno-0-1178">1178</a></span>
<span class="normal"><a href="#__codelineno-0-1179">1179</a></span>
<span class="normal"><a href="#__codelineno-0-1180">1180</a></span>
<span class="normal"><a href="#__codelineno-0-1181">1181</a></span>
<span class="normal"><a href="#__codelineno-0-1182">1182</a></span>
<span class="normal"><a href="#__codelineno-0-1183">1183</a></span>
<span class="normal"><a href="#__codelineno-0-1184">1184</a></span>
<span class="normal"><a href="#__codelineno-0-1185">1185</a></span>
<span class="normal"><a href="#__codelineno-0-1186">1186</a></span>
<span class="normal"><a href="#__codelineno-0-1187">1187</a></span>
<span class="normal"><a href="#__codelineno-0-1188">1188</a></span>
<span class="normal"><a href="#__codelineno-0-1189">1189</a></span>
<span class="normal"><a href="#__codelineno-0-1190">1190</a></span>
<span class="normal"><a href="#__codelineno-0-1191">1191</a></span>
<span class="normal"><a href="#__codelineno-0-1192">1192</a></span>
<span class="normal"><a href="#__codelineno-0-1193">1193</a></span>
<span class="normal"><a href="#__codelineno-0-1194">1194</a></span>
<span class="normal"><a href="#__codelineno-0-1195">1195</a></span>
<span class="normal"><a href="#__codelineno-0-1196">1196</a></span>
<span class="normal"><a href="#__codelineno-0-1197">1197</a></span>
<span class="normal"><a href="#__codelineno-0-1198">1198</a></span>
<span class="normal"><a href="#__codelineno-0-1199">1199</a></span>
<span class="normal"><a href="#__codelineno-0-1200">1200</a></span>
<span class="normal"><a href="#__codelineno-0-1201">1201</a></span>
<span class="normal"><a href="#__codelineno-0-1202">1202</a></span>
<span class="normal"><a href="#__codelineno-0-1203">1203</a></span>
<span class="normal"><a href="#__codelineno-0-1204">1204</a></span>
<span class="normal"><a href="#__codelineno-0-1205">1205</a></span>
<span class="normal"><a href="#__codelineno-0-1206">1206</a></span>
<span class="normal"><a href="#__codelineno-0-1207">1207</a></span>
<span class="normal"><a href="#__codelineno-0-1208">1208</a></span>
<span class="normal"><a href="#__codelineno-0-1209">1209</a></span>
<span class="normal"><a href="#__codelineno-0-1210">1210</a></span>
<span class="normal"><a href="#__codelineno-0-1211">1211</a></span>
<span class="normal"><a href="#__codelineno-0-1212">1212</a></span>
<span class="normal"><a href="#__codelineno-0-1213">1213</a></span>
<span class="normal"><a href="#__codelineno-0-1214">1214</a></span>
<span class="normal"><a href="#__codelineno-0-1215">1215</a></span>
<span class="normal"><a href="#__codelineno-0-1216">1216</a></span>
<span class="normal"><a href="#__codelineno-0-1217">1217</a></span>
<span class="normal"><a href="#__codelineno-0-1218">1218</a></span>
<span class="normal"><a href="#__codelineno-0-1219">1219</a></span>
<span class="normal"><a href="#__codelineno-0-1220">1220</a></span>
<span class="normal"><a href="#__codelineno-0-1221">1221</a></span>
<span class="normal"><a href="#__codelineno-0-1222">1222</a></span>
<span class="normal"><a href="#__codelineno-0-1223">1223</a></span>
<span class="normal"><a href="#__codelineno-0-1224">1224</a></span>
<span class="normal"><a href="#__codelineno-0-1225">1225</a></span>
<span class="normal"><a href="#__codelineno-0-1226">1226</a></span>
<span class="normal"><a href="#__codelineno-0-1227">1227</a></span>
<span class="normal"><a href="#__codelineno-0-1228">1228</a></span>
<span class="normal"><a href="#__codelineno-0-1229">1229</a></span>
<span class="normal"><a href="#__codelineno-0-1230">1230</a></span>
<span class="normal"><a href="#__codelineno-0-1231">1231</a></span>
<span class="normal"><a href="#__codelineno-0-1232">1232</a></span>
<span class="normal"><a href="#__codelineno-0-1233">1233</a></span>
<span class="normal"><a href="#__codelineno-0-1234">1234</a></span>
<span class="normal"><a href="#__codelineno-0-1235">1235</a></span>
<span class="normal"><a href="#__codelineno-0-1236">1236</a></span>
<span class="normal"><a href="#__codelineno-0-1237">1237</a></span>
<span class="normal"><a href="#__codelineno-0-1238">1238</a></span>
<span class="normal"><a href="#__codelineno-0-1239">1239</a></span>
<span class="normal"><a href="#__codelineno-0-1240">1240</a></span>
<span class="normal"><a href="#__codelineno-0-1241">1241</a></span>
<span class="normal"><a href="#__codelineno-0-1242">1242</a></span>
<span class="normal"><a href="#__codelineno-0-1243">1243</a></span>
<span class="normal"><a href="#__codelineno-0-1244">1244</a></span>
<span class="normal"><a href="#__codelineno-0-1245">1245</a></span>
<span class="normal"><a href="#__codelineno-0-1246">1246</a></span>
<span class="normal"><a href="#__codelineno-0-1247">1247</a></span>
<span class="normal"><a href="#__codelineno-0-1248">1248</a></span>
<span class="normal"><a href="#__codelineno-0-1249">1249</a></span>
<span class="normal"><a href="#__codelineno-0-1250">1250</a></span>
<span class="normal"><a href="#__codelineno-0-1251">1251</a></span>
<span class="normal"><a href="#__codelineno-0-1252">1252</a></span>
<span class="normal"><a href="#__codelineno-0-1253">1253</a></span>
<span class="normal"><a href="#__codelineno-0-1254">1254</a></span>
<span class="normal"><a href="#__codelineno-0-1255">1255</a></span>
<span class="normal"><a href="#__codelineno-0-1256">1256</a></span>
<span class="normal"><a href="#__codelineno-0-1257">1257</a></span>
<span class="normal"><a href="#__codelineno-0-1258">1258</a></span>
<span class="normal"><a href="#__codelineno-0-1259">1259</a></span>
<span class="normal"><a href="#__codelineno-0-1260">1260</a></span>
<span class="normal"><a href="#__codelineno-0-1261">1261</a></span>
<span class="normal"><a href="#__codelineno-0-1262">1262</a></span>
<span class="normal"><a href="#__codelineno-0-1263">1263</a></span>
<span class="normal"><a href="#__codelineno-0-1264">1264</a></span>
<span class="normal"><a href="#__codelineno-0-1265">1265</a></span>
<span class="normal"><a href="#__codelineno-0-1266">1266</a></span>
<span class="normal"><a href="#__codelineno-0-1267">1267</a></span>
<span class="normal"><a href="#__codelineno-0-1268">1268</a></span>
<span class="normal"><a href="#__codelineno-0-1269">1269</a></span>
<span class="normal"><a href="#__codelineno-0-1270">1270</a></span>
<span class="normal"><a href="#__codelineno-0-1271">1271</a></span>
<span class="normal"><a href="#__codelineno-0-1272">1272</a></span>
<span class="normal"><a href="#__codelineno-0-1273">1273</a></span>
<span class="normal"><a href="#__codelineno-0-1274">1274</a></span>
<span class="normal"><a href="#__codelineno-0-1275">1275</a></span>
<span class="normal"><a href="#__codelineno-0-1276">1276</a></span>
<span class="normal"><a href="#__codelineno-0-1277">1277</a></span>
<span class="normal"><a href="#__codelineno-0-1278">1278</a></span>
<span class="normal"><a href="#__codelineno-0-1279">1279</a></span>
<span class="normal"><a href="#__codelineno-0-1280">1280</a></span>
<span class="normal"><a href="#__codelineno-0-1281">1281</a></span>
<span class="normal"><a href="#__codelineno-0-1282">1282</a></span>
<span class="normal"><a href="#__codelineno-0-1283">1283</a></span>
<span class="normal"><a href="#__codelineno-0-1284">1284</a></span>
<span class="normal"><a href="#__codelineno-0-1285">1285</a></span>
<span class="normal"><a href="#__codelineno-0-1286">1286</a></span>
<span class="normal"><a href="#__codelineno-0-1287">1287</a></span>
<span class="normal"><a href="#__codelineno-0-1288">1288</a></span>
<span class="normal"><a href="#__codelineno-0-1289">1289</a></span>
<span class="normal"><a href="#__codelineno-0-1290">1290</a></span>
<span class="normal"><a href="#__codelineno-0-1291">1291</a></span>
<span class="normal"><a href="#__codelineno-0-1292">1292</a></span>
<span class="normal"><a href="#__codelineno-0-1293">1293</a></span>
<span class="normal"><a href="#__codelineno-0-1294">1294</a></span>
<span class="normal"><a href="#__codelineno-0-1295">1295</a></span>
<span class="normal"><a href="#__codelineno-0-1296">1296</a></span>
<span class="normal"><a href="#__codelineno-0-1297">1297</a></span>
<span class="normal"><a href="#__codelineno-0-1298">1298</a></span>
<span class="normal"><a href="#__codelineno-0-1299">1299</a></span>
<span class="normal"><a href="#__codelineno-0-1300">1300</a></span>
<span class="normal"><a href="#__codelineno-0-1301">1301</a></span>
<span class="normal"><a href="#__codelineno-0-1302">1302</a></span>
<span class="normal"><a href="#__codelineno-0-1303">1303</a></span>
<span class="normal"><a href="#__codelineno-0-1304">1304</a></span>
<span class="normal"><a href="#__codelineno-0-1305">1305</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1145" name="__codelineno-0-1145"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">extract_frames_from_documents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_contents</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1146" name="__codelineno-0-1146"></a>        <span class="n">cpu_concurrency</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">llm_concurrency</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
<a id="__codelineno-0-1147" name="__codelineno-0-1147"></a>        <span class="n">fuzzy_match</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fuzzy_buffer_size</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fuzzy_score_cutoff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
<a id="__codelineno-0-1148" name="__codelineno-0-1148"></a>        <span class="n">allow_overlap_entities</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-0-1149" name="__codelineno-0-1149"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1150" name="__codelineno-0-1150"></a><span class="sd">    This method inputs a list of documents and yields the results for each document as soon as it is complete.</span>
<a id="__codelineno-0-1151" name="__codelineno-0-1151"></a>
<a id="__codelineno-0-1152" name="__codelineno-0-1152"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1153" name="__codelineno-0-1153"></a><span class="sd">    -----------</span>
<a id="__codelineno-0-1154" name="__codelineno-0-1154"></a><span class="sd">    text_contents : List[Union[str,Dict[str, any]]]</span>
<a id="__codelineno-0-1155" name="__codelineno-0-1155"></a><span class="sd">        a list of input text contents to put in prompt template. </span>
<a id="__codelineno-0-1156" name="__codelineno-0-1156"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-1157" name="__codelineno-0-1157"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-1158" name="__codelineno-0-1158"></a><span class="sd">    document_key: str, optional</span>
<a id="__codelineno-0-1159" name="__codelineno-0-1159"></a><span class="sd">        The key in the `text_contents` dictionaries that holds the document text.</span>
<a id="__codelineno-0-1160" name="__codelineno-0-1160"></a><span class="sd">    cpu_concurrency: int, optional</span>
<a id="__codelineno-0-1161" name="__codelineno-0-1161"></a><span class="sd">        The number of parallel threads to use for CPU-bound tasks like chunking.</span>
<a id="__codelineno-0-1162" name="__codelineno-0-1162"></a><span class="sd">    llm_concurrency: int, optional</span>
<a id="__codelineno-0-1163" name="__codelineno-0-1163"></a><span class="sd">        The number of concurrent requests to make to the LLM.</span>
<a id="__codelineno-0-1164" name="__codelineno-0-1164"></a><span class="sd">    case_sensitive : bool, Optional</span>
<a id="__codelineno-0-1165" name="__codelineno-0-1165"></a><span class="sd">        if True, entity text matching will be case-sensitive.</span>
<a id="__codelineno-0-1166" name="__codelineno-0-1166"></a><span class="sd">    fuzzy_match : bool, Optional</span>
<a id="__codelineno-0-1167" name="__codelineno-0-1167"></a><span class="sd">        if True, fuzzy matching will be applied to find entity text.</span>
<a id="__codelineno-0-1168" name="__codelineno-0-1168"></a><span class="sd">    fuzzy_buffer_size : float, Optional</span>
<a id="__codelineno-0-1169" name="__codelineno-0-1169"></a><span class="sd">        the buffer size for fuzzy matching. Default is 20% of entity text length.</span>
<a id="__codelineno-0-1170" name="__codelineno-0-1170"></a><span class="sd">    fuzzy_score_cutoff : float, Optional</span>
<a id="__codelineno-0-1171" name="__codelineno-0-1171"></a><span class="sd">        the Jaccard score cutoff for fuzzy matching. </span>
<a id="__codelineno-0-1172" name="__codelineno-0-1172"></a><span class="sd">        Matched entity text must have a score higher than this value or a None will be returned.</span>
<a id="__codelineno-0-1173" name="__codelineno-0-1173"></a><span class="sd">    allow_overlap_entities : bool, Optional</span>
<a id="__codelineno-0-1174" name="__codelineno-0-1174"></a><span class="sd">        if True, entities can overlap in the text.</span>
<a id="__codelineno-0-1175" name="__codelineno-0-1175"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-1176" name="__codelineno-0-1176"></a><span class="sd">        if True, a list of messages will be returned.</span>
<a id="__codelineno-0-1177" name="__codelineno-0-1177"></a>
<a id="__codelineno-0-1178" name="__codelineno-0-1178"></a><span class="sd">    Yields:</span>
<a id="__codelineno-0-1179" name="__codelineno-0-1179"></a><span class="sd">    -------</span>
<a id="__codelineno-0-1180" name="__codelineno-0-1180"></a><span class="sd">    AsyncGenerator[Dict[str, any], None]</span>
<a id="__codelineno-0-1181" name="__codelineno-0-1181"></a><span class="sd">        A dictionary for each completed document, containing its &#39;idx&#39; and extracted &#39;frames&#39;.</span>
<a id="__codelineno-0-1182" name="__codelineno-0-1182"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1183" name="__codelineno-0-1183"></a>    <span class="c1"># Validate text_contents must be a list of str or dict, and not both</span>
<a id="__codelineno-0-1184" name="__codelineno-0-1184"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_contents</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
<a id="__codelineno-0-1185" name="__codelineno-0-1185"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;text_contents must be a list of strings or dictionaries.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1186" name="__codelineno-0-1186"></a>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">text_contents</span><span class="p">):</span>
<a id="__codelineno-0-1187" name="__codelineno-0-1187"></a>        <span class="k">pass</span>  
<a id="__codelineno-0-1188" name="__codelineno-0-1188"></a>    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">text_contents</span><span class="p">):</span>
<a id="__codelineno-0-1189" name="__codelineno-0-1189"></a>        <span class="k">pass</span>
<a id="__codelineno-0-1190" name="__codelineno-0-1190"></a>    <span class="c1"># Set CPU executor and queues</span>
<a id="__codelineno-0-1191" name="__codelineno-0-1191"></a>    <span class="n">cpu_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">cpu_concurrency</span><span class="p">)</span>
<a id="__codelineno-0-1192" name="__codelineno-0-1192"></a>    <span class="n">tasks_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">llm_concurrency</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-1193" name="__codelineno-0-1193"></a>    <span class="c1"># Store to track units and pending counts</span>
<a id="__codelineno-0-1194" name="__codelineno-0-1194"></a>    <span class="n">results_store</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-1195" name="__codelineno-0-1195"></a>        <span class="n">idx</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pending&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">doc</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">document_key</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
<a id="__codelineno-0-1196" name="__codelineno-0-1196"></a>        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_contents</span><span class="p">)</span>
<a id="__codelineno-0-1197" name="__codelineno-0-1197"></a>    <span class="p">}</span>
<a id="__codelineno-0-1198" name="__codelineno-0-1198"></a>
<a id="__codelineno-0-1199" name="__codelineno-0-1199"></a>    <span class="n">output_queue</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
<a id="__codelineno-0-1200" name="__codelineno-0-1200"></a>    <span class="n">messages_logger</span> <span class="o">=</span> <span class="n">MessagesLogger</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-1201" name="__codelineno-0-1201"></a>
<a id="__codelineno-0-1202" name="__codelineno-0-1202"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">producer</span><span class="p">():</span>
<a id="__codelineno-0-1203" name="__codelineno-0-1203"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1204" name="__codelineno-0-1204"></a>            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">text_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">text_contents</span><span class="p">):</span>
<a id="__codelineno-0-1205" name="__codelineno-0-1205"></a>                <span class="n">text</span> <span class="o">=</span> <span class="n">text_content</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">text_content</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">document_key</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1206" name="__codelineno-0-1206"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
<a id="__codelineno-0-1207" name="__codelineno-0-1207"></a>                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Document at index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is empty or missing the document key &#39;</span><span class="si">{</span><span class="n">document_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1208" name="__codelineno-0-1208"></a>                    <span class="c1"># signal that this document is done</span>
<a id="__codelineno-0-1209" name="__codelineno-0-1209"></a>                    <span class="k">await</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">:</span> <span class="p">[]})</span>
<a id="__codelineno-0-1210" name="__codelineno-0-1210"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1211" name="__codelineno-0-1211"></a>
<a id="__codelineno-0-1212" name="__codelineno-0-1212"></a>                <span class="n">units</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk_async</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cpu_executor</span><span class="p">)</span>
<a id="__codelineno-0-1213" name="__codelineno-0-1213"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit_async</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">cpu_executor</span><span class="p">)</span>
<a id="__codelineno-0-1214" name="__codelineno-0-1214"></a>                <span class="n">results_store</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-1215" name="__codelineno-0-1215"></a>
<a id="__codelineno-0-1216" name="__codelineno-0-1216"></a>                <span class="c1"># Handle cases where a document yields no units</span>
<a id="__codelineno-0-1217" name="__codelineno-0-1217"></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">units</span><span class="p">:</span> 
<a id="__codelineno-0-1218" name="__codelineno-0-1218"></a>                    <span class="c1"># signal that this document is done</span>
<a id="__codelineno-0-1219" name="__codelineno-0-1219"></a>                    <span class="k">await</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">:</span> <span class="p">[]})</span>
<a id="__codelineno-0-1220" name="__codelineno-0-1220"></a>                    <span class="k">continue</span>
<a id="__codelineno-0-1221" name="__codelineno-0-1221"></a>
<a id="__codelineno-0-1222" name="__codelineno-0-1222"></a>                <span class="c1"># Iterate through units</span>
<a id="__codelineno-0-1223" name="__codelineno-0-1223"></a>                <span class="k">for</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">units</span><span class="p">:</span>
<a id="__codelineno-0-1224" name="__codelineno-0-1224"></a>                    <span class="n">context</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk_async</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">cpu_executor</span><span class="p">)</span>
<a id="__codelineno-0-1225" name="__codelineno-0-1225"></a>                    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1226" name="__codelineno-0-1226"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-1227" name="__codelineno-0-1227"></a>                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1228" name="__codelineno-0-1228"></a>
<a id="__codelineno-0-1229" name="__codelineno-0-1229"></a>                    <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
<a id="__codelineno-0-1230" name="__codelineno-0-1230"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1231" name="__codelineno-0-1231"></a>                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-1232" name="__codelineno-0-1232"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1233" name="__codelineno-0-1233"></a>                            <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1234" name="__codelineno-0-1234"></a>                            <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-1235" name="__codelineno-0-1235"></a>                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-1236" name="__codelineno-0-1236"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1237" name="__codelineno-0-1237"></a>                        <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-1238" name="__codelineno-0-1238"></a>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1239" name="__codelineno-0-1239"></a>                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-1240" name="__codelineno-0-1240"></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1241" name="__codelineno-0-1241"></a>                            <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1242" name="__codelineno-0-1242"></a>                            <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-1243" name="__codelineno-0-1243"></a>                            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-1244" name="__codelineno-0-1244"></a>                        <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-1245" name="__codelineno-0-1245"></a>                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-1246" name="__codelineno-0-1246"></a>                        <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-1247" name="__codelineno-0-1247"></a>                        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-1248" name="__codelineno-0-1248"></a>
<a id="__codelineno-0-1249" name="__codelineno-0-1249"></a>                    <span class="k">await</span> <span class="n">tasks_queue</span><span class="o">.</span><span class="n">put</span><span class="p">({</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages</span><span class="p">})</span>
<a id="__codelineno-0-1250" name="__codelineno-0-1250"></a>        <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1251" name="__codelineno-0-1251"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">llm_concurrency</span><span class="p">):</span>
<a id="__codelineno-0-1252" name="__codelineno-0-1252"></a>                <span class="k">await</span> <span class="n">tasks_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-1253" name="__codelineno-0-1253"></a>
<a id="__codelineno-0-1254" name="__codelineno-0-1254"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">worker</span><span class="p">():</span>
<a id="__codelineno-0-1255" name="__codelineno-0-1255"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-1256" name="__codelineno-0-1256"></a>            <span class="n">task_item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tasks_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-0-1257" name="__codelineno-0-1257"></a>            <span class="k">if</span> <span class="n">task_item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1258" name="__codelineno-0-1258"></a>                <span class="n">tasks_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
<a id="__codelineno-0-1259" name="__codelineno-0-1259"></a>                <span class="k">break</span>
<a id="__codelineno-0-1260" name="__codelineno-0-1260"></a>
<a id="__codelineno-0-1261" name="__codelineno-0-1261"></a>            <span class="n">idx</span> <span class="o">=</span> <span class="n">task_item</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1262" name="__codelineno-0-1262"></a>            <span class="n">unit</span> <span class="o">=</span> <span class="n">task_item</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
<a id="__codelineno-0-1263" name="__codelineno-0-1263"></a>            <span class="n">doc_results</span> <span class="o">=</span> <span class="n">results_store</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-0-1264" name="__codelineno-0-1264"></a>
<a id="__codelineno-0-1265" name="__codelineno-0-1265"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1266" name="__codelineno-0-1266"></a>                <span class="n">gen_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat_async</span><span class="p">(</span>
<a id="__codelineno-0-1267" name="__codelineno-0-1267"></a>                    <span class="n">messages</span><span class="o">=</span><span class="n">task_item</span><span class="p">[</span><span class="s1">&#39;messages&#39;</span><span class="p">],</span> <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1268" name="__codelineno-0-1268"></a>                <span class="p">)</span>
<a id="__codelineno-0-1269" name="__codelineno-0-1269"></a>                <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">gen_text</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1270" name="__codelineno-0-1270"></a>                <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1271" name="__codelineno-0-1271"></a>                <span class="n">doc_results</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-1272" name="__codelineno-0-1272"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1273" name="__codelineno-0-1273"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing unit for doc idx </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1274" name="__codelineno-0-1274"></a>            <span class="k">finally</span><span class="p">:</span>
<a id="__codelineno-0-1275" name="__codelineno-0-1275"></a>                <span class="n">doc_results</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-0-1276" name="__codelineno-0-1276"></a>                <span class="k">if</span> <span class="n">doc_results</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1277" name="__codelineno-0-1277"></a>                    <span class="n">final_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_and_create_frames</span><span class="p">(</span><span class="n">doc_results</span><span class="p">,</span> <span class="n">case_sensitive</span><span class="p">,</span> <span class="n">fuzzy_match</span><span class="p">,</span> <span class="n">fuzzy_buffer_size</span><span class="p">,</span> <span class="n">fuzzy_score_cutoff</span><span class="p">,</span> <span class="n">allow_overlap_entities</span><span class="p">)</span>
<a id="__codelineno-0-1278" name="__codelineno-0-1278"></a>                    <span class="n">output_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;idx&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">:</span> <span class="n">final_frames</span><span class="p">}</span>
<a id="__codelineno-0-1279" name="__codelineno-0-1279"></a>                    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-1280" name="__codelineno-0-1280"></a>                        <span class="n">output_payload</span><span class="p">[</span><span class="s1">&#39;messages_log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">messages_logger</span><span class="o">.</span><span class="n">get_messages_log</span><span class="p">()</span>
<a id="__codelineno-0-1281" name="__codelineno-0-1281"></a>                    <span class="k">await</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">output_payload</span><span class="p">)</span>
<a id="__codelineno-0-1282" name="__codelineno-0-1282"></a>
<a id="__codelineno-0-1283" name="__codelineno-0-1283"></a>                <span class="n">tasks_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
<a id="__codelineno-0-1284" name="__codelineno-0-1284"></a>
<a id="__codelineno-0-1285" name="__codelineno-0-1285"></a>    <span class="c1"># Start producer and workers</span>
<a id="__codelineno-0-1286" name="__codelineno-0-1286"></a>    <span class="n">producer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">producer</span><span class="p">())</span>
<a id="__codelineno-0-1287" name="__codelineno-0-1287"></a>    <span class="n">worker_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">worker</span><span class="p">())</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">llm_concurrency</span><span class="p">)]</span>
<a id="__codelineno-0-1288" name="__codelineno-0-1288"></a>
<a id="__codelineno-0-1289" name="__codelineno-0-1289"></a>    <span class="c1"># Main loop to gather results</span>
<a id="__codelineno-0-1290" name="__codelineno-0-1290"></a>    <span class="n">docs_completed</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-1291" name="__codelineno-0-1291"></a>    <span class="k">while</span> <span class="n">docs_completed</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">text_contents</span><span class="p">):</span>
<a id="__codelineno-0-1292" name="__codelineno-0-1292"></a>        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">output_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<a id="__codelineno-0-1293" name="__codelineno-0-1293"></a>        <span class="k">yield</span> <span class="n">result</span>
<a id="__codelineno-0-1294" name="__codelineno-0-1294"></a>        <span class="n">docs_completed</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-1295" name="__codelineno-0-1295"></a>
<a id="__codelineno-0-1296" name="__codelineno-0-1296"></a>    <span class="c1"># Final cleanup</span>
<a id="__codelineno-0-1297" name="__codelineno-0-1297"></a>    <span class="k">await</span> <span class="n">producer_task</span> 
<a id="__codelineno-0-1298" name="__codelineno-0-1298"></a>    <span class="k">await</span> <span class="n">tasks_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<a id="__codelineno-0-1299" name="__codelineno-0-1299"></a>
<a id="__codelineno-0-1300" name="__codelineno-0-1300"></a>    <span class="c1"># Cancel any lingering worker tasks</span>
<a id="__codelineno-0-1301" name="__codelineno-0-1301"></a>    <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">worker_tasks</span><span class="p">:</span>
<a id="__codelineno-0-1302" name="__codelineno-0-1302"></a>        <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
<a id="__codelineno-0-1303" name="__codelineno-0-1303"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">worker_tasks</span><span class="p">,</span> <span class="n">return_exceptions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-1304" name="__codelineno-0-1304"></a>
<a id="__codelineno-0-1305" name="__codelineno-0-1305"></a>    <span class="n">cpu_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.ReviewFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.ReviewFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">ReviewFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">unit_chunker</span><span class="p">:</span> <span class="n">UnitChunker</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">context_chunker</span><span class="p">:</span> <span class="n">ContextChunker</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">review_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">review_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llm_ie.extractors.DirectFrameExtractor" href="#llm_ie.extractors.DirectFrameExtractor">DirectFrameExtractor</a></code></p>


        <p>This class add a review step after the DirectFrameExtractor.
The Review process asks LLM to review its output and:
    1. add more frames while keep current. This is efficient for boosting recall. 
    2. or, regenerate frames (add new and delete existing). 
Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>unit_chunker : UnitChunker
    the unit chunker object that determines how to chunk the document text into units.
context_chunker : ContextChunker
    the context chunker object that determines how to get context for each unit.
inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
review_prompt : str: Optional
    the prompt text that ask LLM to review. Specify addition or revision in the instruction.
    if not provided, a default review prompt will be used. 
review_mode : str
    review mode. Must be one of {"addition", "revision"}
    addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.
system_prompt : str, Optional
    system prompt.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1348">1348</a></span>
<span class="normal"><a href="#__codelineno-0-1349">1349</a></span>
<span class="normal"><a href="#__codelineno-0-1350">1350</a></span>
<span class="normal"><a href="#__codelineno-0-1351">1351</a></span>
<span class="normal"><a href="#__codelineno-0-1352">1352</a></span>
<span class="normal"><a href="#__codelineno-0-1353">1353</a></span>
<span class="normal"><a href="#__codelineno-0-1354">1354</a></span>
<span class="normal"><a href="#__codelineno-0-1355">1355</a></span>
<span class="normal"><a href="#__codelineno-0-1356">1356</a></span>
<span class="normal"><a href="#__codelineno-0-1357">1357</a></span>
<span class="normal"><a href="#__codelineno-0-1358">1358</a></span>
<span class="normal"><a href="#__codelineno-0-1359">1359</a></span>
<span class="normal"><a href="#__codelineno-0-1360">1360</a></span>
<span class="normal"><a href="#__codelineno-0-1361">1361</a></span>
<span class="normal"><a href="#__codelineno-0-1362">1362</a></span>
<span class="normal"><a href="#__codelineno-0-1363">1363</a></span>
<span class="normal"><a href="#__codelineno-0-1364">1364</a></span>
<span class="normal"><a href="#__codelineno-0-1365">1365</a></span>
<span class="normal"><a href="#__codelineno-0-1366">1366</a></span>
<span class="normal"><a href="#__codelineno-0-1367">1367</a></span>
<span class="normal"><a href="#__codelineno-0-1368">1368</a></span>
<span class="normal"><a href="#__codelineno-0-1369">1369</a></span>
<span class="normal"><a href="#__codelineno-0-1370">1370</a></span>
<span class="normal"><a href="#__codelineno-0-1371">1371</a></span>
<span class="normal"><a href="#__codelineno-0-1372">1372</a></span>
<span class="normal"><a href="#__codelineno-0-1373">1373</a></span>
<span class="normal"><a href="#__codelineno-0-1374">1374</a></span>
<span class="normal"><a href="#__codelineno-0-1375">1375</a></span>
<span class="normal"><a href="#__codelineno-0-1376">1376</a></span>
<span class="normal"><a href="#__codelineno-0-1377">1377</a></span>
<span class="normal"><a href="#__codelineno-0-1378">1378</a></span>
<span class="normal"><a href="#__codelineno-0-1379">1379</a></span>
<span class="normal"><a href="#__codelineno-0-1380">1380</a></span>
<span class="normal"><a href="#__codelineno-0-1381">1381</a></span>
<span class="normal"><a href="#__codelineno-0-1382">1382</a></span>
<span class="normal"><a href="#__codelineno-0-1383">1383</a></span>
<span class="normal"><a href="#__codelineno-0-1384">1384</a></span>
<span class="normal"><a href="#__codelineno-0-1385">1385</a></span>
<span class="normal"><a href="#__codelineno-0-1386">1386</a></span>
<span class="normal"><a href="#__codelineno-0-1387">1387</a></span>
<span class="normal"><a href="#__codelineno-0-1388">1388</a></span>
<span class="normal"><a href="#__codelineno-0-1389">1389</a></span>
<span class="normal"><a href="#__codelineno-0-1390">1390</a></span>
<span class="normal"><a href="#__codelineno-0-1391">1391</a></span>
<span class="normal"><a href="#__codelineno-0-1392">1392</a></span>
<span class="normal"><a href="#__codelineno-0-1393">1393</a></span>
<span class="normal"><a href="#__codelineno-0-1394">1394</a></span>
<span class="normal"><a href="#__codelineno-0-1395">1395</a></span>
<span class="normal"><a href="#__codelineno-0-1396">1396</a></span>
<span class="normal"><a href="#__codelineno-0-1397">1397</a></span>
<span class="normal"><a href="#__codelineno-0-1398">1398</a></span>
<span class="normal"><a href="#__codelineno-0-1399">1399</a></span>
<span class="normal"><a href="#__codelineno-0-1400">1400</a></span>
<span class="normal"><a href="#__codelineno-0-1401">1401</a></span>
<span class="normal"><a href="#__codelineno-0-1402">1402</a></span>
<span class="normal"><a href="#__codelineno-0-1403">1403</a></span>
<span class="normal"><a href="#__codelineno-0-1404">1404</a></span>
<span class="normal"><a href="#__codelineno-0-1405">1405</a></span>
<span class="normal"><a href="#__codelineno-0-1406">1406</a></span>
<span class="normal"><a href="#__codelineno-0-1407">1407</a></span>
<span class="normal"><a href="#__codelineno-0-1408">1408</a></span>
<span class="normal"><a href="#__codelineno-0-1409">1409</a></span>
<span class="normal"><a href="#__codelineno-0-1410">1410</a></span>
<span class="normal"><a href="#__codelineno-0-1411">1411</a></span>
<span class="normal"><a href="#__codelineno-0-1412">1412</a></span>
<span class="normal"><a href="#__codelineno-0-1413">1413</a></span>
<span class="normal"><a href="#__codelineno-0-1414">1414</a></span>
<span class="normal"><a href="#__codelineno-0-1415">1415</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1348" name="__codelineno-0-1348"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit_chunker</span><span class="p">:</span><span class="n">UnitChunker</span><span class="p">,</span> <span class="n">context_chunker</span><span class="p">:</span><span class="n">ContextChunker</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> 
<a id="__codelineno-0-1349" name="__codelineno-0-1349"></a>             <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">review_mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">review_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-1350" name="__codelineno-0-1350"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1351" name="__codelineno-0-1351"></a><span class="sd">    This class add a review step after the DirectFrameExtractor.</span>
<a id="__codelineno-0-1352" name="__codelineno-0-1352"></a><span class="sd">    The Review process asks LLM to review its output and:</span>
<a id="__codelineno-0-1353" name="__codelineno-0-1353"></a><span class="sd">        1. add more frames while keep current. This is efficient for boosting recall. </span>
<a id="__codelineno-0-1354" name="__codelineno-0-1354"></a><span class="sd">        2. or, regenerate frames (add new and delete existing). </span>
<a id="__codelineno-0-1355" name="__codelineno-0-1355"></a><span class="sd">    Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</span>
<a id="__codelineno-0-1356" name="__codelineno-0-1356"></a>
<a id="__codelineno-0-1357" name="__codelineno-0-1357"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1358" name="__codelineno-0-1358"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1359" name="__codelineno-0-1359"></a><span class="sd">    unit_chunker : UnitChunker</span>
<a id="__codelineno-0-1360" name="__codelineno-0-1360"></a><span class="sd">        the unit chunker object that determines how to chunk the document text into units.</span>
<a id="__codelineno-0-1361" name="__codelineno-0-1361"></a><span class="sd">    context_chunker : ContextChunker</span>
<a id="__codelineno-0-1362" name="__codelineno-0-1362"></a><span class="sd">        the context chunker object that determines how to get context for each unit.</span>
<a id="__codelineno-0-1363" name="__codelineno-0-1363"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-1364" name="__codelineno-0-1364"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-1365" name="__codelineno-0-1365"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-1366" name="__codelineno-0-1366"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-1367" name="__codelineno-0-1367"></a><span class="sd">    review_prompt : str: Optional</span>
<a id="__codelineno-0-1368" name="__codelineno-0-1368"></a><span class="sd">        the prompt text that ask LLM to review. Specify addition or revision in the instruction.</span>
<a id="__codelineno-0-1369" name="__codelineno-0-1369"></a><span class="sd">        if not provided, a default review prompt will be used. </span>
<a id="__codelineno-0-1370" name="__codelineno-0-1370"></a><span class="sd">    review_mode : str</span>
<a id="__codelineno-0-1371" name="__codelineno-0-1371"></a><span class="sd">        review mode. Must be one of {&quot;addition&quot;, &quot;revision&quot;}</span>
<a id="__codelineno-0-1372" name="__codelineno-0-1372"></a><span class="sd">        addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.</span>
<a id="__codelineno-0-1373" name="__codelineno-0-1373"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-1374" name="__codelineno-0-1374"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-1375" name="__codelineno-0-1375"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1376" name="__codelineno-0-1376"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span> 
<a id="__codelineno-0-1377" name="__codelineno-0-1377"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">unit_chunker</span><span class="p">,</span> 
<a id="__codelineno-0-1378" name="__codelineno-0-1378"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> 
<a id="__codelineno-0-1379" name="__codelineno-0-1379"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1380" name="__codelineno-0-1380"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">context_chunker</span><span class="p">)</span>
<a id="__codelineno-0-1381" name="__codelineno-0-1381"></a>    <span class="c1"># check review mode</span>
<a id="__codelineno-0-1382" name="__codelineno-0-1382"></a>    <span class="k">if</span> <span class="n">review_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;addition&quot;</span><span class="p">,</span> <span class="s2">&quot;revision&quot;</span><span class="p">}:</span> 
<a id="__codelineno-0-1383" name="__codelineno-0-1383"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;review_mode must be one of {&quot;addition&quot;, &quot;revision&quot;}.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1384" name="__codelineno-0-1384"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span> <span class="o">=</span> <span class="n">review_mode</span>
<a id="__codelineno-0-1385" name="__codelineno-0-1385"></a>    <span class="c1"># assign review prompt</span>
<a id="__codelineno-0-1386" name="__codelineno-0-1386"></a>    <span class="k">if</span> <span class="n">review_prompt</span><span class="p">:</span>
<a id="__codelineno-0-1387" name="__codelineno-0-1387"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span> <span class="o">=</span> <span class="n">review_prompt</span>
<a id="__codelineno-0-1388" name="__codelineno-0-1388"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1389" name="__codelineno-0-1389"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-1390" name="__codelineno-0-1390"></a>        <span class="n">original_class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-1391" name="__codelineno-0-1391"></a>
<a id="__codelineno-0-1392" name="__codelineno-0-1392"></a>        <span class="n">current_class_name</span> <span class="o">=</span> <span class="n">original_class_name</span>
<a id="__codelineno-0-1393" name="__codelineno-0-1393"></a>        <span class="k">for</span> <span class="n">current_class_in_mro</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
<a id="__codelineno-0-1394" name="__codelineno-0-1394"></a>            <span class="k">if</span> <span class="n">current_class_in_mro</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span> 
<a id="__codelineno-0-1395" name="__codelineno-0-1395"></a>                <span class="k">continue</span>
<a id="__codelineno-0-1396" name="__codelineno-0-1396"></a>
<a id="__codelineno-0-1397" name="__codelineno-0-1397"></a>            <span class="n">current_class_name</span> <span class="o">=</span> <span class="n">current_class_in_mro</span><span class="o">.</span><span class="vm">__name__</span>
<a id="__codelineno-0-1398" name="__codelineno-0-1398"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-1399" name="__codelineno-0-1399"></a>                <span class="n">file_path</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;llm_ie.asset.default_prompts&#39;</span><span class="p">)</span><span class="o">.</span>\
<a id="__codelineno-0-1400" name="__codelineno-0-1400"></a>                    <span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span><span class="si">}</span><span class="s2">_review_prompt.txt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1401" name="__codelineno-0-1401"></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-0-1402" name="__codelineno-0-1402"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="__codelineno-0-1403" name="__codelineno-0-1403"></a>            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
<a id="__codelineno-0-1404" name="__codelineno-0-1404"></a>                <span class="k">pass</span>
<a id="__codelineno-0-1405" name="__codelineno-0-1405"></a>
<a id="__codelineno-0-1406" name="__codelineno-0-1406"></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-1407" name="__codelineno-0-1407"></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
<a id="__codelineno-0-1408" name="__codelineno-0-1408"></a>                    <span class="sa">f</span><span class="s2">&quot;Error attempting to read default review prompt for &#39;</span><span class="si">{</span><span class="n">current_class_name</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
<a id="__codelineno-0-1409" name="__codelineno-0-1409"></a>                    <span class="sa">f</span><span class="s2">&quot;from &#39;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Trying next in MRO.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-1410" name="__codelineno-0-1410"></a>                    <span class="ne">UserWarning</span>
<a id="__codelineno-0-1411" name="__codelineno-0-1411"></a>                <span class="p">)</span>
<a id="__codelineno-0-1412" name="__codelineno-0-1412"></a>                <span class="k">continue</span> 
<a id="__codelineno-0-1413" name="__codelineno-0-1413"></a>
<a id="__codelineno-0-1414" name="__codelineno-0-1414"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1415" name="__codelineno-0-1415"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find review prompt for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> in the package. Please provide a review_prompt.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.ReviewFrameExtractor.extract" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This method inputs a text and outputs a list of outputs per unit.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is. 
    If text_content is str, this parameter will be ignored.
verbose : bool, Optional
    if True, LLM generated text will be printed in terminal in real-time. 
return_messages_log : bool, Optional
    if True, a list of messages will be returned.</p>
<p>Return : List[FrameExtractionUnitResult]
    the output from LLM for each unit. Contains the start, end, text, and generated text.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1417">1417</a></span>
<span class="normal"><a href="#__codelineno-0-1418">1418</a></span>
<span class="normal"><a href="#__codelineno-0-1419">1419</a></span>
<span class="normal"><a href="#__codelineno-0-1420">1420</a></span>
<span class="normal"><a href="#__codelineno-0-1421">1421</a></span>
<span class="normal"><a href="#__codelineno-0-1422">1422</a></span>
<span class="normal"><a href="#__codelineno-0-1423">1423</a></span>
<span class="normal"><a href="#__codelineno-0-1424">1424</a></span>
<span class="normal"><a href="#__codelineno-0-1425">1425</a></span>
<span class="normal"><a href="#__codelineno-0-1426">1426</a></span>
<span class="normal"><a href="#__codelineno-0-1427">1427</a></span>
<span class="normal"><a href="#__codelineno-0-1428">1428</a></span>
<span class="normal"><a href="#__codelineno-0-1429">1429</a></span>
<span class="normal"><a href="#__codelineno-0-1430">1430</a></span>
<span class="normal"><a href="#__codelineno-0-1431">1431</a></span>
<span class="normal"><a href="#__codelineno-0-1432">1432</a></span>
<span class="normal"><a href="#__codelineno-0-1433">1433</a></span>
<span class="normal"><a href="#__codelineno-0-1434">1434</a></span>
<span class="normal"><a href="#__codelineno-0-1435">1435</a></span>
<span class="normal"><a href="#__codelineno-0-1436">1436</a></span>
<span class="normal"><a href="#__codelineno-0-1437">1437</a></span>
<span class="normal"><a href="#__codelineno-0-1438">1438</a></span>
<span class="normal"><a href="#__codelineno-0-1439">1439</a></span>
<span class="normal"><a href="#__codelineno-0-1440">1440</a></span>
<span class="normal"><a href="#__codelineno-0-1441">1441</a></span>
<span class="normal"><a href="#__codelineno-0-1442">1442</a></span>
<span class="normal"><a href="#__codelineno-0-1443">1443</a></span>
<span class="normal"><a href="#__codelineno-0-1444">1444</a></span>
<span class="normal"><a href="#__codelineno-0-1445">1445</a></span>
<span class="normal"><a href="#__codelineno-0-1446">1446</a></span>
<span class="normal"><a href="#__codelineno-0-1447">1447</a></span>
<span class="normal"><a href="#__codelineno-0-1448">1448</a></span>
<span class="normal"><a href="#__codelineno-0-1449">1449</a></span>
<span class="normal"><a href="#__codelineno-0-1450">1450</a></span>
<span class="normal"><a href="#__codelineno-0-1451">1451</a></span>
<span class="normal"><a href="#__codelineno-0-1452">1452</a></span>
<span class="normal"><a href="#__codelineno-0-1453">1453</a></span>
<span class="normal"><a href="#__codelineno-0-1454">1454</a></span>
<span class="normal"><a href="#__codelineno-0-1455">1455</a></span>
<span class="normal"><a href="#__codelineno-0-1456">1456</a></span>
<span class="normal"><a href="#__codelineno-0-1457">1457</a></span>
<span class="normal"><a href="#__codelineno-0-1458">1458</a></span>
<span class="normal"><a href="#__codelineno-0-1459">1459</a></span>
<span class="normal"><a href="#__codelineno-0-1460">1460</a></span>
<span class="normal"><a href="#__codelineno-0-1461">1461</a></span>
<span class="normal"><a href="#__codelineno-0-1462">1462</a></span>
<span class="normal"><a href="#__codelineno-0-1463">1463</a></span>
<span class="normal"><a href="#__codelineno-0-1464">1464</a></span>
<span class="normal"><a href="#__codelineno-0-1465">1465</a></span>
<span class="normal"><a href="#__codelineno-0-1466">1466</a></span>
<span class="normal"><a href="#__codelineno-0-1467">1467</a></span>
<span class="normal"><a href="#__codelineno-0-1468">1468</a></span>
<span class="normal"><a href="#__codelineno-0-1469">1469</a></span>
<span class="normal"><a href="#__codelineno-0-1470">1470</a></span>
<span class="normal"><a href="#__codelineno-0-1471">1471</a></span>
<span class="normal"><a href="#__codelineno-0-1472">1472</a></span>
<span class="normal"><a href="#__codelineno-0-1473">1473</a></span>
<span class="normal"><a href="#__codelineno-0-1474">1474</a></span>
<span class="normal"><a href="#__codelineno-0-1475">1475</a></span>
<span class="normal"><a href="#__codelineno-0-1476">1476</a></span>
<span class="normal"><a href="#__codelineno-0-1477">1477</a></span>
<span class="normal"><a href="#__codelineno-0-1478">1478</a></span>
<span class="normal"><a href="#__codelineno-0-1479">1479</a></span>
<span class="normal"><a href="#__codelineno-0-1480">1480</a></span>
<span class="normal"><a href="#__codelineno-0-1481">1481</a></span>
<span class="normal"><a href="#__codelineno-0-1482">1482</a></span>
<span class="normal"><a href="#__codelineno-0-1483">1483</a></span>
<span class="normal"><a href="#__codelineno-0-1484">1484</a></span>
<span class="normal"><a href="#__codelineno-0-1485">1485</a></span>
<span class="normal"><a href="#__codelineno-0-1486">1486</a></span>
<span class="normal"><a href="#__codelineno-0-1487">1487</a></span>
<span class="normal"><a href="#__codelineno-0-1488">1488</a></span>
<span class="normal"><a href="#__codelineno-0-1489">1489</a></span>
<span class="normal"><a href="#__codelineno-0-1490">1490</a></span>
<span class="normal"><a href="#__codelineno-0-1491">1491</a></span>
<span class="normal"><a href="#__codelineno-0-1492">1492</a></span>
<span class="normal"><a href="#__codelineno-0-1493">1493</a></span>
<span class="normal"><a href="#__codelineno-0-1494">1494</a></span>
<span class="normal"><a href="#__codelineno-0-1495">1495</a></span>
<span class="normal"><a href="#__codelineno-0-1496">1496</a></span>
<span class="normal"><a href="#__codelineno-0-1497">1497</a></span>
<span class="normal"><a href="#__codelineno-0-1498">1498</a></span>
<span class="normal"><a href="#__codelineno-0-1499">1499</a></span>
<span class="normal"><a href="#__codelineno-0-1500">1500</a></span>
<span class="normal"><a href="#__codelineno-0-1501">1501</a></span>
<span class="normal"><a href="#__codelineno-0-1502">1502</a></span>
<span class="normal"><a href="#__codelineno-0-1503">1503</a></span>
<span class="normal"><a href="#__codelineno-0-1504">1504</a></span>
<span class="normal"><a href="#__codelineno-0-1505">1505</a></span>
<span class="normal"><a href="#__codelineno-0-1506">1506</a></span>
<span class="normal"><a href="#__codelineno-0-1507">1507</a></span>
<span class="normal"><a href="#__codelineno-0-1508">1508</a></span>
<span class="normal"><a href="#__codelineno-0-1509">1509</a></span>
<span class="normal"><a href="#__codelineno-0-1510">1510</a></span>
<span class="normal"><a href="#__codelineno-0-1511">1511</a></span>
<span class="normal"><a href="#__codelineno-0-1512">1512</a></span>
<span class="normal"><a href="#__codelineno-0-1513">1513</a></span>
<span class="normal"><a href="#__codelineno-0-1514">1514</a></span>
<span class="normal"><a href="#__codelineno-0-1515">1515</a></span>
<span class="normal"><a href="#__codelineno-0-1516">1516</a></span>
<span class="normal"><a href="#__codelineno-0-1517">1517</a></span>
<span class="normal"><a href="#__codelineno-0-1518">1518</a></span>
<span class="normal"><a href="#__codelineno-0-1519">1519</a></span>
<span class="normal"><a href="#__codelineno-0-1520">1520</a></span>
<span class="normal"><a href="#__codelineno-0-1521">1521</a></span>
<span class="normal"><a href="#__codelineno-0-1522">1522</a></span>
<span class="normal"><a href="#__codelineno-0-1523">1523</a></span>
<span class="normal"><a href="#__codelineno-0-1524">1524</a></span>
<span class="normal"><a href="#__codelineno-0-1525">1525</a></span>
<span class="normal"><a href="#__codelineno-0-1526">1526</a></span>
<span class="normal"><a href="#__codelineno-0-1527">1527</a></span>
<span class="normal"><a href="#__codelineno-0-1528">1528</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1417" name="__codelineno-0-1417"></a><span class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-0-1418" name="__codelineno-0-1418"></a>            <span class="n">verbose</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]:</span>
<a id="__codelineno-0-1419" name="__codelineno-0-1419"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1420" name="__codelineno-0-1420"></a><span class="sd">    This method inputs a text and outputs a list of outputs per unit.</span>
<a id="__codelineno-0-1421" name="__codelineno-0-1421"></a>
<a id="__codelineno-0-1422" name="__codelineno-0-1422"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1423" name="__codelineno-0-1423"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1424" name="__codelineno-0-1424"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-1425" name="__codelineno-0-1425"></a><span class="sd">        the input text content to put in prompt template. </span>
<a id="__codelineno-0-1426" name="__codelineno-0-1426"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-1427" name="__codelineno-0-1427"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-1428" name="__codelineno-0-1428"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-1429" name="__codelineno-0-1429"></a><span class="sd">        specify the key in text_content where document text is. </span>
<a id="__codelineno-0-1430" name="__codelineno-0-1430"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-1431" name="__codelineno-0-1431"></a><span class="sd">    verbose : bool, Optional</span>
<a id="__codelineno-0-1432" name="__codelineno-0-1432"></a><span class="sd">        if True, LLM generated text will be printed in terminal in real-time. </span>
<a id="__codelineno-0-1433" name="__codelineno-0-1433"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-1434" name="__codelineno-0-1434"></a><span class="sd">        if True, a list of messages will be returned.</span>
<a id="__codelineno-0-1435" name="__codelineno-0-1435"></a>
<a id="__codelineno-0-1436" name="__codelineno-0-1436"></a><span class="sd">    Return : List[FrameExtractionUnitResult]</span>
<a id="__codelineno-0-1437" name="__codelineno-0-1437"></a><span class="sd">        the output from LLM for each unit. Contains the start, end, text, and generated text.</span>
<a id="__codelineno-0-1438" name="__codelineno-0-1438"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1439" name="__codelineno-0-1439"></a>    <span class="c1"># unit chunking</span>
<a id="__codelineno-0-1440" name="__codelineno-0-1440"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1441" name="__codelineno-0-1441"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-1442" name="__codelineno-0-1442"></a>
<a id="__codelineno-0-1443" name="__codelineno-0-1443"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-1444" name="__codelineno-0-1444"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1445" name="__codelineno-0-1445"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1446" name="__codelineno-0-1446"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-1447" name="__codelineno-0-1447"></a>
<a id="__codelineno-0-1448" name="__codelineno-0-1448"></a>    <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-1449" name="__codelineno-0-1449"></a>    <span class="c1"># context chunker init</span>
<a id="__codelineno-0-1450" name="__codelineno-0-1450"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-1451" name="__codelineno-0-1451"></a>
<a id="__codelineno-0-1452" name="__codelineno-0-1452"></a>    <span class="c1"># messages logger init</span>
<a id="__codelineno-0-1453" name="__codelineno-0-1453"></a>    <span class="n">messages_logger</span> <span class="o">=</span> <span class="n">MessagesLogger</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-1454" name="__codelineno-0-1454"></a>
<a id="__codelineno-0-1455" name="__codelineno-0-1455"></a>    <span class="c1"># generate unit by unit</span>
<a id="__codelineno-0-1456" name="__codelineno-0-1456"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-1457" name="__codelineno-0-1457"></a>        <span class="c1"># &lt;--- Initial generation step ---&gt;</span>
<a id="__codelineno-0-1458" name="__codelineno-0-1458"></a>        <span class="c1"># construct chat messages</span>
<a id="__codelineno-0-1459" name="__codelineno-0-1459"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1460" name="__codelineno-0-1460"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-1461" name="__codelineno-0-1461"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1462" name="__codelineno-0-1462"></a>
<a id="__codelineno-0-1463" name="__codelineno-0-1463"></a>        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-1464" name="__codelineno-0-1464"></a>
<a id="__codelineno-0-1465" name="__codelineno-0-1465"></a>        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1466" name="__codelineno-0-1466"></a>            <span class="c1"># no context, just place unit in user prompt</span>
<a id="__codelineno-0-1467" name="__codelineno-0-1467"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1468" name="__codelineno-0-1468"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-1469" name="__codelineno-0-1469"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1470" name="__codelineno-0-1470"></a>                <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1471" name="__codelineno-0-1471"></a>                <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-1472" name="__codelineno-0-1472"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-1473" name="__codelineno-0-1473"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1474" name="__codelineno-0-1474"></a>            <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-1475" name="__codelineno-0-1475"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1476" name="__codelineno-0-1476"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-1477" name="__codelineno-0-1477"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1478" name="__codelineno-0-1478"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1479" name="__codelineno-0-1479"></a>                <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-1480" name="__codelineno-0-1480"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-1481" name="__codelineno-0-1481"></a>            <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-1482" name="__codelineno-0-1482"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-1483" name="__codelineno-0-1483"></a>            <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-1484" name="__codelineno-0-1484"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-1485" name="__codelineno-0-1485"></a>
<a id="__codelineno-0-1486" name="__codelineno-0-1486"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1487" name="__codelineno-0-1487"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Unit </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">units</span><span class="p">)</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1488" name="__codelineno-0-1488"></a>            <span class="k">if</span> <span class="n">context</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1489" name="__codelineno-0-1489"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s2">Context:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1490" name="__codelineno-0-1490"></a>
<a id="__codelineno-0-1491" name="__codelineno-0-1491"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Extraction:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1492" name="__codelineno-0-1492"></a>
<a id="__codelineno-0-1493" name="__codelineno-0-1493"></a>
<a id="__codelineno-0-1494" name="__codelineno-0-1494"></a>        <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-1495" name="__codelineno-0-1495"></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
<a id="__codelineno-0-1496" name="__codelineno-0-1496"></a>                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
<a id="__codelineno-0-1497" name="__codelineno-0-1497"></a>                        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1498" name="__codelineno-0-1498"></a>                        <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1499" name="__codelineno-0-1499"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1500" name="__codelineno-0-1500"></a>
<a id="__codelineno-0-1501" name="__codelineno-0-1501"></a>        <span class="c1"># &lt;--- Review step ---&gt;</span>
<a id="__codelineno-0-1502" name="__codelineno-0-1502"></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-1503" name="__codelineno-0-1503"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s2">Review:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1504" name="__codelineno-0-1504"></a>
<a id="__codelineno-0-1505" name="__codelineno-0-1505"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">initial</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]})</span>
<a id="__codelineno-0-1506" name="__codelineno-0-1506"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1507" name="__codelineno-0-1507"></a>
<a id="__codelineno-0-1508" name="__codelineno-0-1508"></a>        <span class="n">review</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-1509" name="__codelineno-0-1509"></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
<a id="__codelineno-0-1510" name="__codelineno-0-1510"></a>                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
<a id="__codelineno-0-1511" name="__codelineno-0-1511"></a>                        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-1512" name="__codelineno-0-1512"></a>                        <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1513" name="__codelineno-0-1513"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1514" name="__codelineno-0-1514"></a>
<a id="__codelineno-0-1515" name="__codelineno-0-1515"></a>        <span class="c1"># Output</span>
<a id="__codelineno-0-1516" name="__codelineno-0-1516"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span> <span class="o">==</span> <span class="s2">&quot;revision&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1517" name="__codelineno-0-1517"></a>            <span class="n">gen_text</span> <span class="o">=</span> <span class="n">review</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1518" name="__codelineno-0-1518"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span> <span class="o">==</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1519" name="__codelineno-0-1519"></a>            <span class="n">gen_text</span> <span class="o">=</span> <span class="n">initial</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">review</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1520" name="__codelineno-0-1520"></a>
<a id="__codelineno-0-1521" name="__codelineno-0-1521"></a>        <span class="c1"># add generated text to unit</span>
<a id="__codelineno-0-1522" name="__codelineno-0-1522"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">gen_text</span><span class="p">)</span>
<a id="__codelineno-0-1523" name="__codelineno-0-1523"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1524" name="__codelineno-0-1524"></a>
<a id="__codelineno-0-1525" name="__codelineno-0-1525"></a>    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-1526" name="__codelineno-0-1526"></a>        <span class="k">return</span> <span class="n">units</span><span class="p">,</span> <span class="n">messages_logger</span><span class="o">.</span><span class="n">get_messages_log</span><span class="p">()</span>
<a id="__codelineno-0-1527" name="__codelineno-0-1527"></a>
<a id="__codelineno-0-1528" name="__codelineno-0-1528"></a>    <span class="k">return</span> <span class="n">units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.ReviewFrameExtractor.stream" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">stream</span>


</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">stream</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This method inputs a text and outputs a list of outputs per unit.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template. 
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is. 
    If text_content is str, this parameter will be ignored.</p>
<p>Return : List[FrameExtractionUnitResult]
    the output from LLM for each unit. Contains the start, end, text, and generated text.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1531">1531</a></span>
<span class="normal"><a href="#__codelineno-0-1532">1532</a></span>
<span class="normal"><a href="#__codelineno-0-1533">1533</a></span>
<span class="normal"><a href="#__codelineno-0-1534">1534</a></span>
<span class="normal"><a href="#__codelineno-0-1535">1535</a></span>
<span class="normal"><a href="#__codelineno-0-1536">1536</a></span>
<span class="normal"><a href="#__codelineno-0-1537">1537</a></span>
<span class="normal"><a href="#__codelineno-0-1538">1538</a></span>
<span class="normal"><a href="#__codelineno-0-1539">1539</a></span>
<span class="normal"><a href="#__codelineno-0-1540">1540</a></span>
<span class="normal"><a href="#__codelineno-0-1541">1541</a></span>
<span class="normal"><a href="#__codelineno-0-1542">1542</a></span>
<span class="normal"><a href="#__codelineno-0-1543">1543</a></span>
<span class="normal"><a href="#__codelineno-0-1544">1544</a></span>
<span class="normal"><a href="#__codelineno-0-1545">1545</a></span>
<span class="normal"><a href="#__codelineno-0-1546">1546</a></span>
<span class="normal"><a href="#__codelineno-0-1547">1547</a></span>
<span class="normal"><a href="#__codelineno-0-1548">1548</a></span>
<span class="normal"><a href="#__codelineno-0-1549">1549</a></span>
<span class="normal"><a href="#__codelineno-0-1550">1550</a></span>
<span class="normal"><a href="#__codelineno-0-1551">1551</a></span>
<span class="normal"><a href="#__codelineno-0-1552">1552</a></span>
<span class="normal"><a href="#__codelineno-0-1553">1553</a></span>
<span class="normal"><a href="#__codelineno-0-1554">1554</a></span>
<span class="normal"><a href="#__codelineno-0-1555">1555</a></span>
<span class="normal"><a href="#__codelineno-0-1556">1556</a></span>
<span class="normal"><a href="#__codelineno-0-1557">1557</a></span>
<span class="normal"><a href="#__codelineno-0-1558">1558</a></span>
<span class="normal"><a href="#__codelineno-0-1559">1559</a></span>
<span class="normal"><a href="#__codelineno-0-1560">1560</a></span>
<span class="normal"><a href="#__codelineno-0-1561">1561</a></span>
<span class="normal"><a href="#__codelineno-0-1562">1562</a></span>
<span class="normal"><a href="#__codelineno-0-1563">1563</a></span>
<span class="normal"><a href="#__codelineno-0-1564">1564</a></span>
<span class="normal"><a href="#__codelineno-0-1565">1565</a></span>
<span class="normal"><a href="#__codelineno-0-1566">1566</a></span>
<span class="normal"><a href="#__codelineno-0-1567">1567</a></span>
<span class="normal"><a href="#__codelineno-0-1568">1568</a></span>
<span class="normal"><a href="#__codelineno-0-1569">1569</a></span>
<span class="normal"><a href="#__codelineno-0-1570">1570</a></span>
<span class="normal"><a href="#__codelineno-0-1571">1571</a></span>
<span class="normal"><a href="#__codelineno-0-1572">1572</a></span>
<span class="normal"><a href="#__codelineno-0-1573">1573</a></span>
<span class="normal"><a href="#__codelineno-0-1574">1574</a></span>
<span class="normal"><a href="#__codelineno-0-1575">1575</a></span>
<span class="normal"><a href="#__codelineno-0-1576">1576</a></span>
<span class="normal"><a href="#__codelineno-0-1577">1577</a></span>
<span class="normal"><a href="#__codelineno-0-1578">1578</a></span>
<span class="normal"><a href="#__codelineno-0-1579">1579</a></span>
<span class="normal"><a href="#__codelineno-0-1580">1580</a></span>
<span class="normal"><a href="#__codelineno-0-1581">1581</a></span>
<span class="normal"><a href="#__codelineno-0-1582">1582</a></span>
<span class="normal"><a href="#__codelineno-0-1583">1583</a></span>
<span class="normal"><a href="#__codelineno-0-1584">1584</a></span>
<span class="normal"><a href="#__codelineno-0-1585">1585</a></span>
<span class="normal"><a href="#__codelineno-0-1586">1586</a></span>
<span class="normal"><a href="#__codelineno-0-1587">1587</a></span>
<span class="normal"><a href="#__codelineno-0-1588">1588</a></span>
<span class="normal"><a href="#__codelineno-0-1589">1589</a></span>
<span class="normal"><a href="#__codelineno-0-1590">1590</a></span>
<span class="normal"><a href="#__codelineno-0-1591">1591</a></span>
<span class="normal"><a href="#__codelineno-0-1592">1592</a></span>
<span class="normal"><a href="#__codelineno-0-1593">1593</a></span>
<span class="normal"><a href="#__codelineno-0-1594">1594</a></span>
<span class="normal"><a href="#__codelineno-0-1595">1595</a></span>
<span class="normal"><a href="#__codelineno-0-1596">1596</a></span>
<span class="normal"><a href="#__codelineno-0-1597">1597</a></span>
<span class="normal"><a href="#__codelineno-0-1598">1598</a></span>
<span class="normal"><a href="#__codelineno-0-1599">1599</a></span>
<span class="normal"><a href="#__codelineno-0-1600">1600</a></span>
<span class="normal"><a href="#__codelineno-0-1601">1601</a></span>
<span class="normal"><a href="#__codelineno-0-1602">1602</a></span>
<span class="normal"><a href="#__codelineno-0-1603">1603</a></span>
<span class="normal"><a href="#__codelineno-0-1604">1604</a></span>
<span class="normal"><a href="#__codelineno-0-1605">1605</a></span>
<span class="normal"><a href="#__codelineno-0-1606">1606</a></span>
<span class="normal"><a href="#__codelineno-0-1607">1607</a></span>
<span class="normal"><a href="#__codelineno-0-1608">1608</a></span>
<span class="normal"><a href="#__codelineno-0-1609">1609</a></span>
<span class="normal"><a href="#__codelineno-0-1610">1610</a></span>
<span class="normal"><a href="#__codelineno-0-1611">1611</a></span>
<span class="normal"><a href="#__codelineno-0-1612">1612</a></span>
<span class="normal"><a href="#__codelineno-0-1613">1613</a></span>
<span class="normal"><a href="#__codelineno-0-1614">1614</a></span>
<span class="normal"><a href="#__codelineno-0-1615">1615</a></span>
<span class="normal"><a href="#__codelineno-0-1616">1616</a></span>
<span class="normal"><a href="#__codelineno-0-1617">1617</a></span>
<span class="normal"><a href="#__codelineno-0-1618">1618</a></span>
<span class="normal"><a href="#__codelineno-0-1619">1619</a></span>
<span class="normal"><a href="#__codelineno-0-1620">1620</a></span>
<span class="normal"><a href="#__codelineno-0-1621">1621</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1531" name="__codelineno-0-1531"></a><span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<a id="__codelineno-0-1532" name="__codelineno-0-1532"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1533" name="__codelineno-0-1533"></a><span class="sd">    This method inputs a text and outputs a list of outputs per unit.</span>
<a id="__codelineno-0-1534" name="__codelineno-0-1534"></a>
<a id="__codelineno-0-1535" name="__codelineno-0-1535"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1536" name="__codelineno-0-1536"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1537" name="__codelineno-0-1537"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-1538" name="__codelineno-0-1538"></a><span class="sd">        the input text content to put in prompt template. </span>
<a id="__codelineno-0-1539" name="__codelineno-0-1539"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-1540" name="__codelineno-0-1540"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-1541" name="__codelineno-0-1541"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-1542" name="__codelineno-0-1542"></a><span class="sd">        specify the key in text_content where document text is. </span>
<a id="__codelineno-0-1543" name="__codelineno-0-1543"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-1544" name="__codelineno-0-1544"></a>
<a id="__codelineno-0-1545" name="__codelineno-0-1545"></a><span class="sd">    Return : List[FrameExtractionUnitResult]</span>
<a id="__codelineno-0-1546" name="__codelineno-0-1546"></a><span class="sd">        the output from LLM for each unit. Contains the start, end, text, and generated text.</span>
<a id="__codelineno-0-1547" name="__codelineno-0-1547"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1548" name="__codelineno-0-1548"></a>    <span class="c1"># unit chunking</span>
<a id="__codelineno-0-1549" name="__codelineno-0-1549"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1550" name="__codelineno-0-1550"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-1551" name="__codelineno-0-1551"></a>
<a id="__codelineno-0-1552" name="__codelineno-0-1552"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-1553" name="__codelineno-0-1553"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1554" name="__codelineno-0-1554"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1555" name="__codelineno-0-1555"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-1556" name="__codelineno-0-1556"></a>
<a id="__codelineno-0-1557" name="__codelineno-0-1557"></a>    <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-1558" name="__codelineno-0-1558"></a>    <span class="c1"># context chunker init</span>
<a id="__codelineno-0-1559" name="__codelineno-0-1559"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-1560" name="__codelineno-0-1560"></a>
<a id="__codelineno-0-1561" name="__codelineno-0-1561"></a>    <span class="c1"># generate unit by unit</span>
<a id="__codelineno-0-1562" name="__codelineno-0-1562"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-1563" name="__codelineno-0-1563"></a>        <span class="c1"># &lt;--- Initial generation step ---&gt;</span>
<a id="__codelineno-0-1564" name="__codelineno-0-1564"></a>        <span class="c1"># construct chat messages</span>
<a id="__codelineno-0-1565" name="__codelineno-0-1565"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1566" name="__codelineno-0-1566"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-1567" name="__codelineno-0-1567"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1568" name="__codelineno-0-1568"></a>
<a id="__codelineno-0-1569" name="__codelineno-0-1569"></a>        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-1570" name="__codelineno-0-1570"></a>
<a id="__codelineno-0-1571" name="__codelineno-0-1571"></a>        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1572" name="__codelineno-0-1572"></a>            <span class="c1"># no context, just place unit in user prompt</span>
<a id="__codelineno-0-1573" name="__codelineno-0-1573"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1574" name="__codelineno-0-1574"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-1575" name="__codelineno-0-1575"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1576" name="__codelineno-0-1576"></a>                <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1577" name="__codelineno-0-1577"></a>                <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-1578" name="__codelineno-0-1578"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-1579" name="__codelineno-0-1579"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1580" name="__codelineno-0-1580"></a>            <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-1581" name="__codelineno-0-1581"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1582" name="__codelineno-0-1582"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-1583" name="__codelineno-0-1583"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1584" name="__codelineno-0-1584"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1585" name="__codelineno-0-1585"></a>                <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-1586" name="__codelineno-0-1586"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-1587" name="__codelineno-0-1587"></a>            <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-1588" name="__codelineno-0-1588"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-1589" name="__codelineno-0-1589"></a>            <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-1590" name="__codelineno-0-1590"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-1591" name="__codelineno-0-1591"></a>
<a id="__codelineno-0-1592" name="__codelineno-0-1592"></a>
<a id="__codelineno-0-1593" name="__codelineno-0-1593"></a>        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">GREEN</span><span class="si">}</span><span class="s2">Unit </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1594" name="__codelineno-0-1594"></a>        <span class="k">if</span> <span class="n">context</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1595" name="__codelineno-0-1595"></a>            <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s2">Context:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">context</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1596" name="__codelineno-0-1596"></a>
<a id="__codelineno-0-1597" name="__codelineno-0-1597"></a>        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">BLUE</span><span class="si">}</span><span class="s2">Extraction:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1598" name="__codelineno-0-1598"></a>
<a id="__codelineno-0-1599" name="__codelineno-0-1599"></a>        <span class="n">response_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-1600" name="__codelineno-0-1600"></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
<a id="__codelineno-0-1601" name="__codelineno-0-1601"></a>                        <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-1602" name="__codelineno-0-1602"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1603" name="__codelineno-0-1603"></a>
<a id="__codelineno-0-1604" name="__codelineno-0-1604"></a>        <span class="n">initial</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<a id="__codelineno-0-1605" name="__codelineno-0-1605"></a>        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response_stream</span><span class="p">:</span>
<a id="__codelineno-0-1606" name="__codelineno-0-1606"></a>            <span class="n">initial</span> <span class="o">+=</span> <span class="n">chunk</span>
<a id="__codelineno-0-1607" name="__codelineno-0-1607"></a>            <span class="k">yield</span> <span class="n">chunk</span>
<a id="__codelineno-0-1608" name="__codelineno-0-1608"></a>
<a id="__codelineno-0-1609" name="__codelineno-0-1609"></a>        <span class="c1"># &lt;--- Review step ---&gt;</span>
<a id="__codelineno-0-1610" name="__codelineno-0-1610"></a>        <span class="k">yield</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">Fore</span><span class="o">.</span><span class="n">YELLOW</span><span class="si">}</span><span class="s2">Review:</span><span class="si">{</span><span class="n">Style</span><span class="o">.</span><span class="n">RESET_ALL</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-1611" name="__codelineno-0-1611"></a>
<a id="__codelineno-0-1612" name="__codelineno-0-1612"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">initial</span><span class="p">})</span>
<a id="__codelineno-0-1613" name="__codelineno-0-1613"></a>        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1614" name="__codelineno-0-1614"></a>
<a id="__codelineno-0-1615" name="__codelineno-0-1615"></a>        <span class="n">response_stream</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat</span><span class="p">(</span>
<a id="__codelineno-0-1616" name="__codelineno-0-1616"></a>                        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span> 
<a id="__codelineno-0-1617" name="__codelineno-0-1617"></a>                        <span class="n">stream</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-1618" name="__codelineno-0-1618"></a>                    <span class="p">)</span>
<a id="__codelineno-0-1619" name="__codelineno-0-1619"></a>
<a id="__codelineno-0-1620" name="__codelineno-0-1620"></a>        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response_stream</span><span class="p">:</span>
<a id="__codelineno-0-1621" name="__codelineno-0-1621"></a>            <span class="k">yield</span> <span class="n">chunk</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_ie.extractors.ReviewFrameExtractor.extract_async" class="doc doc-heading">
            <span class="doc doc-object-name doc-function-name">extract_async</span>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">extract_async</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">text_content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">document_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">concurrent_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">return_messages_log</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="o">**</span><span class="n">kwrs</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]</span>
</code></pre></div>

    <div class="doc doc-contents ">

        <p>This is the asynchronous version of the extract() method with the review step.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>text_content : Union[str, Dict[str,str]]
    the input text content to put in prompt template.
    If str, the prompt template must has only 1 placeholder {{<placeholder name>}}, regardless of placeholder name.
    If dict, all the keys must be included in the prompt template placeholder {{<placeholder name>}}.
document_key : str, Optional
    specify the key in text_content where document text is.
    If text_content is str, this parameter will be ignored.
concurrent_batch_size : int, Optional
    the batch size for concurrent processing.
return_messages_log : bool, Optional
    if True, a list of messages will be returned, including review steps.</p>
<p>Return : List[FrameExtractionUnitResult]
    the output from LLM for each unit after review. Contains the start, end, text, and generated text.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1623">1623</a></span>
<span class="normal"><a href="#__codelineno-0-1624">1624</a></span>
<span class="normal"><a href="#__codelineno-0-1625">1625</a></span>
<span class="normal"><a href="#__codelineno-0-1626">1626</a></span>
<span class="normal"><a href="#__codelineno-0-1627">1627</a></span>
<span class="normal"><a href="#__codelineno-0-1628">1628</a></span>
<span class="normal"><a href="#__codelineno-0-1629">1629</a></span>
<span class="normal"><a href="#__codelineno-0-1630">1630</a></span>
<span class="normal"><a href="#__codelineno-0-1631">1631</a></span>
<span class="normal"><a href="#__codelineno-0-1632">1632</a></span>
<span class="normal"><a href="#__codelineno-0-1633">1633</a></span>
<span class="normal"><a href="#__codelineno-0-1634">1634</a></span>
<span class="normal"><a href="#__codelineno-0-1635">1635</a></span>
<span class="normal"><a href="#__codelineno-0-1636">1636</a></span>
<span class="normal"><a href="#__codelineno-0-1637">1637</a></span>
<span class="normal"><a href="#__codelineno-0-1638">1638</a></span>
<span class="normal"><a href="#__codelineno-0-1639">1639</a></span>
<span class="normal"><a href="#__codelineno-0-1640">1640</a></span>
<span class="normal"><a href="#__codelineno-0-1641">1641</a></span>
<span class="normal"><a href="#__codelineno-0-1642">1642</a></span>
<span class="normal"><a href="#__codelineno-0-1643">1643</a></span>
<span class="normal"><a href="#__codelineno-0-1644">1644</a></span>
<span class="normal"><a href="#__codelineno-0-1645">1645</a></span>
<span class="normal"><a href="#__codelineno-0-1646">1646</a></span>
<span class="normal"><a href="#__codelineno-0-1647">1647</a></span>
<span class="normal"><a href="#__codelineno-0-1648">1648</a></span>
<span class="normal"><a href="#__codelineno-0-1649">1649</a></span>
<span class="normal"><a href="#__codelineno-0-1650">1650</a></span>
<span class="normal"><a href="#__codelineno-0-1651">1651</a></span>
<span class="normal"><a href="#__codelineno-0-1652">1652</a></span>
<span class="normal"><a href="#__codelineno-0-1653">1653</a></span>
<span class="normal"><a href="#__codelineno-0-1654">1654</a></span>
<span class="normal"><a href="#__codelineno-0-1655">1655</a></span>
<span class="normal"><a href="#__codelineno-0-1656">1656</a></span>
<span class="normal"><a href="#__codelineno-0-1657">1657</a></span>
<span class="normal"><a href="#__codelineno-0-1658">1658</a></span>
<span class="normal"><a href="#__codelineno-0-1659">1659</a></span>
<span class="normal"><a href="#__codelineno-0-1660">1660</a></span>
<span class="normal"><a href="#__codelineno-0-1661">1661</a></span>
<span class="normal"><a href="#__codelineno-0-1662">1662</a></span>
<span class="normal"><a href="#__codelineno-0-1663">1663</a></span>
<span class="normal"><a href="#__codelineno-0-1664">1664</a></span>
<span class="normal"><a href="#__codelineno-0-1665">1665</a></span>
<span class="normal"><a href="#__codelineno-0-1666">1666</a></span>
<span class="normal"><a href="#__codelineno-0-1667">1667</a></span>
<span class="normal"><a href="#__codelineno-0-1668">1668</a></span>
<span class="normal"><a href="#__codelineno-0-1669">1669</a></span>
<span class="normal"><a href="#__codelineno-0-1670">1670</a></span>
<span class="normal"><a href="#__codelineno-0-1671">1671</a></span>
<span class="normal"><a href="#__codelineno-0-1672">1672</a></span>
<span class="normal"><a href="#__codelineno-0-1673">1673</a></span>
<span class="normal"><a href="#__codelineno-0-1674">1674</a></span>
<span class="normal"><a href="#__codelineno-0-1675">1675</a></span>
<span class="normal"><a href="#__codelineno-0-1676">1676</a></span>
<span class="normal"><a href="#__codelineno-0-1677">1677</a></span>
<span class="normal"><a href="#__codelineno-0-1678">1678</a></span>
<span class="normal"><a href="#__codelineno-0-1679">1679</a></span>
<span class="normal"><a href="#__codelineno-0-1680">1680</a></span>
<span class="normal"><a href="#__codelineno-0-1681">1681</a></span>
<span class="normal"><a href="#__codelineno-0-1682">1682</a></span>
<span class="normal"><a href="#__codelineno-0-1683">1683</a></span>
<span class="normal"><a href="#__codelineno-0-1684">1684</a></span>
<span class="normal"><a href="#__codelineno-0-1685">1685</a></span>
<span class="normal"><a href="#__codelineno-0-1686">1686</a></span>
<span class="normal"><a href="#__codelineno-0-1687">1687</a></span>
<span class="normal"><a href="#__codelineno-0-1688">1688</a></span>
<span class="normal"><a href="#__codelineno-0-1689">1689</a></span>
<span class="normal"><a href="#__codelineno-0-1690">1690</a></span>
<span class="normal"><a href="#__codelineno-0-1691">1691</a></span>
<span class="normal"><a href="#__codelineno-0-1692">1692</a></span>
<span class="normal"><a href="#__codelineno-0-1693">1693</a></span>
<span class="normal"><a href="#__codelineno-0-1694">1694</a></span>
<span class="normal"><a href="#__codelineno-0-1695">1695</a></span>
<span class="normal"><a href="#__codelineno-0-1696">1696</a></span>
<span class="normal"><a href="#__codelineno-0-1697">1697</a></span>
<span class="normal"><a href="#__codelineno-0-1698">1698</a></span>
<span class="normal"><a href="#__codelineno-0-1699">1699</a></span>
<span class="normal"><a href="#__codelineno-0-1700">1700</a></span>
<span class="normal"><a href="#__codelineno-0-1701">1701</a></span>
<span class="normal"><a href="#__codelineno-0-1702">1702</a></span>
<span class="normal"><a href="#__codelineno-0-1703">1703</a></span>
<span class="normal"><a href="#__codelineno-0-1704">1704</a></span>
<span class="normal"><a href="#__codelineno-0-1705">1705</a></span>
<span class="normal"><a href="#__codelineno-0-1706">1706</a></span>
<span class="normal"><a href="#__codelineno-0-1707">1707</a></span>
<span class="normal"><a href="#__codelineno-0-1708">1708</a></span>
<span class="normal"><a href="#__codelineno-0-1709">1709</a></span>
<span class="normal"><a href="#__codelineno-0-1710">1710</a></span>
<span class="normal"><a href="#__codelineno-0-1711">1711</a></span>
<span class="normal"><a href="#__codelineno-0-1712">1712</a></span>
<span class="normal"><a href="#__codelineno-0-1713">1713</a></span>
<span class="normal"><a href="#__codelineno-0-1714">1714</a></span>
<span class="normal"><a href="#__codelineno-0-1715">1715</a></span>
<span class="normal"><a href="#__codelineno-0-1716">1716</a></span>
<span class="normal"><a href="#__codelineno-0-1717">1717</a></span>
<span class="normal"><a href="#__codelineno-0-1718">1718</a></span>
<span class="normal"><a href="#__codelineno-0-1719">1719</a></span>
<span class="normal"><a href="#__codelineno-0-1720">1720</a></span>
<span class="normal"><a href="#__codelineno-0-1721">1721</a></span>
<span class="normal"><a href="#__codelineno-0-1722">1722</a></span>
<span class="normal"><a href="#__codelineno-0-1723">1723</a></span>
<span class="normal"><a href="#__codelineno-0-1724">1724</a></span>
<span class="normal"><a href="#__codelineno-0-1725">1725</a></span>
<span class="normal"><a href="#__codelineno-0-1726">1726</a></span>
<span class="normal"><a href="#__codelineno-0-1727">1727</a></span>
<span class="normal"><a href="#__codelineno-0-1728">1728</a></span>
<span class="normal"><a href="#__codelineno-0-1729">1729</a></span>
<span class="normal"><a href="#__codelineno-0-1730">1730</a></span>
<span class="normal"><a href="#__codelineno-0-1731">1731</a></span>
<span class="normal"><a href="#__codelineno-0-1732">1732</a></span>
<span class="normal"><a href="#__codelineno-0-1733">1733</a></span>
<span class="normal"><a href="#__codelineno-0-1734">1734</a></span>
<span class="normal"><a href="#__codelineno-0-1735">1735</a></span>
<span class="normal"><a href="#__codelineno-0-1736">1736</a></span>
<span class="normal"><a href="#__codelineno-0-1737">1737</a></span>
<span class="normal"><a href="#__codelineno-0-1738">1738</a></span>
<span class="normal"><a href="#__codelineno-0-1739">1739</a></span>
<span class="normal"><a href="#__codelineno-0-1740">1740</a></span>
<span class="normal"><a href="#__codelineno-0-1741">1741</a></span>
<span class="normal"><a href="#__codelineno-0-1742">1742</a></span>
<span class="normal"><a href="#__codelineno-0-1743">1743</a></span>
<span class="normal"><a href="#__codelineno-0-1744">1744</a></span>
<span class="normal"><a href="#__codelineno-0-1745">1745</a></span>
<span class="normal"><a href="#__codelineno-0-1746">1746</a></span>
<span class="normal"><a href="#__codelineno-0-1747">1747</a></span>
<span class="normal"><a href="#__codelineno-0-1748">1748</a></span>
<span class="normal"><a href="#__codelineno-0-1749">1749</a></span>
<span class="normal"><a href="#__codelineno-0-1750">1750</a></span>
<span class="normal"><a href="#__codelineno-0-1751">1751</a></span>
<span class="normal"><a href="#__codelineno-0-1752">1752</a></span>
<span class="normal"><a href="#__codelineno-0-1753">1753</a></span>
<span class="normal"><a href="#__codelineno-0-1754">1754</a></span>
<span class="normal"><a href="#__codelineno-0-1755">1755</a></span>
<span class="normal"><a href="#__codelineno-0-1756">1756</a></span>
<span class="normal"><a href="#__codelineno-0-1757">1757</a></span>
<span class="normal"><a href="#__codelineno-0-1758">1758</a></span>
<span class="normal"><a href="#__codelineno-0-1759">1759</a></span>
<span class="normal"><a href="#__codelineno-0-1760">1760</a></span>
<span class="normal"><a href="#__codelineno-0-1761">1761</a></span>
<span class="normal"><a href="#__codelineno-0-1762">1762</a></span>
<span class="normal"><a href="#__codelineno-0-1763">1763</a></span>
<span class="normal"><a href="#__codelineno-0-1764">1764</a></span>
<span class="normal"><a href="#__codelineno-0-1765">1765</a></span>
<span class="normal"><a href="#__codelineno-0-1766">1766</a></span>
<span class="normal"><a href="#__codelineno-0-1767">1767</a></span>
<span class="normal"><a href="#__codelineno-0-1768">1768</a></span>
<span class="normal"><a href="#__codelineno-0-1769">1769</a></span>
<span class="normal"><a href="#__codelineno-0-1770">1770</a></span>
<span class="normal"><a href="#__codelineno-0-1771">1771</a></span>
<span class="normal"><a href="#__codelineno-0-1772">1772</a></span>
<span class="normal"><a href="#__codelineno-0-1773">1773</a></span>
<span class="normal"><a href="#__codelineno-0-1774">1774</a></span>
<span class="normal"><a href="#__codelineno-0-1775">1775</a></span>
<span class="normal"><a href="#__codelineno-0-1776">1776</a></span>
<span class="normal"><a href="#__codelineno-0-1777">1777</a></span>
<span class="normal"><a href="#__codelineno-0-1778">1778</a></span>
<span class="normal"><a href="#__codelineno-0-1779">1779</a></span>
<span class="normal"><a href="#__codelineno-0-1780">1780</a></span>
<span class="normal"><a href="#__codelineno-0-1781">1781</a></span>
<span class="normal"><a href="#__codelineno-0-1782">1782</a></span>
<span class="normal"><a href="#__codelineno-0-1783">1783</a></span>
<span class="normal"><a href="#__codelineno-0-1784">1784</a></span>
<span class="normal"><a href="#__codelineno-0-1785">1785</a></span>
<span class="normal"><a href="#__codelineno-0-1786">1786</a></span>
<span class="normal"><a href="#__codelineno-0-1787">1787</a></span>
<span class="normal"><a href="#__codelineno-0-1788">1788</a></span>
<span class="normal"><a href="#__codelineno-0-1789">1789</a></span>
<span class="normal"><a href="#__codelineno-0-1790">1790</a></span>
<span class="normal"><a href="#__codelineno-0-1791">1791</a></span>
<span class="normal"><a href="#__codelineno-0-1792">1792</a></span>
<span class="normal"><a href="#__codelineno-0-1793">1793</a></span>
<span class="normal"><a href="#__codelineno-0-1794">1794</a></span>
<span class="normal"><a href="#__codelineno-0-1795">1795</a></span>
<span class="normal"><a href="#__codelineno-0-1796">1796</a></span>
<span class="normal"><a href="#__codelineno-0-1797">1797</a></span>
<span class="normal"><a href="#__codelineno-0-1798">1798</a></span>
<span class="normal"><a href="#__codelineno-0-1799">1799</a></span>
<span class="normal"><a href="#__codelineno-0-1800">1800</a></span>
<span class="normal"><a href="#__codelineno-0-1801">1801</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1623" name="__codelineno-0-1623"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">extract_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text_content</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="n">document_key</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1624" name="__codelineno-0-1624"></a>                        <span class="n">concurrent_batch_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">return_messages_log</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwrs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FrameExtractionUnit</span><span class="p">]:</span>
<a id="__codelineno-0-1625" name="__codelineno-0-1625"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1626" name="__codelineno-0-1626"></a><span class="sd">    This is the asynchronous version of the extract() method with the review step.</span>
<a id="__codelineno-0-1627" name="__codelineno-0-1627"></a>
<a id="__codelineno-0-1628" name="__codelineno-0-1628"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1629" name="__codelineno-0-1629"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1630" name="__codelineno-0-1630"></a><span class="sd">    text_content : Union[str, Dict[str,str]]</span>
<a id="__codelineno-0-1631" name="__codelineno-0-1631"></a><span class="sd">        the input text content to put in prompt template.</span>
<a id="__codelineno-0-1632" name="__codelineno-0-1632"></a><span class="sd">        If str, the prompt template must has only 1 placeholder {{&lt;placeholder name&gt;}}, regardless of placeholder name.</span>
<a id="__codelineno-0-1633" name="__codelineno-0-1633"></a><span class="sd">        If dict, all the keys must be included in the prompt template placeholder {{&lt;placeholder name&gt;}}.</span>
<a id="__codelineno-0-1634" name="__codelineno-0-1634"></a><span class="sd">    document_key : str, Optional</span>
<a id="__codelineno-0-1635" name="__codelineno-0-1635"></a><span class="sd">        specify the key in text_content where document text is.</span>
<a id="__codelineno-0-1636" name="__codelineno-0-1636"></a><span class="sd">        If text_content is str, this parameter will be ignored.</span>
<a id="__codelineno-0-1637" name="__codelineno-0-1637"></a><span class="sd">    concurrent_batch_size : int, Optional</span>
<a id="__codelineno-0-1638" name="__codelineno-0-1638"></a><span class="sd">        the batch size for concurrent processing.</span>
<a id="__codelineno-0-1639" name="__codelineno-0-1639"></a><span class="sd">    return_messages_log : bool, Optional</span>
<a id="__codelineno-0-1640" name="__codelineno-0-1640"></a><span class="sd">        if True, a list of messages will be returned, including review steps.</span>
<a id="__codelineno-0-1641" name="__codelineno-0-1641"></a>
<a id="__codelineno-0-1642" name="__codelineno-0-1642"></a><span class="sd">    Return : List[FrameExtractionUnitResult]</span>
<a id="__codelineno-0-1643" name="__codelineno-0-1643"></a><span class="sd">        the output from LLM for each unit after review. Contains the start, end, text, and generated text.</span>
<a id="__codelineno-0-1644" name="__codelineno-0-1644"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1645" name="__codelineno-0-1645"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1646" name="__codelineno-0-1646"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span>
<a id="__codelineno-0-1647" name="__codelineno-0-1647"></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-1648" name="__codelineno-0-1648"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-1649" name="__codelineno-0-1649"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;document_key must be provided when text_content is dict.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1650" name="__codelineno-0-1650"></a>        <span class="k">if</span> <span class="n">document_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">text_content</span><span class="p">:</span>
<a id="__codelineno-0-1651" name="__codelineno-0-1651"></a>             <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;document_key &#39;</span><span class="si">{</span><span class="n">document_key</span><span class="si">}</span><span class="s2">&#39; not found in text_content dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1652" name="__codelineno-0-1652"></a>        <span class="n">doc_text</span> <span class="o">=</span> <span class="n">text_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span>
<a id="__codelineno-0-1653" name="__codelineno-0-1653"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1654" name="__codelineno-0-1654"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;text_content must be a string or a dictionary.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1655" name="__codelineno-0-1655"></a>
<a id="__codelineno-0-1656" name="__codelineno-0-1656"></a>    <span class="c1"># unit chunking</span>
<a id="__codelineno-0-1657" name="__codelineno-0-1657"></a>    <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">doc_text</span><span class="p">)</span>
<a id="__codelineno-0-1658" name="__codelineno-0-1658"></a>
<a id="__codelineno-0-1659" name="__codelineno-0-1659"></a>    <span class="c1"># context chunker init</span>
<a id="__codelineno-0-1660" name="__codelineno-0-1660"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">doc_text</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
<a id="__codelineno-0-1661" name="__codelineno-0-1661"></a>
<a id="__codelineno-0-1662" name="__codelineno-0-1662"></a>    <span class="c1"># messages logger init</span>
<a id="__codelineno-0-1663" name="__codelineno-0-1663"></a>    <span class="n">messages_logger</span> <span class="o">=</span> <span class="n">MessagesLogger</span><span class="p">()</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-1664" name="__codelineno-0-1664"></a>
<a id="__codelineno-0-1665" name="__codelineno-0-1665"></a>    <span class="c1"># &lt;--- Initial generation step ---&gt;</span>
<a id="__codelineno-0-1666" name="__codelineno-0-1666"></a>    <span class="n">initial_tasks_input</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1667" name="__codelineno-0-1667"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">units</span><span class="p">):</span>
<a id="__codelineno-0-1668" name="__codelineno-0-1668"></a>        <span class="c1"># construct chat messages for initial generation</span>
<a id="__codelineno-0-1669" name="__codelineno-0-1669"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1670" name="__codelineno-0-1670"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">:</span>
<a id="__codelineno-0-1671" name="__codelineno-0-1671"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">system_prompt</span><span class="p">})</span>
<a id="__codelineno-0-1672" name="__codelineno-0-1672"></a>
<a id="__codelineno-0-1673" name="__codelineno-0-1673"></a>        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_chunker</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-0-1674" name="__codelineno-0-1674"></a>
<a id="__codelineno-0-1675" name="__codelineno-0-1675"></a>        <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1676" name="__codelineno-0-1676"></a>             <span class="c1"># no context, just place unit in user prompt</span>
<a id="__codelineno-0-1677" name="__codelineno-0-1677"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1678" name="__codelineno-0-1678"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">)})</span>
<a id="__codelineno-0-1679" name="__codelineno-0-1679"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1680" name="__codelineno-0-1680"></a>                <span class="n">unit_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1681" name="__codelineno-0-1681"></a>                <span class="n">unit_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span>
<a id="__codelineno-0-1682" name="__codelineno-0-1682"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">unit_content</span><span class="p">)})</span>
<a id="__codelineno-0-1683" name="__codelineno-0-1683"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1684" name="__codelineno-0-1684"></a>            <span class="c1"># insert context to user prompt</span>
<a id="__codelineno-0-1685" name="__codelineno-0-1685"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text_content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-1686" name="__codelineno-0-1686"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context</span><span class="p">)})</span>
<a id="__codelineno-0-1687" name="__codelineno-0-1687"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1688" name="__codelineno-0-1688"></a>                <span class="n">context_content</span> <span class="o">=</span> <span class="n">text_content</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-1689" name="__codelineno-0-1689"></a>                <span class="n">context_content</span><span class="p">[</span><span class="n">document_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span>
<a id="__codelineno-0-1690" name="__codelineno-0-1690"></a>                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_user_prompt</span><span class="p">(</span><span class="n">context_content</span><span class="p">)})</span>
<a id="__codelineno-0-1691" name="__codelineno-0-1691"></a>            <span class="c1"># simulate conversation where assistant confirms</span>
<a id="__codelineno-0-1692" name="__codelineno-0-1692"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Sure, please provide the unit text (e.g., sentence, line, chunk) of interest.&#39;</span><span class="p">})</span>
<a id="__codelineno-0-1693" name="__codelineno-0-1693"></a>            <span class="c1"># place unit of interest</span>
<a id="__codelineno-0-1694" name="__codelineno-0-1694"></a>            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>
<a id="__codelineno-0-1695" name="__codelineno-0-1695"></a>
<a id="__codelineno-0-1696" name="__codelineno-0-1696"></a>        <span class="c1"># Store unit and messages together for the initial task</span>
<a id="__codelineno-0-1697" name="__codelineno-0-1697"></a>        <span class="n">initial_tasks_input</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">,</span> <span class="s2">&quot;original_index&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
<a id="__codelineno-0-1698" name="__codelineno-0-1698"></a>
<a id="__codelineno-0-1699" name="__codelineno-0-1699"></a>    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">concurrent_batch_size</span><span class="p">)</span>
<a id="__codelineno-0-1700" name="__codelineno-0-1700"></a>
<a id="__codelineno-0-1701" name="__codelineno-0-1701"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">initial_semaphore_helper</span><span class="p">(</span><span class="n">task_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
<a id="__codelineno-0-1702" name="__codelineno-0-1702"></a>        <span class="n">unit</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1703" name="__codelineno-0-1703"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1704" name="__codelineno-0-1704"></a>        <span class="n">original_index</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1705" name="__codelineno-0-1705"></a>
<a id="__codelineno-0-1706" name="__codelineno-0-1706"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
<a id="__codelineno-0-1707" name="__codelineno-0-1707"></a>            <span class="n">gen_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat_async</span><span class="p">(</span>
<a id="__codelineno-0-1708" name="__codelineno-0-1708"></a>                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
<a id="__codelineno-0-1709" name="__codelineno-0-1709"></a>                <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1710" name="__codelineno-0-1710"></a>            <span class="p">)</span>
<a id="__codelineno-0-1711" name="__codelineno-0-1711"></a>        <span class="c1"># Return initial generation result along with the messages used and the unit</span>
<a id="__codelineno-0-1712" name="__codelineno-0-1712"></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;original_index&quot;</span><span class="p">:</span> <span class="n">original_index</span><span class="p">,</span> <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span> <span class="s2">&quot;initial_gen_text&quot;</span><span class="p">:</span> <span class="n">gen_text</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">],</span> <span class="s2">&quot;initial_messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>
<a id="__codelineno-0-1713" name="__codelineno-0-1713"></a>        <span class="k">if</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">in</span> <span class="n">gen_text</span><span class="p">:</span>
<a id="__codelineno-0-1714" name="__codelineno-0-1714"></a>            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;reasoning&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_text</span><span class="p">[</span><span class="s2">&quot;reasoning&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1715" name="__codelineno-0-1715"></a>        <span class="k">return</span> <span class="n">out</span>
<a id="__codelineno-0-1716" name="__codelineno-0-1716"></a>
<a id="__codelineno-0-1717" name="__codelineno-0-1717"></a>    <span class="c1"># Create and gather initial generation tasks</span>
<a id="__codelineno-0-1718" name="__codelineno-0-1718"></a>    <span class="n">initial_tasks</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-1719" name="__codelineno-0-1719"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">initial_semaphore_helper</span><span class="p">(</span>
<a id="__codelineno-0-1720" name="__codelineno-0-1720"></a>            <span class="n">task_inp</span>
<a id="__codelineno-0-1721" name="__codelineno-0-1721"></a>        <span class="p">))</span>
<a id="__codelineno-0-1722" name="__codelineno-0-1722"></a>        <span class="k">for</span> <span class="n">task_inp</span> <span class="ow">in</span> <span class="n">initial_tasks_input</span>
<a id="__codelineno-0-1723" name="__codelineno-0-1723"></a>    <span class="p">]</span>
<a id="__codelineno-0-1724" name="__codelineno-0-1724"></a>
<a id="__codelineno-0-1725" name="__codelineno-0-1725"></a>    <span class="n">initial_results_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">initial_tasks</span><span class="p">)</span>
<a id="__codelineno-0-1726" name="__codelineno-0-1726"></a>
<a id="__codelineno-0-1727" name="__codelineno-0-1727"></a>    <span class="c1"># Sort initial results back into original order</span>
<a id="__codelineno-0-1728" name="__codelineno-0-1728"></a>    <span class="n">initial_results_raw</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1729" name="__codelineno-0-1729"></a>
<a id="__codelineno-0-1730" name="__codelineno-0-1730"></a>    <span class="c1"># &lt;--- Review step ---&gt;</span>
<a id="__codelineno-0-1731" name="__codelineno-0-1731"></a>    <span class="n">review_tasks_input</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-1732" name="__codelineno-0-1732"></a>    <span class="k">for</span> <span class="n">result_data</span> <span class="ow">in</span> <span class="n">initial_results_raw</span><span class="p">:</span>
<a id="__codelineno-0-1733" name="__codelineno-0-1733"></a>        <span class="c1"># Prepare messages for the review step</span>
<a id="__codelineno-0-1734" name="__codelineno-0-1734"></a>        <span class="n">initial_messages</span> <span class="o">=</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;initial_messages&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1735" name="__codelineno-0-1735"></a>        <span class="n">initial_gen_text</span> <span class="o">=</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;initial_gen_text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1736" name="__codelineno-0-1736"></a>        <span class="n">review_messages</span> <span class="o">=</span> <span class="n">initial_messages</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-0-1737" name="__codelineno-0-1737"></a>            <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">initial_gen_text</span><span class="p">},</span>
<a id="__codelineno-0-1738" name="__codelineno-0-1738"></a>            <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span><span class="p">}</span>
<a id="__codelineno-0-1739" name="__codelineno-0-1739"></a>        <span class="p">]</span>
<a id="__codelineno-0-1740" name="__codelineno-0-1740"></a>        <span class="c1"># Store data needed for review task</span>
<a id="__codelineno-0-1741" name="__codelineno-0-1741"></a>        <span class="k">if</span> <span class="s2">&quot;reasoning&quot;</span> <span class="ow">in</span> <span class="n">result_data</span><span class="p">:</span>
<a id="__codelineno-0-1742" name="__codelineno-0-1742"></a>            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">initial_gen_text</span><span class="p">,</span> <span class="s2">&quot;reasoning&quot;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;reasoning&quot;</span><span class="p">]}</span>
<a id="__codelineno-0-1743" name="__codelineno-0-1743"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1744" name="__codelineno-0-1744"></a>            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">initial_gen_text</span><span class="p">}</span>
<a id="__codelineno-0-1745" name="__codelineno-0-1745"></a>
<a id="__codelineno-0-1746" name="__codelineno-0-1746"></a>        <span class="n">review_tasks_input</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-0-1747" name="__codelineno-0-1747"></a>            <span class="s2">&quot;unit&quot;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1748" name="__codelineno-0-1748"></a>            <span class="s2">&quot;initial_gen_text&quot;</span><span class="p">:</span> <span class="n">initial_gen_text</span><span class="p">,</span>
<a id="__codelineno-0-1749" name="__codelineno-0-1749"></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">review_messages</span><span class="p">,</span> 
<a id="__codelineno-0-1750" name="__codelineno-0-1750"></a>            <span class="s2">&quot;original_index&quot;</span><span class="p">:</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">],</span>
<a id="__codelineno-0-1751" name="__codelineno-0-1751"></a>            <span class="s2">&quot;full_initial_log&quot;</span><span class="p">:</span> <span class="n">initial_messages</span> <span class="o">+</span> <span class="p">[</span><span class="n">message</span><span class="p">]</span> <span class="o">+</span> <span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_prompt</span><span class="p">}]</span> <span class="k">if</span> <span class="n">return_messages_log</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-1752" name="__codelineno-0-1752"></a>        <span class="p">})</span>
<a id="__codelineno-0-1753" name="__codelineno-0-1753"></a>
<a id="__codelineno-0-1754" name="__codelineno-0-1754"></a>
<a id="__codelineno-0-1755" name="__codelineno-0-1755"></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">review_semaphore_helper</span><span class="p">(</span><span class="n">task_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwrs</span><span class="p">):</span>
<a id="__codelineno-0-1756" name="__codelineno-0-1756"></a>        <span class="n">messages</span> <span class="o">=</span> <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]</span> 
<a id="__codelineno-0-1757" name="__codelineno-0-1757"></a>
<a id="__codelineno-0-1758" name="__codelineno-0-1758"></a>        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
<a id="__codelineno-0-1759" name="__codelineno-0-1759"></a>            <span class="n">review_gen_text</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference_engine</span><span class="o">.</span><span class="n">chat_async</span><span class="p">(</span>
<a id="__codelineno-0-1760" name="__codelineno-0-1760"></a>                <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
<a id="__codelineno-0-1761" name="__codelineno-0-1761"></a>                <span class="n">messages_logger</span><span class="o">=</span><span class="n">messages_logger</span>
<a id="__codelineno-0-1762" name="__codelineno-0-1762"></a>            <span class="p">)</span>
<a id="__codelineno-0-1763" name="__codelineno-0-1763"></a>        <span class="c1"># Combine initial and review results</span>
<a id="__codelineno-0-1764" name="__codelineno-0-1764"></a>        <span class="n">task_data</span><span class="p">[</span><span class="s2">&quot;review_gen_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">review_gen_text</span><span class="p">[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1765" name="__codelineno-0-1765"></a>        <span class="k">return</span> <span class="n">task_data</span> <span class="c1"># Return the augmented dictionary</span>
<a id="__codelineno-0-1766" name="__codelineno-0-1766"></a>
<a id="__codelineno-0-1767" name="__codelineno-0-1767"></a>    <span class="c1"># Create and gather review tasks</span>
<a id="__codelineno-0-1768" name="__codelineno-0-1768"></a>    <span class="n">review_tasks</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-1769" name="__codelineno-0-1769"></a>         <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">review_semaphore_helper</span><span class="p">(</span>
<a id="__codelineno-0-1770" name="__codelineno-0-1770"></a>            <span class="n">task_inp</span>
<a id="__codelineno-0-1771" name="__codelineno-0-1771"></a>        <span class="p">))</span>
<a id="__codelineno-0-1772" name="__codelineno-0-1772"></a>       <span class="k">for</span> <span class="n">task_inp</span> <span class="ow">in</span> <span class="n">review_tasks_input</span>
<a id="__codelineno-0-1773" name="__codelineno-0-1773"></a>    <span class="p">]</span>
<a id="__codelineno-0-1774" name="__codelineno-0-1774"></a>
<a id="__codelineno-0-1775" name="__codelineno-0-1775"></a>    <span class="n">final_results_raw</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">review_tasks</span><span class="p">)</span>
<a id="__codelineno-0-1776" name="__codelineno-0-1776"></a>
<a id="__codelineno-0-1777" name="__codelineno-0-1777"></a>    <span class="c1"># Sort final results back into original order (although gather might preserve order for tasks added sequentially)</span>
<a id="__codelineno-0-1778" name="__codelineno-0-1778"></a>    <span class="n">final_results_raw</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;original_index&quot;</span><span class="p">])</span>
<a id="__codelineno-0-1779" name="__codelineno-0-1779"></a>
<a id="__codelineno-0-1780" name="__codelineno-0-1780"></a>    <span class="c1"># &lt;--- Process final results ---&gt;</span>
<a id="__codelineno-0-1781" name="__codelineno-0-1781"></a>    <span class="k">for</span> <span class="n">result_data</span> <span class="ow">in</span> <span class="n">final_results_raw</span><span class="p">:</span>
<a id="__codelineno-0-1782" name="__codelineno-0-1782"></a>        <span class="n">unit</span> <span class="o">=</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1783" name="__codelineno-0-1783"></a>        <span class="n">initial_gen</span> <span class="o">=</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;initial_gen_text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1784" name="__codelineno-0-1784"></a>        <span class="n">review_gen</span> <span class="o">=</span> <span class="n">result_data</span><span class="p">[</span><span class="s2">&quot;review_gen_text&quot;</span><span class="p">]</span>
<a id="__codelineno-0-1785" name="__codelineno-0-1785"></a>
<a id="__codelineno-0-1786" name="__codelineno-0-1786"></a>        <span class="c1"># Combine based on review mode</span>
<a id="__codelineno-0-1787" name="__codelineno-0-1787"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span> <span class="o">==</span> <span class="s2">&quot;revision&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1788" name="__codelineno-0-1788"></a>            <span class="n">final_gen_text</span> <span class="o">=</span> <span class="n">review_gen</span>
<a id="__codelineno-0-1789" name="__codelineno-0-1789"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">review_mode</span> <span class="o">==</span> <span class="s2">&quot;addition&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1790" name="__codelineno-0-1790"></a>            <span class="n">final_gen_text</span> <span class="o">=</span> <span class="n">initial_gen</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">review_gen</span>
<a id="__codelineno-0-1791" name="__codelineno-0-1791"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># Should not happen due to init check</span>
<a id="__codelineno-0-1792" name="__codelineno-0-1792"></a>            <span class="n">final_gen_text</span> <span class="o">=</span> <span class="n">review_gen</span> <span class="c1"># Default to revision if mode is somehow invalid</span>
<a id="__codelineno-0-1793" name="__codelineno-0-1793"></a>
<a id="__codelineno-0-1794" name="__codelineno-0-1794"></a>        <span class="c1"># Create final result object</span>
<a id="__codelineno-0-1795" name="__codelineno-0-1795"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_generated_text</span><span class="p">(</span><span class="n">final_gen_text</span><span class="p">)</span>
<a id="__codelineno-0-1796" name="__codelineno-0-1796"></a>        <span class="n">unit</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1797" name="__codelineno-0-1797"></a>
<a id="__codelineno-0-1798" name="__codelineno-0-1798"></a>    <span class="k">if</span> <span class="n">return_messages_log</span><span class="p">:</span>
<a id="__codelineno-0-1799" name="__codelineno-0-1799"></a>        <span class="k">return</span> <span class="n">units</span><span class="p">,</span> <span class="n">messages_logger</span><span class="o">.</span><span class="n">get_messages_log</span><span class="p">()</span>
<a id="__codelineno-0-1800" name="__codelineno-0-1800"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-1801" name="__codelineno-0-1801"></a>        <span class="k">return</span> <span class="n">units</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h3 id="convenience-frame-extractors">Convenience Frame Extractors</h3>


<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.BasicFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.BasicFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">BasicFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llm_ie.extractors.DirectFrameExtractor" href="#llm_ie.extractors.DirectFrameExtractor">DirectFrameExtractor</a></code></p>


        <p>This class diretly prompt LLM for frame extraction.
Input system prompt (optional), prompt template (with instruction, few-shot examples), 
and specify a LLM.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
system_prompt : str, Optional
    system prompt.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1805">1805</a></span>
<span class="normal"><a href="#__codelineno-0-1806">1806</a></span>
<span class="normal"><a href="#__codelineno-0-1807">1807</a></span>
<span class="normal"><a href="#__codelineno-0-1808">1808</a></span>
<span class="normal"><a href="#__codelineno-0-1809">1809</a></span>
<span class="normal"><a href="#__codelineno-0-1810">1810</a></span>
<span class="normal"><a href="#__codelineno-0-1811">1811</a></span>
<span class="normal"><a href="#__codelineno-0-1812">1812</a></span>
<span class="normal"><a href="#__codelineno-0-1813">1813</a></span>
<span class="normal"><a href="#__codelineno-0-1814">1814</a></span>
<span class="normal"><a href="#__codelineno-0-1815">1815</a></span>
<span class="normal"><a href="#__codelineno-0-1816">1816</a></span>
<span class="normal"><a href="#__codelineno-0-1817">1817</a></span>
<span class="normal"><a href="#__codelineno-0-1818">1818</a></span>
<span class="normal"><a href="#__codelineno-0-1819">1819</a></span>
<span class="normal"><a href="#__codelineno-0-1820">1820</a></span>
<span class="normal"><a href="#__codelineno-0-1821">1821</a></span>
<span class="normal"><a href="#__codelineno-0-1822">1822</a></span>
<span class="normal"><a href="#__codelineno-0-1823">1823</a></span>
<span class="normal"><a href="#__codelineno-0-1824">1824</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1805" name="__codelineno-0-1805"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-1806" name="__codelineno-0-1806"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1807" name="__codelineno-0-1807"></a><span class="sd">    This class diretly prompt LLM for frame extraction.</span>
<a id="__codelineno-0-1808" name="__codelineno-0-1808"></a><span class="sd">    Input system prompt (optional), prompt template (with instruction, few-shot examples), </span>
<a id="__codelineno-0-1809" name="__codelineno-0-1809"></a><span class="sd">    and specify a LLM.</span>
<a id="__codelineno-0-1810" name="__codelineno-0-1810"></a>
<a id="__codelineno-0-1811" name="__codelineno-0-1811"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1812" name="__codelineno-0-1812"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1813" name="__codelineno-0-1813"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-1814" name="__codelineno-0-1814"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-1815" name="__codelineno-0-1815"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-1816" name="__codelineno-0-1816"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-1817" name="__codelineno-0-1817"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-1818" name="__codelineno-0-1818"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-1819" name="__codelineno-0-1819"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1820" name="__codelineno-0-1820"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span> 
<a id="__codelineno-0-1821" name="__codelineno-0-1821"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">WholeDocumentUnitChunker</span><span class="p">(),</span>
<a id="__codelineno-0-1822" name="__codelineno-0-1822"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> 
<a id="__codelineno-0-1823" name="__codelineno-0-1823"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1824" name="__codelineno-0-1824"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">NoContextChunker</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.SentenceFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.SentenceFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">SentenceFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">context_sentences</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llm_ie.extractors.DirectFrameExtractor" href="#llm_ie.extractors.DirectFrameExtractor">DirectFrameExtractor</a></code></p>


        <p>This class performs sentence-by-sentence information extraction.
The process is as follows:
    1. system prompt (optional)
    2. user prompt with instructions (schema, background, full text, few-shot example...)
    3. feed a sentence (start with first sentence)
    4. LLM extract entities and attributes from the sentence
    5. iterate to the next sentence and repeat steps 3-4 until all sentences are processed.</p>
<p>Input system prompt (optional), prompt template (with user instructions), 
and specify a LLM.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
system_prompt : str, Optional
    system prompt.
context_sentences : Union[str, int], Optional
    number of sentences before and after the given sentence to provide additional context. 
    if "all", the full text will be provided in the prompt as context. 
    if 0, no additional context will be provided.
        This is good for tasks that does not require context beyond the given sentence. 
    if &gt; 0, the number of sentences before and after the given sentence to provide as context.
        This is good for tasks that require context beyond the given sentence.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1860">1860</a></span>
<span class="normal"><a href="#__codelineno-0-1861">1861</a></span>
<span class="normal"><a href="#__codelineno-0-1862">1862</a></span>
<span class="normal"><a href="#__codelineno-0-1863">1863</a></span>
<span class="normal"><a href="#__codelineno-0-1864">1864</a></span>
<span class="normal"><a href="#__codelineno-0-1865">1865</a></span>
<span class="normal"><a href="#__codelineno-0-1866">1866</a></span>
<span class="normal"><a href="#__codelineno-0-1867">1867</a></span>
<span class="normal"><a href="#__codelineno-0-1868">1868</a></span>
<span class="normal"><a href="#__codelineno-0-1869">1869</a></span>
<span class="normal"><a href="#__codelineno-0-1870">1870</a></span>
<span class="normal"><a href="#__codelineno-0-1871">1871</a></span>
<span class="normal"><a href="#__codelineno-0-1872">1872</a></span>
<span class="normal"><a href="#__codelineno-0-1873">1873</a></span>
<span class="normal"><a href="#__codelineno-0-1874">1874</a></span>
<span class="normal"><a href="#__codelineno-0-1875">1875</a></span>
<span class="normal"><a href="#__codelineno-0-1876">1876</a></span>
<span class="normal"><a href="#__codelineno-0-1877">1877</a></span>
<span class="normal"><a href="#__codelineno-0-1878">1878</a></span>
<span class="normal"><a href="#__codelineno-0-1879">1879</a></span>
<span class="normal"><a href="#__codelineno-0-1880">1880</a></span>
<span class="normal"><a href="#__codelineno-0-1881">1881</a></span>
<span class="normal"><a href="#__codelineno-0-1882">1882</a></span>
<span class="normal"><a href="#__codelineno-0-1883">1883</a></span>
<span class="normal"><a href="#__codelineno-0-1884">1884</a></span>
<span class="normal"><a href="#__codelineno-0-1885">1885</a></span>
<span class="normal"><a href="#__codelineno-0-1886">1886</a></span>
<span class="normal"><a href="#__codelineno-0-1887">1887</a></span>
<span class="normal"><a href="#__codelineno-0-1888">1888</a></span>
<span class="normal"><a href="#__codelineno-0-1889">1889</a></span>
<span class="normal"><a href="#__codelineno-0-1890">1890</a></span>
<span class="normal"><a href="#__codelineno-0-1891">1891</a></span>
<span class="normal"><a href="#__codelineno-0-1892">1892</a></span>
<span class="normal"><a href="#__codelineno-0-1893">1893</a></span>
<span class="normal"><a href="#__codelineno-0-1894">1894</a></span>
<span class="normal"><a href="#__codelineno-0-1895">1895</a></span>
<span class="normal"><a href="#__codelineno-0-1896">1896</a></span>
<span class="normal"><a href="#__codelineno-0-1897">1897</a></span>
<span class="normal"><a href="#__codelineno-0-1898">1898</a></span>
<span class="normal"><a href="#__codelineno-0-1899">1899</a></span>
<span class="normal"><a href="#__codelineno-0-1900">1900</a></span>
<span class="normal"><a href="#__codelineno-0-1901">1901</a></span>
<span class="normal"><a href="#__codelineno-0-1902">1902</a></span>
<span class="normal"><a href="#__codelineno-0-1903">1903</a></span>
<span class="normal"><a href="#__codelineno-0-1904">1904</a></span>
<span class="normal"><a href="#__codelineno-0-1905">1905</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1860" name="__codelineno-0-1860"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1861" name="__codelineno-0-1861"></a>             <span class="n">context_sentences</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1862" name="__codelineno-0-1862"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1863" name="__codelineno-0-1863"></a><span class="sd">    This class performs sentence-by-sentence information extraction.</span>
<a id="__codelineno-0-1864" name="__codelineno-0-1864"></a><span class="sd">    The process is as follows:</span>
<a id="__codelineno-0-1865" name="__codelineno-0-1865"></a><span class="sd">        1. system prompt (optional)</span>
<a id="__codelineno-0-1866" name="__codelineno-0-1866"></a><span class="sd">        2. user prompt with instructions (schema, background, full text, few-shot example...)</span>
<a id="__codelineno-0-1867" name="__codelineno-0-1867"></a><span class="sd">        3. feed a sentence (start with first sentence)</span>
<a id="__codelineno-0-1868" name="__codelineno-0-1868"></a><span class="sd">        4. LLM extract entities and attributes from the sentence</span>
<a id="__codelineno-0-1869" name="__codelineno-0-1869"></a><span class="sd">        5. iterate to the next sentence and repeat steps 3-4 until all sentences are processed.</span>
<a id="__codelineno-0-1870" name="__codelineno-0-1870"></a>
<a id="__codelineno-0-1871" name="__codelineno-0-1871"></a><span class="sd">    Input system prompt (optional), prompt template (with user instructions), </span>
<a id="__codelineno-0-1872" name="__codelineno-0-1872"></a><span class="sd">    and specify a LLM.</span>
<a id="__codelineno-0-1873" name="__codelineno-0-1873"></a>
<a id="__codelineno-0-1874" name="__codelineno-0-1874"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1875" name="__codelineno-0-1875"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1876" name="__codelineno-0-1876"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-1877" name="__codelineno-0-1877"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-1878" name="__codelineno-0-1878"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-1879" name="__codelineno-0-1879"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-1880" name="__codelineno-0-1880"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-1881" name="__codelineno-0-1881"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-1882" name="__codelineno-0-1882"></a><span class="sd">    context_sentences : Union[str, int], Optional</span>
<a id="__codelineno-0-1883" name="__codelineno-0-1883"></a><span class="sd">        number of sentences before and after the given sentence to provide additional context. </span>
<a id="__codelineno-0-1884" name="__codelineno-0-1884"></a><span class="sd">        if &quot;all&quot;, the full text will be provided in the prompt as context. </span>
<a id="__codelineno-0-1885" name="__codelineno-0-1885"></a><span class="sd">        if 0, no additional context will be provided.</span>
<a id="__codelineno-0-1886" name="__codelineno-0-1886"></a><span class="sd">            This is good for tasks that does not require context beyond the given sentence. </span>
<a id="__codelineno-0-1887" name="__codelineno-0-1887"></a><span class="sd">        if &gt; 0, the number of sentences before and after the given sentence to provide as context.</span>
<a id="__codelineno-0-1888" name="__codelineno-0-1888"></a><span class="sd">            This is good for tasks that require context beyond the given sentence. </span>
<a id="__codelineno-0-1889" name="__codelineno-0-1889"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1890" name="__codelineno-0-1890"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sentences</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1891" name="__codelineno-0-1891"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;context_sentences must be an integer (&gt;= 0) or &quot;all&quot;.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1892" name="__codelineno-0-1892"></a>
<a id="__codelineno-0-1893" name="__codelineno-0-1893"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sentences</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1894" name="__codelineno-0-1894"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;context_sentences must be a positive integer.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1895" name="__codelineno-0-1895"></a>
<a id="__codelineno-0-1896" name="__codelineno-0-1896"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-1897" name="__codelineno-0-1897"></a>        <span class="n">context_chunker</span> <span class="o">=</span> <span class="n">SlideWindowContextChunker</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="n">context_sentences</span><span class="p">)</span>
<a id="__codelineno-0-1898" name="__codelineno-0-1898"></a>    <span class="k">elif</span> <span class="n">context_sentences</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1899" name="__codelineno-0-1899"></a>        <span class="n">context_chunker</span> <span class="o">=</span> <span class="n">WholeDocumentContextChunker</span><span class="p">()</span>
<a id="__codelineno-0-1900" name="__codelineno-0-1900"></a>
<a id="__codelineno-0-1901" name="__codelineno-0-1901"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span> 
<a id="__codelineno-0-1902" name="__codelineno-0-1902"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">SentenceUnitChunker</span><span class="p">(),</span>
<a id="__codelineno-0-1903" name="__codelineno-0-1903"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> 
<a id="__codelineno-0-1904" name="__codelineno-0-1904"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1905" name="__codelineno-0-1905"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">context_chunker</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.BasicReviewFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.BasicReviewFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">BasicReviewFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">review_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">review_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llm_ie.extractors.ReviewFrameExtractor" href="#llm_ie.extractors.ReviewFrameExtractor">ReviewFrameExtractor</a></code></p>


        <p>This class add a review step after the BasicFrameExtractor.
The Review process asks LLM to review its output and:
    1. add more frames while keep current. This is efficient for boosting recall. 
    2. or, regenerate frames (add new and delete existing). 
Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
review_prompt : str: Optional
    the prompt text that ask LLM to review. Specify addition or revision in the instruction.
    if not provided, a default review prompt will be used. 
review_mode : str
    review mode. Must be one of {"addition", "revision"}
    addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.
system_prompt : str, Optional
    system prompt.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1827">1827</a></span>
<span class="normal"><a href="#__codelineno-0-1828">1828</a></span>
<span class="normal"><a href="#__codelineno-0-1829">1829</a></span>
<span class="normal"><a href="#__codelineno-0-1830">1830</a></span>
<span class="normal"><a href="#__codelineno-0-1831">1831</a></span>
<span class="normal"><a href="#__codelineno-0-1832">1832</a></span>
<span class="normal"><a href="#__codelineno-0-1833">1833</a></span>
<span class="normal"><a href="#__codelineno-0-1834">1834</a></span>
<span class="normal"><a href="#__codelineno-0-1835">1835</a></span>
<span class="normal"><a href="#__codelineno-0-1836">1836</a></span>
<span class="normal"><a href="#__codelineno-0-1837">1837</a></span>
<span class="normal"><a href="#__codelineno-0-1838">1838</a></span>
<span class="normal"><a href="#__codelineno-0-1839">1839</a></span>
<span class="normal"><a href="#__codelineno-0-1840">1840</a></span>
<span class="normal"><a href="#__codelineno-0-1841">1841</a></span>
<span class="normal"><a href="#__codelineno-0-1842">1842</a></span>
<span class="normal"><a href="#__codelineno-0-1843">1843</a></span>
<span class="normal"><a href="#__codelineno-0-1844">1844</a></span>
<span class="normal"><a href="#__codelineno-0-1845">1845</a></span>
<span class="normal"><a href="#__codelineno-0-1846">1846</a></span>
<span class="normal"><a href="#__codelineno-0-1847">1847</a></span>
<span class="normal"><a href="#__codelineno-0-1848">1848</a></span>
<span class="normal"><a href="#__codelineno-0-1849">1849</a></span>
<span class="normal"><a href="#__codelineno-0-1850">1850</a></span>
<span class="normal"><a href="#__codelineno-0-1851">1851</a></span>
<span class="normal"><a href="#__codelineno-0-1852">1852</a></span>
<span class="normal"><a href="#__codelineno-0-1853">1853</a></span>
<span class="normal"><a href="#__codelineno-0-1854">1854</a></span>
<span class="normal"><a href="#__codelineno-0-1855">1855</a></span>
<span class="normal"><a href="#__codelineno-0-1856">1856</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1827" name="__codelineno-0-1827"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">review_mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">review_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-1828" name="__codelineno-0-1828"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1829" name="__codelineno-0-1829"></a><span class="sd">    This class add a review step after the BasicFrameExtractor.</span>
<a id="__codelineno-0-1830" name="__codelineno-0-1830"></a><span class="sd">    The Review process asks LLM to review its output and:</span>
<a id="__codelineno-0-1831" name="__codelineno-0-1831"></a><span class="sd">        1. add more frames while keep current. This is efficient for boosting recall. </span>
<a id="__codelineno-0-1832" name="__codelineno-0-1832"></a><span class="sd">        2. or, regenerate frames (add new and delete existing). </span>
<a id="__codelineno-0-1833" name="__codelineno-0-1833"></a><span class="sd">    Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</span>
<a id="__codelineno-0-1834" name="__codelineno-0-1834"></a>
<a id="__codelineno-0-1835" name="__codelineno-0-1835"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1836" name="__codelineno-0-1836"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1837" name="__codelineno-0-1837"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-1838" name="__codelineno-0-1838"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-1839" name="__codelineno-0-1839"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-1840" name="__codelineno-0-1840"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-1841" name="__codelineno-0-1841"></a><span class="sd">    review_prompt : str: Optional</span>
<a id="__codelineno-0-1842" name="__codelineno-0-1842"></a><span class="sd">        the prompt text that ask LLM to review. Specify addition or revision in the instruction.</span>
<a id="__codelineno-0-1843" name="__codelineno-0-1843"></a><span class="sd">        if not provided, a default review prompt will be used. </span>
<a id="__codelineno-0-1844" name="__codelineno-0-1844"></a><span class="sd">    review_mode : str</span>
<a id="__codelineno-0-1845" name="__codelineno-0-1845"></a><span class="sd">        review mode. Must be one of {&quot;addition&quot;, &quot;revision&quot;}</span>
<a id="__codelineno-0-1846" name="__codelineno-0-1846"></a><span class="sd">        addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.</span>
<a id="__codelineno-0-1847" name="__codelineno-0-1847"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-1848" name="__codelineno-0-1848"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-1849" name="__codelineno-0-1849"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1850" name="__codelineno-0-1850"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span> 
<a id="__codelineno-0-1851" name="__codelineno-0-1851"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">WholeDocumentUnitChunker</span><span class="p">(),</span>
<a id="__codelineno-0-1852" name="__codelineno-0-1852"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span> 
<a id="__codelineno-0-1853" name="__codelineno-0-1853"></a>                     <span class="n">review_mode</span><span class="o">=</span><span class="n">review_mode</span><span class="p">,</span>
<a id="__codelineno-0-1854" name="__codelineno-0-1854"></a>                     <span class="n">review_prompt</span><span class="o">=</span><span class="n">review_prompt</span><span class="p">,</span>
<a id="__codelineno-0-1855" name="__codelineno-0-1855"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1856" name="__codelineno-0-1856"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">NoContextChunker</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.SentenceReviewFrameExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.SentenceReviewFrameExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">SentenceReviewFrameExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">review_mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">review_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>    <span class="n">context_sentences</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="llm_ie.extractors.ReviewFrameExtractor" href="#llm_ie.extractors.ReviewFrameExtractor">ReviewFrameExtractor</a></code></p>


        <p>This class adds a review step after the SentenceFrameExtractor.
For each sentence, the review process asks LLM to review its output and:
    1. add more frames while keeping current. This is efficient for boosting recall. 
    2. or, regenerate frames (add new and delete existing). 
Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</p>


<details class="parameters:" open>
  <summary>Parameters:</summary>
  <p>inference_engine : InferenceEngine
    the LLM inferencing engine object. Must implements the chat() method.
prompt_template : str
    prompt template with "{{<placeholder name>}}" placeholder.
review_prompt : str: Optional
    the prompt text that ask LLM to review. Specify addition or revision in the instruction.
    if not provided, a default review prompt will be used. 
review_mode : str
    review mode. Must be one of {"addition", "revision"}
    addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.
system_prompt : str, Optional
    system prompt.
context_sentences : Union[str, int], Optional
    number of sentences before and after the given sentence to provide additional context. 
    if "all", the full text will be provided in the prompt as context. 
    if 0, no additional context will be provided.
        This is good for tasks that does not require context beyond the given sentence. 
    if &gt; 0, the number of sentences before and after the given sentence to provide as context.
        This is good for tasks that require context beyond the given sentence.</p>
</details>






                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1909">1909</a></span>
<span class="normal"><a href="#__codelineno-0-1910">1910</a></span>
<span class="normal"><a href="#__codelineno-0-1911">1911</a></span>
<span class="normal"><a href="#__codelineno-0-1912">1912</a></span>
<span class="normal"><a href="#__codelineno-0-1913">1913</a></span>
<span class="normal"><a href="#__codelineno-0-1914">1914</a></span>
<span class="normal"><a href="#__codelineno-0-1915">1915</a></span>
<span class="normal"><a href="#__codelineno-0-1916">1916</a></span>
<span class="normal"><a href="#__codelineno-0-1917">1917</a></span>
<span class="normal"><a href="#__codelineno-0-1918">1918</a></span>
<span class="normal"><a href="#__codelineno-0-1919">1919</a></span>
<span class="normal"><a href="#__codelineno-0-1920">1920</a></span>
<span class="normal"><a href="#__codelineno-0-1921">1921</a></span>
<span class="normal"><a href="#__codelineno-0-1922">1922</a></span>
<span class="normal"><a href="#__codelineno-0-1923">1923</a></span>
<span class="normal"><a href="#__codelineno-0-1924">1924</a></span>
<span class="normal"><a href="#__codelineno-0-1925">1925</a></span>
<span class="normal"><a href="#__codelineno-0-1926">1926</a></span>
<span class="normal"><a href="#__codelineno-0-1927">1927</a></span>
<span class="normal"><a href="#__codelineno-0-1928">1928</a></span>
<span class="normal"><a href="#__codelineno-0-1929">1929</a></span>
<span class="normal"><a href="#__codelineno-0-1930">1930</a></span>
<span class="normal"><a href="#__codelineno-0-1931">1931</a></span>
<span class="normal"><a href="#__codelineno-0-1932">1932</a></span>
<span class="normal"><a href="#__codelineno-0-1933">1933</a></span>
<span class="normal"><a href="#__codelineno-0-1934">1934</a></span>
<span class="normal"><a href="#__codelineno-0-1935">1935</a></span>
<span class="normal"><a href="#__codelineno-0-1936">1936</a></span>
<span class="normal"><a href="#__codelineno-0-1937">1937</a></span>
<span class="normal"><a href="#__codelineno-0-1938">1938</a></span>
<span class="normal"><a href="#__codelineno-0-1939">1939</a></span>
<span class="normal"><a href="#__codelineno-0-1940">1940</a></span>
<span class="normal"><a href="#__codelineno-0-1941">1941</a></span>
<span class="normal"><a href="#__codelineno-0-1942">1942</a></span>
<span class="normal"><a href="#__codelineno-0-1943">1943</a></span>
<span class="normal"><a href="#__codelineno-0-1944">1944</a></span>
<span class="normal"><a href="#__codelineno-0-1945">1945</a></span>
<span class="normal"><a href="#__codelineno-0-1946">1946</a></span>
<span class="normal"><a href="#__codelineno-0-1947">1947</a></span>
<span class="normal"><a href="#__codelineno-0-1948">1948</a></span>
<span class="normal"><a href="#__codelineno-0-1949">1949</a></span>
<span class="normal"><a href="#__codelineno-0-1950">1950</a></span>
<span class="normal"><a href="#__codelineno-0-1951">1951</a></span>
<span class="normal"><a href="#__codelineno-0-1952">1952</a></span>
<span class="normal"><a href="#__codelineno-0-1953">1953</a></span>
<span class="normal"><a href="#__codelineno-0-1954">1954</a></span>
<span class="normal"><a href="#__codelineno-0-1955">1955</a></span>
<span class="normal"><a href="#__codelineno-0-1956">1956</a></span>
<span class="normal"><a href="#__codelineno-0-1957">1957</a></span>
<span class="normal"><a href="#__codelineno-0-1958">1958</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1909" name="__codelineno-0-1909"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>  
<a id="__codelineno-0-1910" name="__codelineno-0-1910"></a>             <span class="n">review_mode</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">review_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-1911" name="__codelineno-0-1911"></a>             <span class="n">context_sentences</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<a id="__codelineno-0-1912" name="__codelineno-0-1912"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-1913" name="__codelineno-0-1913"></a><span class="sd">    This class adds a review step after the SentenceFrameExtractor.</span>
<a id="__codelineno-0-1914" name="__codelineno-0-1914"></a><span class="sd">    For each sentence, the review process asks LLM to review its output and:</span>
<a id="__codelineno-0-1915" name="__codelineno-0-1915"></a><span class="sd">        1. add more frames while keeping current. This is efficient for boosting recall. </span>
<a id="__codelineno-0-1916" name="__codelineno-0-1916"></a><span class="sd">        2. or, regenerate frames (add new and delete existing). </span>
<a id="__codelineno-0-1917" name="__codelineno-0-1917"></a><span class="sd">    Use the review_mode parameter to specify. Note that the review_prompt should instruct LLM accordingly.</span>
<a id="__codelineno-0-1918" name="__codelineno-0-1918"></a>
<a id="__codelineno-0-1919" name="__codelineno-0-1919"></a><span class="sd">    Parameters:</span>
<a id="__codelineno-0-1920" name="__codelineno-0-1920"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-1921" name="__codelineno-0-1921"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-1922" name="__codelineno-0-1922"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-1923" name="__codelineno-0-1923"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-1924" name="__codelineno-0-1924"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-1925" name="__codelineno-0-1925"></a><span class="sd">    review_prompt : str: Optional</span>
<a id="__codelineno-0-1926" name="__codelineno-0-1926"></a><span class="sd">        the prompt text that ask LLM to review. Specify addition or revision in the instruction.</span>
<a id="__codelineno-0-1927" name="__codelineno-0-1927"></a><span class="sd">        if not provided, a default review prompt will be used. </span>
<a id="__codelineno-0-1928" name="__codelineno-0-1928"></a><span class="sd">    review_mode : str</span>
<a id="__codelineno-0-1929" name="__codelineno-0-1929"></a><span class="sd">        review mode. Must be one of {&quot;addition&quot;, &quot;revision&quot;}</span>
<a id="__codelineno-0-1930" name="__codelineno-0-1930"></a><span class="sd">        addition mode only ask LLM to add new frames, while revision mode ask LLM to regenerate.</span>
<a id="__codelineno-0-1931" name="__codelineno-0-1931"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-1932" name="__codelineno-0-1932"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-1933" name="__codelineno-0-1933"></a><span class="sd">    context_sentences : Union[str, int], Optional</span>
<a id="__codelineno-0-1934" name="__codelineno-0-1934"></a><span class="sd">        number of sentences before and after the given sentence to provide additional context. </span>
<a id="__codelineno-0-1935" name="__codelineno-0-1935"></a><span class="sd">        if &quot;all&quot;, the full text will be provided in the prompt as context. </span>
<a id="__codelineno-0-1936" name="__codelineno-0-1936"></a><span class="sd">        if 0, no additional context will be provided.</span>
<a id="__codelineno-0-1937" name="__codelineno-0-1937"></a><span class="sd">            This is good for tasks that does not require context beyond the given sentence. </span>
<a id="__codelineno-0-1938" name="__codelineno-0-1938"></a><span class="sd">        if &gt; 0, the number of sentences before and after the given sentence to provide as context.</span>
<a id="__codelineno-0-1939" name="__codelineno-0-1939"></a><span class="sd">            This is good for tasks that require context beyond the given sentence. </span>
<a id="__codelineno-0-1940" name="__codelineno-0-1940"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-1941" name="__codelineno-0-1941"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sentences</span> <span class="o">!=</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1942" name="__codelineno-0-1942"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;context_sentences must be an integer (&gt;= 0) or &quot;all&quot;.&#39;</span><span class="p">)</span>
<a id="__codelineno-0-1943" name="__codelineno-0-1943"></a>
<a id="__codelineno-0-1944" name="__codelineno-0-1944"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context_sentences</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-1945" name="__codelineno-0-1945"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;context_sentences must be a positive integer.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-1946" name="__codelineno-0-1946"></a>
<a id="__codelineno-0-1947" name="__codelineno-0-1947"></a>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">context_sentences</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-1948" name="__codelineno-0-1948"></a>        <span class="n">context_chunker</span> <span class="o">=</span> <span class="n">SlideWindowContextChunker</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="n">context_sentences</span><span class="p">)</span>
<a id="__codelineno-0-1949" name="__codelineno-0-1949"></a>    <span class="k">elif</span> <span class="n">context_sentences</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
<a id="__codelineno-0-1950" name="__codelineno-0-1950"></a>        <span class="n">context_chunker</span> <span class="o">=</span> <span class="n">WholeDocumentContextChunker</span><span class="p">()</span>
<a id="__codelineno-0-1951" name="__codelineno-0-1951"></a>
<a id="__codelineno-0-1952" name="__codelineno-0-1952"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span> 
<a id="__codelineno-0-1953" name="__codelineno-0-1953"></a>                     <span class="n">unit_chunker</span><span class="o">=</span><span class="n">SentenceUnitChunker</span><span class="p">(),</span>
<a id="__codelineno-0-1954" name="__codelineno-0-1954"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
<a id="__codelineno-0-1955" name="__codelineno-0-1955"></a>                     <span class="n">review_mode</span><span class="o">=</span><span class="n">review_mode</span><span class="p">,</span>
<a id="__codelineno-0-1956" name="__codelineno-0-1956"></a>                     <span class="n">review_prompt</span><span class="o">=</span><span class="n">review_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1957" name="__codelineno-0-1957"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">,</span> 
<a id="__codelineno-0-1958" name="__codelineno-0-1958"></a>                     <span class="n">context_chunker</span><span class="o">=</span><span class="n">context_chunker</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div><h2 id="relation-extractors">Relation Extractors</h2>


<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.BinaryRelationExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.BinaryRelationExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">BinaryRelationExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">possible_relation_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="llm_ie.extractors.RelationExtractor">RelationExtractor</span></code></p>


        <p>This class extracts binary (yes/no) relations between two entities.
Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inference_engine</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llm_ie.engines.InferenceEngine" href="../llm_inference_engine/#llm_ie.engines.InferenceEngine">InferenceEngine</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the LLM inferencing engine object. Must implements the chat() method.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>prompt template with "{{<placeholder name>}}" placeholder.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>possible_relation_func</code>
            </td>
            <td>
                  <code>(<span title="typing.Callable">Callable</span>, <span title="typing.Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a function that inputs 2 frames and returns a bool indicating possible relations between them.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code>(<span title="str">str</span>, <span title="typing.Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>system prompt.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-2381">2381</a></span>
<span class="normal"><a href="#__codelineno-0-2382">2382</a></span>
<span class="normal"><a href="#__codelineno-0-2383">2383</a></span>
<span class="normal"><a href="#__codelineno-0-2384">2384</a></span>
<span class="normal"><a href="#__codelineno-0-2385">2385</a></span>
<span class="normal"><a href="#__codelineno-0-2386">2386</a></span>
<span class="normal"><a href="#__codelineno-0-2387">2387</a></span>
<span class="normal"><a href="#__codelineno-0-2388">2388</a></span>
<span class="normal"><a href="#__codelineno-0-2389">2389</a></span>
<span class="normal"><a href="#__codelineno-0-2390">2390</a></span>
<span class="normal"><a href="#__codelineno-0-2391">2391</a></span>
<span class="normal"><a href="#__codelineno-0-2392">2392</a></span>
<span class="normal"><a href="#__codelineno-0-2393">2393</a></span>
<span class="normal"><a href="#__codelineno-0-2394">2394</a></span>
<span class="normal"><a href="#__codelineno-0-2395">2395</a></span>
<span class="normal"><a href="#__codelineno-0-2396">2396</a></span>
<span class="normal"><a href="#__codelineno-0-2397">2397</a></span>
<span class="normal"><a href="#__codelineno-0-2398">2398</a></span>
<span class="normal"><a href="#__codelineno-0-2399">2399</a></span>
<span class="normal"><a href="#__codelineno-0-2400">2400</a></span>
<span class="normal"><a href="#__codelineno-0-2401">2401</a></span>
<span class="normal"><a href="#__codelineno-0-2402">2402</a></span>
<span class="normal"><a href="#__codelineno-0-2403">2403</a></span>
<span class="normal"><a href="#__codelineno-0-2404">2404</a></span>
<span class="normal"><a href="#__codelineno-0-2405">2405</a></span>
<span class="normal"><a href="#__codelineno-0-2406">2406</a></span>
<span class="normal"><a href="#__codelineno-0-2407">2407</a></span>
<span class="normal"><a href="#__codelineno-0-2408">2408</a></span>
<span class="normal"><a href="#__codelineno-0-2409">2409</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-2381" name="__codelineno-0-2381"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">possible_relation_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-2382" name="__codelineno-0-2382"></a>             <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2383" name="__codelineno-0-2383"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-2384" name="__codelineno-0-2384"></a><span class="sd">    This class extracts binary (yes/no) relations between two entities.</span>
<a id="__codelineno-0-2385" name="__codelineno-0-2385"></a><span class="sd">    Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</span>
<a id="__codelineno-0-2386" name="__codelineno-0-2386"></a>
<a id="__codelineno-0-2387" name="__codelineno-0-2387"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-2388" name="__codelineno-0-2388"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-2389" name="__codelineno-0-2389"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-2390" name="__codelineno-0-2390"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-2391" name="__codelineno-0-2391"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-2392" name="__codelineno-0-2392"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-2393" name="__codelineno-0-2393"></a><span class="sd">    possible_relation_func : Callable, Optional</span>
<a id="__codelineno-0-2394" name="__codelineno-0-2394"></a><span class="sd">        a function that inputs 2 frames and returns a bool indicating possible relations between them.</span>
<a id="__codelineno-0-2395" name="__codelineno-0-2395"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-2396" name="__codelineno-0-2396"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-2397" name="__codelineno-0-2397"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2398" name="__codelineno-0-2398"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">,</span> <span class="n">system_prompt</span><span class="p">)</span>
<a id="__codelineno-0-2399" name="__codelineno-0-2399"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">possible_relation_func</span><span class="p">):</span>
<a id="__codelineno-0-2400" name="__codelineno-0-2400"></a>        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect possible_relation_func as a function, received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">possible_relation_func</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2401" name="__codelineno-0-2401"></a>
<a id="__codelineno-0-2402" name="__codelineno-0-2402"></a>    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">possible_relation_func</span><span class="p">)</span>
<a id="__codelineno-0-2403" name="__codelineno-0-2403"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-2404" name="__codelineno-0-2404"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The possible_relation_func must have exactly two parameters.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2405" name="__codelineno-0-2405"></a>
<a id="__codelineno-0-2406" name="__codelineno-0-2406"></a>    <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="nb">bool</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="o">.</span><span class="n">empty</span><span class="p">}:</span>
<a id="__codelineno-0-2407" name="__codelineno-0-2407"></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected possible_relation_func return annotation to be bool, but got </span><span class="si">{</span><span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2408" name="__codelineno-0-2408"></a>
<a id="__codelineno-0-2409" name="__codelineno-0-2409"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">possible_relation_func</span> <span class="o">=</span> <span class="n">possible_relation_func</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_ie.extractors.MultiClassRelationExtractor" class="doc doc-heading">
            <span class="doc doc-object-name doc-class-name">llm_ie.extractors.MultiClassRelationExtractor</span>


</h2>
<div class="doc-signature highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nf">MultiClassRelationExtractor</span><span class="p">(</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    <span class="n">inference_engine</span><span class="p">:</span> <span class="n">InferenceEngine</span><span class="p">,</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    <span class="n">prompt_template</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>    <span class="n">possible_relation_types_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>    <span class="n">system_prompt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="p">)</span>
</code></pre></div>

    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="llm_ie.extractors.RelationExtractor">RelationExtractor</span></code></p>


        <p>This class extracts relations with relation types.
Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>inference_engine</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="llm_ie.engines.InferenceEngine" href="../llm_inference_engine/#llm_ie.engines.InferenceEngine">InferenceEngine</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the LLM inferencing engine object. Must implements the chat() method.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>prompt_template</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>prompt template with "{{<placeholder name>}}" placeholder.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>possible_relation_types_func</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a function that inputs 2 frames and returns a List of possible relation types between them. 
If the two frames must not have relations, this function should return an empty list [].</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>system_prompt</code>
            </td>
            <td>
                  <code>(<span title="str">str</span>, <span title="typing.Optional">Optional</span>)</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>system prompt.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>







                  <details class="quote">
                    <summary>Source code in <code>package/llm-ie/src/llm_ie/extractors.py</code></summary>
                    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-2435">2435</a></span>
<span class="normal"><a href="#__codelineno-0-2436">2436</a></span>
<span class="normal"><a href="#__codelineno-0-2437">2437</a></span>
<span class="normal"><a href="#__codelineno-0-2438">2438</a></span>
<span class="normal"><a href="#__codelineno-0-2439">2439</a></span>
<span class="normal"><a href="#__codelineno-0-2440">2440</a></span>
<span class="normal"><a href="#__codelineno-0-2441">2441</a></span>
<span class="normal"><a href="#__codelineno-0-2442">2442</a></span>
<span class="normal"><a href="#__codelineno-0-2443">2443</a></span>
<span class="normal"><a href="#__codelineno-0-2444">2444</a></span>
<span class="normal"><a href="#__codelineno-0-2445">2445</a></span>
<span class="normal"><a href="#__codelineno-0-2446">2446</a></span>
<span class="normal"><a href="#__codelineno-0-2447">2447</a></span>
<span class="normal"><a href="#__codelineno-0-2448">2448</a></span>
<span class="normal"><a href="#__codelineno-0-2449">2449</a></span>
<span class="normal"><a href="#__codelineno-0-2450">2450</a></span>
<span class="normal"><a href="#__codelineno-0-2451">2451</a></span>
<span class="normal"><a href="#__codelineno-0-2452">2452</a></span>
<span class="normal"><a href="#__codelineno-0-2453">2453</a></span>
<span class="normal"><a href="#__codelineno-0-2454">2454</a></span>
<span class="normal"><a href="#__codelineno-0-2455">2455</a></span>
<span class="normal"><a href="#__codelineno-0-2456">2456</a></span>
<span class="normal"><a href="#__codelineno-0-2457">2457</a></span>
<span class="normal"><a href="#__codelineno-0-2458">2458</a></span>
<span class="normal"><a href="#__codelineno-0-2459">2459</a></span>
<span class="normal"><a href="#__codelineno-0-2460">2460</a></span>
<span class="normal"><a href="#__codelineno-0-2461">2461</a></span>
<span class="normal"><a href="#__codelineno-0-2462">2462</a></span>
<span class="normal"><a href="#__codelineno-0-2463">2463</a></span>
<span class="normal"><a href="#__codelineno-0-2464">2464</a></span>
<span class="normal"><a href="#__codelineno-0-2465">2465</a></span>
<span class="normal"><a href="#__codelineno-0-2466">2466</a></span>
<span class="normal"><a href="#__codelineno-0-2467">2467</a></span>
<span class="normal"><a href="#__codelineno-0-2468">2468</a></span>
<span class="normal"><a href="#__codelineno-0-2469">2469</a></span>
<span class="normal"><a href="#__codelineno-0-2470">2470</a></span>
<span class="normal"><a href="#__codelineno-0-2471">2471</a></span>
<span class="normal"><a href="#__codelineno-0-2472">2472</a></span>
<span class="normal"><a href="#__codelineno-0-2473">2473</a></span>
<span class="normal"><a href="#__codelineno-0-2474">2474</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-2435" name="__codelineno-0-2435"></a><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inference_engine</span><span class="p">:</span><span class="n">InferenceEngine</span><span class="p">,</span> <span class="n">prompt_template</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">possible_relation_types_func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> 
<a id="__codelineno-0-2436" name="__codelineno-0-2436"></a>             <span class="n">system_prompt</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-2437" name="__codelineno-0-2437"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-2438" name="__codelineno-0-2438"></a><span class="sd">    This class extracts relations with relation types.</span>
<a id="__codelineno-0-2439" name="__codelineno-0-2439"></a><span class="sd">    Input LLM inference engine, system prompt (optional), prompt template (with instruction, few-shot examples).</span>
<a id="__codelineno-0-2440" name="__codelineno-0-2440"></a>
<a id="__codelineno-0-2441" name="__codelineno-0-2441"></a><span class="sd">    Parameters</span>
<a id="__codelineno-0-2442" name="__codelineno-0-2442"></a><span class="sd">    ----------</span>
<a id="__codelineno-0-2443" name="__codelineno-0-2443"></a><span class="sd">    inference_engine : InferenceEngine</span>
<a id="__codelineno-0-2444" name="__codelineno-0-2444"></a><span class="sd">        the LLM inferencing engine object. Must implements the chat() method.</span>
<a id="__codelineno-0-2445" name="__codelineno-0-2445"></a><span class="sd">    prompt_template : str</span>
<a id="__codelineno-0-2446" name="__codelineno-0-2446"></a><span class="sd">        prompt template with &quot;{{&lt;placeholder name&gt;}}&quot; placeholder.</span>
<a id="__codelineno-0-2447" name="__codelineno-0-2447"></a><span class="sd">    possible_relation_types_func : Callable</span>
<a id="__codelineno-0-2448" name="__codelineno-0-2448"></a><span class="sd">        a function that inputs 2 frames and returns a List of possible relation types between them. </span>
<a id="__codelineno-0-2449" name="__codelineno-0-2449"></a><span class="sd">        If the two frames must not have relations, this function should return an empty list [].</span>
<a id="__codelineno-0-2450" name="__codelineno-0-2450"></a><span class="sd">    system_prompt : str, Optional</span>
<a id="__codelineno-0-2451" name="__codelineno-0-2451"></a><span class="sd">        system prompt.</span>
<a id="__codelineno-0-2452" name="__codelineno-0-2452"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-2453" name="__codelineno-0-2453"></a>    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inference_engine</span><span class="o">=</span><span class="n">inference_engine</span><span class="p">,</span>
<a id="__codelineno-0-2454" name="__codelineno-0-2454"></a>                     <span class="n">prompt_template</span><span class="o">=</span><span class="n">prompt_template</span><span class="p">,</span>
<a id="__codelineno-0-2455" name="__codelineno-0-2455"></a>                     <span class="n">system_prompt</span><span class="o">=</span><span class="n">system_prompt</span><span class="p">)</span>
<a id="__codelineno-0-2456" name="__codelineno-0-2456"></a>
<a id="__codelineno-0-2457" name="__codelineno-0-2457"></a>    <span class="k">if</span> <span class="n">possible_relation_types_func</span><span class="p">:</span>
<a id="__codelineno-0-2458" name="__codelineno-0-2458"></a>        <span class="c1"># Check if possible_relation_types_func is a function</span>
<a id="__codelineno-0-2459" name="__codelineno-0-2459"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">possible_relation_types_func</span><span class="p">):</span>
<a id="__codelineno-0-2460" name="__codelineno-0-2460"></a>            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect possible_relation_types_func as a function, received </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">possible_relation_types_func</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2461" name="__codelineno-0-2461"></a>
<a id="__codelineno-0-2462" name="__codelineno-0-2462"></a>        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">possible_relation_types_func</span><span class="p">)</span>
<a id="__codelineno-0-2463" name="__codelineno-0-2463"></a>        <span class="c1"># Check if frame_1, frame_2 are in input parameters</span>
<a id="__codelineno-0-2464" name="__codelineno-0-2464"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
<a id="__codelineno-0-2465" name="__codelineno-0-2465"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The possible_relation_types_func must have exactly frame_1 and frame_2 as parameters.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2466" name="__codelineno-0-2466"></a>        <span class="k">if</span> <span class="s2">&quot;frame_1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-2467" name="__codelineno-0-2467"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The possible_relation_types_func is missing frame_1 as a parameter.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2468" name="__codelineno-0-2468"></a>        <span class="k">if</span> <span class="s2">&quot;frame_2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-0-2469" name="__codelineno-0-2469"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The possible_relation_types_func is missing frame_2 as a parameter.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2470" name="__codelineno-0-2470"></a>        <span class="c1"># Check if output is a List</span>
<a id="__codelineno-0-2471" name="__codelineno-0-2471"></a>        <span class="k">if</span> <span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]}:</span>
<a id="__codelineno-0-2472" name="__codelineno-0-2472"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expect possible_relation_types_func to output a List of string, current type hint suggests </span><span class="si">{</span><span class="n">sig</span><span class="o">.</span><span class="n">return_annotation</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2473" name="__codelineno-0-2473"></a>
<a id="__codelineno-0-2474" name="__codelineno-0-2474"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">possible_relation_types_func</span> <span class="o">=</span> <span class="n">possible_relation_types_func</span>
</code></pre></div></td></tr></table></div>
                  </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>